var net = require("net");
var _ = require("lodash");
var Promise = require("bluebird");
var bodyParser = require("body-parser");
var pathExists = require("path-exists");
var IO = require("socket.io");
var express = require("express");
var jwt = require("jsonwebtoken");
var moment = require("moment-timezone");
var couchjsonconf = require("couchjsonconf");
var machClients = require("./modules/machClients");
var audClients = require("./modules/audClients");
var socketioJwt = require("socketio-jwt");
var rpj = require("request-promise-json");
var aedes = require("aedes");
var app = express();
var server = require("http").Server(app);
var io = IO(server);
if (!pathExists.sync("./conf.json")) {
    throw Error("no configuration founded");
}
var conf = require("./conf.json");
var COUCHDB = new couchjsonconf(conf.couchdb);
var Machines = new machClients(COUCHDB);
var Auditors = new audClients();
app.use(bodyParser.urlencoded({ extended: false }));
app.use(bodyParser.json());
io.use(socketioJwt.authorize({
    secret: conf.secret,
    handshake: true
}));
server.listen(conf.port);
var Aedes = aedes();
var Aserver = net.createServer(Aedes.handle);
Aserver.listen(1883, function () {
    console.log("MQTT server listening on port", 1883);
});
Aedes.authenticate = function (client, username, token, callback) {
    if (conf.admin.username === username) {
        if (token === conf.admin.password) {
            callback(null, true);
        }
        else {
            console.log("unauthorized " + username);
            callback(null);
        }
    }
    else {
        try {
            var decoded = jwt.verify(JSON.parse(token + ""), conf.secret, { ignoreExpiration: true });
            var db = decoded.db;
            var password = decoded.password;
            console.log("auth");
            authcouch(username, password, db).then(function () {
                console.log("authorized " + username);
                client.serial = decoded.serial;
                client.couch = { username: username, password: password, db: db };
                callback(null, true);
            }).catch(function () {
                console.log("unauthorized " + username);
                callback(null);
            });
        }
        catch (err) {
            console.log("unauthorized " + username);
            callback(null);
        }
    }
};
Aedes.on("client", function (client) {
    console.log("new client" + client.id);
});
Aedes.on("clientDisconnect", function (client) {
    console.log("clientDisconnect");
});
Aedes.on("subscribe", function (topic, client) {
    console.log("subscribe");
});
Aedes.on("unsubscribe", function (topic, client) {
    console.log("unsubscribe");
});
Aedes.on("publish", function (packet, client) {
    if (!client)
        return;
    var obj = JSON.parse(packet.payload.toString());
    console.log("publish");
    if (obj.active && obj.uid === "1XG4hQXuspqo1N4Ehyrkdw") {
        console.log("offmode");
    }
    else {
        if (packet.topic.split("/").length > 1 && packet.topic.split("/")[0] == "data" && client.couch && client.couch && client.couch.username) {
            if (client.couch.db === "mach_pctt3v_energytrack" || client.couch.db === "mach_sxcm0q_energytrack") {
                obj.updatedAt = obj.updatedAt + 3600000;
                obj.date = moment.tz(obj.updatedAt, "Europe/Rome").format("YYYYMMDD-HH:mm:ss");
            }
            console.log("save");
            rpj.get("http://" + client.couch.username + ":" + client.couch.password + "@192.168.122.44:5984/" + client.couch.db + "/" + obj._id).then(function (d) {
                obj._rev = d._rev;
                rpj.put("http://" + client.couch.username + ":" + client.couch.password + "@192.168.122.44:5984/" + client.couch.db + "/" + obj._id, obj).then(function () {
                    console.log("backup");
                    rpj.get("http://" + client.couch.username + ":" + client.couch.password + "@192.168.122.44:5984/" + client.couch.db + "/hooks").then(function (data) {
                        try {
                            var hookurl = data[packet.topic.split("/")[0]];
                            console.log(hookurl);
                            if (data[packet.topic.split("/")[0]]) {
                                rpj.post(hookurl + "/" + client.serial + "/" + client.couch.db + "/" + client.couch.username + "/" + client.couch.password, { data: obj }).then(function (bro) {
                                    console.log("send to applicantion manager");
                                }).catch(function (err) {
                                    console.log(err);
                                });
                            }
                        }
                        catch (err) {
                            console.log(err);
                        }
                    }).catch(function (err) {
                        console.log(err);
                    });
                }).catch(function (err) {
                    console.log("save error " + err);
                });
            }).catch(function (err) {
                if (err.statusCode === 404) {
                    rpj.put("http://" + client.couch.username + ":" + client.couch.password + "@192.168.122.44:5984/" + client.couch.db + "/" + obj._id, obj).then(function () {
                        console.log("backup");
                        rpj.get("http://" + client.couch.username + ":" + client.couch.password + "@192.168.122.44:5984/" + client.couch.db + "/hooks").then(function (data) {
                            try {
                                var hookurl = data[packet.topic.split("/")[0]];
                                console.log(hookurl);
                                if (data[packet.topic.split("/")[0]]) {
                                    rpj.post(hookurl + "/" + client.serial + "/" + client.couch.db + "/" + client.couch.username + "/" + client.couch.password, { data: obj }).then(function (bro) {
                                        console.log("send to applicantion manager");
                                    }).catch(function (err) {
                                        console.log(err);
                                    });
                                }
                            }
                            catch (err) {
                                console.log(err);
                            }
                        }).catch(function (err) {
                            console.log(err);
                        });
                    }).catch(function (err) {
                        console.log("save error " + err);
                    });
                }
                else {
                    console.log(err);
                }
            });
        }
    }
});
app.get("/", function (req, res) {
    res.json({ online: true });
});
function authcouch(user, password, db) {
    return new Promise(function (resolve, reject) {
        rpj.get(COUCHDB.for(user, password, db)).then(function () {
            resolve({ success: true });
        }).catch(function (err) {
            reject({ error: "wrong credentials" });
        });
    });
}
function authorizesocket(profile) {
    return jwt.sign(profile, conf.secret, { expiresInMinutes: 60 * 5 });
}
app.post("/login", function (req, res) {
    authcouch(req.body.user, req.body.password, req.body.db).then(function () {
        var token = authorizesocket({ user: req.body.user, password: req.body.password, db: req.body.db, serial: req.body.serial });
        res.json({ success: true, token: token });
    }).catch(function (err) {
        res.json(err);
    });
});
app.get("/ip", function (req, res) {
    res.json({ ip: req.headers["x-forwarded-for"] });
});
app.get("/sockets", function (req, res) {
    res.json(Machines.sockets());
});
app.get("/machines/:serial/sockets", function (req, res) {
    res.json(Machines.sockets(req.params.serial));
});
app.get("/machines", function (req, res) {
    res.json(Machines.list());
});
app.get("/app/:app/machines", function (req, res) {
});
app.get("/machines/:serial/message/:message", function (req, res) {
    _.map(Machines.ios(req.params.serial), function (socket) {
        socket.emit("message", req.params.message);
    });
    res.json({});
});
app.post("/machines/:serial/message", function (req, res) {
    _.map(Machines.list(req.params.serial), function (socketid) {
        io.to(socketid).emit("message", req.body.data);
    });
});
app.post("/machines/:serial/data", function (req, res) {
    _.map(Machines.list(req.params.serial), function (socketid) {
        io.to(socketid).emit("data", req.body.data);
    });
});
app.post("/machines/:serial/exec", function (req, res) {
    _.map(Machines.list(req.params.serial), function (socketid) {
        io.to(socketid).emit("exec", req.body.data);
    });
});
app.post("/machines/:serial/npm", function (req, res) {
    _.map(Machines.list(req.params.serial), function (socketid) {
        io.to(socketid).emit("npm", req.body.data);
    });
});
app.post("/machines/:serial/task", function (req, res) {
    _.map(Machines.list(req.params.serial), function (socketid) {
        io.to(socketid).emit("task", req.body.data);
    });
});
io.on("connection", function (socket) {
    var c = socket.decoded_token;
    if (c.db) {
        console.log(c.db);
        Machines.add(c.user, c.password, c.db, c.serial, socket);
        _.map(Auditors.forserial(c.serial), function (socketid) {
            io.to(socketid).emit("machine connection", { serial: c.serial });
        });
        socket.on("disconnect", function () {
            _.map(Auditors.forserial(c.serial), function (socketid) {
                io.to(socketid).emit("machine disconnection", { serial: c.serial });
            });
            Machines.remove(c.serial, socket.id);
        });
        socket.on("message", function (message) {
            Machines.pushdata(c.serial, "message", message).then(function (docs) {
                _.map(Auditors.forserial(c.serial), function (socketid) {
                    io.to(socketid).emit("machine message", { serial: c.serial, data: message });
                });
            });
        });
        socket.on("data", function (data) {
            Machines.pushdata(c.serial, "data", data).then(function (docs) {
                _.map(Auditors.forserial(c.serial), function (socketid) {
                    io.to(socketid).emit("machine data", { serial: c.serial, data: data });
                });
            });
        });
        socket.on("docs", function (docs) {
            Machines.pushdata(c.serial, "docs", docs).then(function (docs) {
                _.map(Auditors.forserial(c.serial), function (socketid) {
                    io.to(socketid).emit("machine docs", { serial: c.serial, data: docs });
                });
            });
        });
        socket.on("up", function (datas) {
            _.map(Auditors.forserial(c.serial), function (socketid) {
                io.to(socketid).emit("machine up", { serial: c.serial });
            });
        });
    }
    else {
        Auditors.add(c.serials, socket.id);
        socket.on("disconnect", function () {
            Auditors.remove(socket.id);
        });
    }
    console.log("hello! ", socket.id);
});

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImluZGV4LnRzIl0sIm5hbWVzIjpbImF1dGhjb3VjaCIsImF1dGhvcml6ZXNvY2tldCJdLCJtYXBwaW5ncyI6IkFBQUEsSUFBWSxHQUFHLFdBQU0sS0FBSyxDQUFDLENBQUE7QUFDM0IsSUFBWSxDQUFDLFdBQU0sUUFBUSxDQUFDLENBQUE7QUFDNUIsSUFBWSxPQUFPLFdBQU0sVUFBVSxDQUFDLENBQUE7QUFDcEMsSUFBWSxVQUFVLFdBQU0sYUFBYSxDQUFDLENBQUE7QUFDMUMsSUFBWSxVQUFVLFdBQU0sYUFBYSxDQUFDLENBQUE7QUFDMUMsSUFBWSxFQUFFLFdBQU0sV0FBVyxDQUFDLENBQUE7QUFDaEMsSUFBWSxPQUFPLFdBQU0sU0FBUyxDQUFDLENBQUE7QUFDbkMsSUFBWSxHQUFHLFdBQU0sY0FBYyxDQUFDLENBQUE7QUFHcEMsSUFBSSxNQUFNLEdBQUcsT0FBTyxDQUFDLGlCQUFpQixDQUFDLENBQUM7QUFHeEMsSUFBTyxhQUFhLFdBQVcsZUFBZSxDQUFDLENBQUM7QUFFaEQsSUFBTyxXQUFXLFdBQVcsdUJBQXVCLENBQUMsQ0FBQztBQUN0RCxJQUFPLFVBQVUsV0FBVyxzQkFBc0IsQ0FBQyxDQUFDO0FBRXBELElBQUksV0FBVyxHQUFHLE9BQU8sQ0FBQyxjQUFjLENBQUMsQ0FBQztBQUMxQyxJQUFJLEdBQUcsR0FBRyxPQUFPLENBQUMsc0JBQXNCLENBQUMsQ0FBQztBQUMxQyxJQUFJLEtBQUssR0FBRyxPQUFPLENBQUMsT0FBTyxDQUFDLENBQUM7QUFHN0IsSUFBSSxHQUFHLEdBQUcsT0FBTyxFQUFFLENBQUM7QUFDcEIsSUFBSSxNQUFNLEdBQUcsT0FBTyxDQUFDLE1BQU0sQ0FBQyxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsQ0FBQztBQUN6QyxJQUFJLEVBQUUsR0FBRyxFQUFFLENBQUMsTUFBTSxDQUFDLENBQUM7QUFNcEIsRUFBRSxDQUFDLENBQUMsQ0FBQyxVQUFVLENBQUMsSUFBSSxDQUFDLGFBQWEsQ0FBQyxDQUFDLENBQUMsQ0FBQztJQUNsQyxNQUFNLEtBQUssQ0FBQywwQkFBMEIsQ0FBQyxDQUFDO0FBQzVDLENBQUM7QUFDRCxJQUFJLElBQUksR0FBRyxPQUFPLENBQUMsYUFBYSxDQUFDLENBQUM7QUFFbEMsSUFBSSxPQUFPLEdBQUcsSUFBSSxhQUFhLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxDQUFDO0FBRTlDLElBQUksUUFBUSxHQUFHLElBQUksV0FBVyxDQUFDLE9BQU8sQ0FBQyxDQUFDO0FBQ3hDLElBQUksUUFBUSxHQUFHLElBQUksVUFBVSxFQUFFLENBQUM7QUFHaEMsR0FBRyxDQUFDLEdBQUcsQ0FBQyxVQUFVLENBQUMsVUFBVSxDQUFDLEVBQUUsUUFBUSxFQUFFLEtBQUssRUFBRSxDQUFDLENBQUMsQ0FBQztBQUdwRCxHQUFHLENBQUMsR0FBRyxDQUFDLFVBQVUsQ0FBQyxJQUFJLEVBQUUsQ0FBQyxDQUFDO0FBSTNCLEVBQUUsQ0FBQyxHQUFHLENBQUMsV0FBVyxDQUFDLFNBQVMsQ0FBQztJQUN6QixNQUFNLEVBQUUsSUFBSSxDQUFDLE1BQU07SUFDbkIsU0FBUyxFQUFFLElBQUk7Q0FDbEIsQ0FBQyxDQUFDLENBQUM7QUFFSixNQUFNLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQztBQUd6QixJQUFJLEtBQUssR0FBRyxLQUFLLEVBQUUsQ0FBQztBQUNwQixJQUFJLE9BQU8sR0FBRyxHQUFHLENBQUMsWUFBWSxDQUFDLEtBQUssQ0FBQyxNQUFNLENBQUMsQ0FBQztBQUU3QyxPQUFPLENBQUMsTUFBTSxDQUFDLElBQUksRUFBRTtJQUNqQixPQUFPLENBQUMsR0FBRyxDQUFDLCtCQUErQixFQUFFLElBQUksQ0FBQyxDQUFDO0FBQ3ZELENBQUMsQ0FBQyxDQUFDO0FBR0gsS0FBSyxDQUFDLFlBQVksR0FBRyxVQUFTLE1BQU0sRUFBRSxRQUFRLEVBQUUsS0FBSyxFQUFFLFFBQVE7SUFHM0QsRUFBRSxDQUFDLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxRQUFRLEtBQUssUUFBUSxDQUFDLENBQUMsQ0FBQztRQUVuQyxFQUFFLENBQUMsQ0FBQyxLQUFLLEtBQUssSUFBSSxDQUFDLEtBQUssQ0FBQyxRQUFRLENBQUMsQ0FBQyxDQUFDO1lBQ2hDLFFBQVEsQ0FBQyxJQUFJLEVBQUUsSUFBSSxDQUFDLENBQUM7UUFDekIsQ0FBQztRQUFDLElBQUksQ0FBQyxDQUFDO1lBQ0osT0FBTyxDQUFDLEdBQUcsQ0FBQyxlQUFlLEdBQUcsUUFBUSxDQUFDLENBQUM7WUFDeEMsUUFBUSxDQUFDLElBQUksQ0FBQyxDQUFDO1FBQ25CLENBQUM7SUFHTCxDQUFDO0lBQUMsSUFBSSxDQUFDLENBQUM7UUFFSixJQUFJLENBQUM7WUFJRCxJQUFJLE9BQU8sR0FBUSxHQUFHLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsS0FBSyxHQUFHLEVBQUUsQ0FBQyxFQUFFLElBQUksQ0FBQyxNQUFNLEVBQUUsRUFBRSxnQkFBZ0IsRUFBRSxJQUFJLEVBQUUsQ0FBQyxDQUFDO1lBQy9GLElBQUksRUFBRSxHQUFHLE9BQU8sQ0FBQyxFQUFFLENBQUM7WUFDcEIsSUFBSSxRQUFRLEdBQUcsT0FBTyxDQUFDLFFBQVEsQ0FBQztZQUNoQyxPQUFPLENBQUMsR0FBRyxDQUFDLE1BQU0sQ0FBQyxDQUFDO1lBSXBCLFNBQVMsQ0FBQyxRQUFRLEVBQUUsUUFBUSxFQUFFLEVBQUUsQ0FBQyxDQUFDLElBQUksQ0FBQztnQkFDbkMsT0FBTyxDQUFDLEdBQUcsQ0FBQyxhQUFhLEdBQUcsUUFBUSxDQUFDLENBQUM7Z0JBQ3RDLE1BQU0sQ0FBQyxNQUFNLEdBQUcsT0FBTyxDQUFDLE1BQU0sQ0FBQztnQkFDL0IsTUFBTSxDQUFDLEtBQUssR0FBRyxFQUFFLFFBQVEsRUFBRSxRQUFRLEVBQUUsUUFBUSxFQUFFLFFBQVEsRUFBRSxFQUFFLEVBQUUsRUFBRSxFQUFFLENBQUM7Z0JBQ2xFLFFBQVEsQ0FBQyxJQUFJLEVBQUUsSUFBSSxDQUFDLENBQUM7WUFDekIsQ0FBQyxDQUFDLENBQUMsS0FBSyxDQUFDO2dCQUNMLE9BQU8sQ0FBQyxHQUFHLENBQUMsZUFBZSxHQUFHLFFBQVEsQ0FBQyxDQUFDO2dCQUN4QyxRQUFRLENBQUMsSUFBSSxDQUFDLENBQUM7WUFDbkIsQ0FBQyxDQUFDLENBQUM7UUFHUCxDQUFFO1FBQUEsS0FBSyxDQUFDLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQztZQUNYLE9BQU8sQ0FBQyxHQUFHLENBQUMsZUFBZSxHQUFHLFFBQVEsQ0FBQyxDQUFDO1lBQ3hDLFFBQVEsQ0FBQyxJQUFJLENBQUMsQ0FBQztRQUNuQixDQUFDO0lBRUwsQ0FBQztBQUVMLENBQUMsQ0FBQztBQUVGLEtBQUssQ0FBQyxFQUFFLENBQUMsUUFBUSxFQUFFLFVBQVMsTUFBTTtJQUc5QixPQUFPLENBQUMsR0FBRyxDQUFDLFlBQVksR0FBRyxNQUFNLENBQUMsRUFBRSxDQUFDLENBQUM7QUFJMUMsQ0FBQyxDQUFDLENBQUM7QUFFSCxLQUFLLENBQUMsRUFBRSxDQUFDLGtCQUFrQixFQUFFLFVBQVMsTUFBTTtJQUN4QyxPQUFPLENBQUMsR0FBRyxDQUFDLGtCQUFrQixDQUFDLENBQUM7QUFDcEMsQ0FBQyxDQUFDLENBQUM7QUFFSCxLQUFLLENBQUMsRUFBRSxDQUFDLFdBQVcsRUFBRSxVQUFTLEtBQUssRUFBRSxNQUFNO0lBQ3hDLE9BQU8sQ0FBQyxHQUFHLENBQUMsV0FBVyxDQUFDLENBQUM7QUFDN0IsQ0FBQyxDQUFDLENBQUM7QUFFSCxLQUFLLENBQUMsRUFBRSxDQUFDLGFBQWEsRUFBRSxVQUFTLEtBQUssRUFBRSxNQUFNO0lBQzFDLE9BQU8sQ0FBQyxHQUFHLENBQUMsYUFBYSxDQUFDLENBQUM7QUFDL0IsQ0FBQyxDQUFDLENBQUM7QUFFSCxLQUFLLENBQUMsRUFBRSxDQUFDLFNBQVMsRUFBRSxVQUFTLE1BQU0sRUFBRSxNQUFNO0lBRXZDLEVBQUUsQ0FBQyxDQUFDLENBQUMsTUFBTSxDQUFDO1FBQUMsTUFBTSxDQUFDO0lBRXBCLElBQUksR0FBRyxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsTUFBTSxDQUFDLE9BQU8sQ0FBQyxRQUFRLEVBQUUsQ0FBQyxDQUFDO0lBQ2hELE9BQU8sQ0FBQyxHQUFHLENBQUMsU0FBUyxDQUFDLENBQUM7SUFFM0IsRUFBRSxDQUFDLENBQUMsR0FBRyxDQUFDLE1BQU0sSUFBSSxHQUFHLENBQUMsR0FBRyxLQUFHLHdCQUF3QixDQUFDLENBQUEsQ0FBQztRQUM5QyxPQUFPLENBQUMsR0FBRyxDQUFDLFNBQVMsQ0FBQyxDQUFDO0lBQy9CLENBQUM7SUFBQyxJQUFJLENBQUEsQ0FBQztRQUtILEVBQUUsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxLQUFLLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxDQUFDLE1BQU0sR0FBRyxDQUFDLElBQUksTUFBTSxDQUFDLEtBQUssQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDLElBQUksTUFBTSxJQUFJLE1BQU0sQ0FBQyxLQUFLLElBQUksTUFBTSxDQUFDLEtBQUssSUFBSSxNQUFNLENBQUMsS0FBSyxDQUFDLFFBQVMsQ0FBQyxDQUFDLENBQUM7WUFNdkksRUFBRSxDQUFDLENBQUMsTUFBTSxDQUFDLEtBQUssQ0FBQyxFQUFFLEtBQUsseUJBQXlCLElBQUksTUFBTSxDQUFDLEtBQUssQ0FBQyxFQUFFLEtBQUsseUJBQXlCLENBQUMsQ0FBQyxDQUFDO2dCQUNqRyxHQUFHLENBQUMsU0FBUyxHQUFHLEdBQUcsQ0FBQyxTQUFTLEdBQUcsT0FBTyxDQUFDO2dCQUN4QyxHQUFHLENBQUMsSUFBSSxHQUFHLE1BQU0sQ0FBQyxFQUFFLENBQUMsR0FBRyxDQUFDLFNBQVMsRUFBRSxhQUFhLENBQUMsQ0FBQyxNQUFNLENBQUMsbUJBQW1CLENBQUMsQ0FBQztZQUNuRixDQUFDO1lBQ0QsT0FBTyxDQUFDLEdBQUcsQ0FBQyxNQUFNLENBQUMsQ0FBQztZQUNwQixHQUFHLENBQUMsR0FBRyxDQUFDLFNBQVMsR0FBRyxNQUFNLENBQUMsS0FBSyxDQUFDLFFBQVEsR0FBRyxHQUFHLEdBQUcsTUFBTSxDQUFDLEtBQUssQ0FBQyxRQUFRLEdBQUcsdUJBQXVCLEdBQUcsTUFBTSxDQUFDLEtBQUssQ0FBQyxFQUFFLEdBQUcsR0FBRyxHQUFHLEdBQUcsQ0FBQyxHQUFHLENBQUMsQ0FBQyxJQUFJLENBQUMsVUFBUyxDQUFDO2dCQUNoSixHQUFHLENBQUMsSUFBSSxHQUFHLENBQUMsQ0FBQyxJQUFJLENBQUM7Z0JBQ2xCLEdBQUcsQ0FBQyxHQUFHLENBQUMsU0FBUyxHQUFHLE1BQU0sQ0FBQyxLQUFLLENBQUMsUUFBUSxHQUFHLEdBQUcsR0FBRyxNQUFNLENBQUMsS0FBSyxDQUFDLFFBQVEsR0FBRyx1QkFBdUIsR0FBRyxNQUFNLENBQUMsS0FBSyxDQUFDLEVBQUUsR0FBRyxHQUFHLEdBQUcsR0FBRyxDQUFDLEdBQUcsRUFBRSxHQUFHLENBQUMsQ0FBQyxJQUFJLENBQUM7b0JBQzNJLE9BQU8sQ0FBQyxHQUFHLENBQUMsUUFBUSxDQUFDLENBQUM7b0JBR3RCLEdBQUcsQ0FBQyxHQUFHLENBQUMsU0FBUyxHQUFHLE1BQU0sQ0FBQyxLQUFLLENBQUMsUUFBUSxHQUFHLEdBQUcsR0FBRyxNQUFNLENBQUMsS0FBSyxDQUFDLFFBQVEsR0FBRyx1QkFBdUIsR0FBRyxNQUFNLENBQUMsS0FBSyxDQUFDLEVBQUUsR0FBRyxRQUFRLENBQUMsQ0FBQyxJQUFJLENBQUMsVUFBUyxJQUFJO3dCQUc5SSxJQUFJLENBQUM7NEJBRUQsSUFBSSxPQUFPLEdBQUcsSUFBSSxDQUFDLE1BQU0sQ0FBQyxLQUFLLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7NEJBRS9DLE9BQU8sQ0FBQyxHQUFHLENBQUMsT0FBTyxDQUFDLENBQUM7NEJBRXJCLEVBQUUsQ0FBQyxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsS0FBSyxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQztnQ0FFbkMsR0FBRyxDQUFDLElBQUksQ0FBQyxPQUFPLEdBQUcsR0FBRyxHQUFHLE1BQU0sQ0FBQyxNQUFNLEdBQUcsR0FBRyxHQUFHLE1BQU0sQ0FBQyxLQUFLLENBQUMsRUFBRSxHQUFHLEdBQUcsR0FBRyxNQUFNLENBQUMsS0FBSyxDQUFDLFFBQVEsR0FBRyxHQUFHLEdBQUcsTUFBTSxDQUFDLEtBQUssQ0FBQyxRQUFRLEVBQUUsRUFBRSxJQUFJLEVBQUUsR0FBRyxFQUFFLENBQUMsQ0FBQyxJQUFJLENBQUMsVUFBUyxHQUFHO29DQUN4SixPQUFPLENBQUMsR0FBRyxDQUFDLDhCQUE4QixDQUFDLENBQUM7Z0NBRWhELENBQUMsQ0FBQyxDQUFDLEtBQUssQ0FBQyxVQUFTLEdBQUc7b0NBQ2pCLE9BQU8sQ0FBQyxHQUFHLENBQUMsR0FBRyxDQUFDLENBQUM7Z0NBQ3JCLENBQUMsQ0FBQyxDQUFDOzRCQUlQLENBQUM7d0JBR0wsQ0FBRTt3QkFBQSxLQUFLLENBQUMsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDOzRCQUVYLE9BQU8sQ0FBQyxHQUFHLENBQUMsR0FBRyxDQUFDLENBQUM7d0JBRXJCLENBQUM7b0JBR0wsQ0FBQyxDQUFDLENBQUMsS0FBSyxDQUFDLFVBQVMsR0FBRzt3QkFDakIsT0FBTyxDQUFDLEdBQUcsQ0FBQyxHQUFHLENBQUMsQ0FBQztvQkFDckIsQ0FBQyxDQUFDLENBQUM7Z0JBS1AsQ0FBQyxDQUFDLENBQUMsS0FBSyxDQUFDLFVBQVMsR0FBRztvQkFDakIsT0FBTyxDQUFDLEdBQUcsQ0FBQyxhQUFhLEdBQUcsR0FBRyxDQUFDLENBQUM7Z0JBQ3JDLENBQUMsQ0FBQyxDQUFDO1lBRVAsQ0FBQyxDQUFDLENBQUMsS0FBSyxDQUFDLFVBQVMsR0FBRztnQkFDakIsRUFBRSxDQUFDLENBQUMsR0FBRyxDQUFDLFVBQVUsS0FBSyxHQUFHLENBQUMsQ0FBQyxDQUFDO29CQUN6QixHQUFHLENBQUMsR0FBRyxDQUFDLFNBQVMsR0FBRyxNQUFNLENBQUMsS0FBSyxDQUFDLFFBQVEsR0FBRyxHQUFHLEdBQUcsTUFBTSxDQUFDLEtBQUssQ0FBQyxRQUFRLEdBQUcsdUJBQXVCLEdBQUcsTUFBTSxDQUFDLEtBQUssQ0FBQyxFQUFFLEdBQUcsR0FBRyxHQUFHLEdBQUcsQ0FBQyxHQUFHLEVBQUUsR0FBRyxDQUFDLENBQUMsSUFBSSxDQUFDO3dCQUMzSSxPQUFPLENBQUMsR0FBRyxDQUFDLFFBQVEsQ0FBQyxDQUFDO3dCQUd0QixHQUFHLENBQUMsR0FBRyxDQUFDLFNBQVMsR0FBRyxNQUFNLENBQUMsS0FBSyxDQUFDLFFBQVEsR0FBRyxHQUFHLEdBQUcsTUFBTSxDQUFDLEtBQUssQ0FBQyxRQUFRLEdBQUcsdUJBQXVCLEdBQUcsTUFBTSxDQUFDLEtBQUssQ0FBQyxFQUFFLEdBQUcsUUFBUSxDQUFDLENBQUMsSUFBSSxDQUFDLFVBQVMsSUFBSTs0QkFHOUksSUFBSSxDQUFDO2dDQUVELElBQUksT0FBTyxHQUFHLElBQUksQ0FBQyxNQUFNLENBQUMsS0FBSyxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO2dDQUUvQyxPQUFPLENBQUMsR0FBRyxDQUFDLE9BQU8sQ0FBQyxDQUFDO2dDQUVyQixFQUFFLENBQUMsQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLEtBQUssQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7b0NBRW5DLEdBQUcsQ0FBQyxJQUFJLENBQUMsT0FBTyxHQUFHLEdBQUcsR0FBRyxNQUFNLENBQUMsTUFBTSxHQUFHLEdBQUcsR0FBRyxNQUFNLENBQUMsS0FBSyxDQUFDLEVBQUUsR0FBRyxHQUFHLEdBQUcsTUFBTSxDQUFDLEtBQUssQ0FBQyxRQUFRLEdBQUcsR0FBRyxHQUFHLE1BQU0sQ0FBQyxLQUFLLENBQUMsUUFBUSxFQUFFLEVBQUUsSUFBSSxFQUFFLEdBQUcsRUFBRSxDQUFDLENBQUMsSUFBSSxDQUFDLFVBQVMsR0FBRzt3Q0FDeEosT0FBTyxDQUFDLEdBQUcsQ0FBQyw4QkFBOEIsQ0FBQyxDQUFDO29DQUVoRCxDQUFDLENBQUMsQ0FBQyxLQUFLLENBQUMsVUFBUyxHQUFHO3dDQUNqQixPQUFPLENBQUMsR0FBRyxDQUFDLEdBQUcsQ0FBQyxDQUFDO29DQUNyQixDQUFDLENBQUMsQ0FBQztnQ0FJUCxDQUFDOzRCQUdMLENBQUU7NEJBQUEsS0FBSyxDQUFDLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQztnQ0FFWCxPQUFPLENBQUMsR0FBRyxDQUFDLEdBQUcsQ0FBQyxDQUFDOzRCQUVyQixDQUFDO3dCQUdMLENBQUMsQ0FBQyxDQUFDLEtBQUssQ0FBQyxVQUFTLEdBQUc7NEJBQ2pCLE9BQU8sQ0FBQyxHQUFHLENBQUMsR0FBRyxDQUFDLENBQUM7d0JBQ3JCLENBQUMsQ0FBQyxDQUFDO29CQUlQLENBQUMsQ0FBQyxDQUFDLEtBQUssQ0FBQyxVQUFTLEdBQUc7d0JBQ2pCLE9BQU8sQ0FBQyxHQUFHLENBQUMsYUFBYSxHQUFHLEdBQUcsQ0FBQyxDQUFDO29CQUNyQyxDQUFDLENBQUMsQ0FBQztnQkFFUCxDQUFDO2dCQUFDLElBQUksQ0FBQyxDQUFDO29CQUNKLE9BQU8sQ0FBQyxHQUFHLENBQUMsR0FBRyxDQUFDLENBQUM7Z0JBQ3JCLENBQUM7WUFFTCxDQUFDLENBQUMsQ0FBQztRQUdQLENBQUM7SUFDTCxDQUFDO0FBSUQsQ0FBQyxDQUFDLENBQUM7QUFvQkgsR0FBRyxDQUFDLEdBQUcsQ0FBQyxHQUFHLEVBQUUsVUFBUyxHQUFHLEVBQUUsR0FBRztJQUMxQixHQUFHLENBQUMsSUFBSSxDQUFDLEVBQUUsTUFBTSxFQUFFLElBQUksRUFBRSxDQUFDLENBQUM7QUFDL0IsQ0FBQyxDQUFDLENBQUM7QUFLSCxtQkFBbUIsSUFBWSxFQUFFLFFBQWdCLEVBQUUsRUFBVTtJQUN6REEsTUFBTUEsQ0FBQ0EsSUFBSUEsT0FBT0EsQ0FBQ0EsVUFBU0EsT0FBT0EsRUFBRUEsTUFBTUE7UUFDdkMsR0FBRyxDQUFDLEdBQUcsQ0FBQyxPQUFPLENBQUMsR0FBRyxDQUFDLElBQUksRUFBRSxRQUFRLEVBQUUsRUFBRSxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUM7WUFDMUMsT0FBTyxDQUFDLEVBQUUsT0FBTyxFQUFFLElBQUksRUFBRSxDQUFDLENBQUM7UUFDL0IsQ0FBQyxDQUFDLENBQUMsS0FBSyxDQUFDLFVBQVMsR0FBRztZQUNqQixNQUFNLENBQUMsRUFBRSxLQUFLLEVBQUUsbUJBQW1CLEVBQUUsQ0FBQyxDQUFDO1FBQzNDLENBQUMsQ0FBQyxDQUFDO0lBQ1AsQ0FBQyxDQUFDQSxDQUFDQTtBQUNQQSxDQUFDQTtBQUVELHlCQUF5QixPQUFPO0lBQzVCQyxNQUFNQSxDQUFDQSxHQUFHQSxDQUFDQSxJQUFJQSxDQUFDQSxPQUFPQSxFQUFFQSxJQUFJQSxDQUFDQSxNQUFNQSxFQUFFQSxFQUFFQSxnQkFBZ0JBLEVBQUVBLEVBQUVBLEdBQUdBLENBQUNBLEVBQUVBLENBQUNBLENBQUNBO0FBQ3hFQSxDQUFDQTtBQUVELEdBQUcsQ0FBQyxJQUFJLENBQUMsUUFBUSxFQUFFLFVBQVMsR0FBRyxFQUFFLEdBQUc7SUFDaEMsU0FBUyxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsSUFBSSxFQUFFLEdBQUcsQ0FBQyxJQUFJLENBQUMsUUFBUSxFQUFFLEdBQUcsQ0FBQyxJQUFJLENBQUMsRUFBRSxDQUFDLENBQUMsSUFBSSxDQUFDO1FBRTFELElBQUksS0FBSyxHQUFHLGVBQWUsQ0FBQyxFQUFFLElBQUksRUFBRSxHQUFHLENBQUMsSUFBSSxDQUFDLElBQUksRUFBRSxRQUFRLEVBQUUsR0FBRyxDQUFDLElBQUksQ0FBQyxRQUFRLEVBQUUsRUFBRSxFQUFFLEdBQUcsQ0FBQyxJQUFJLENBQUMsRUFBRSxFQUFFLE1BQU0sRUFBRSxHQUFHLENBQUMsSUFBSSxDQUFDLE1BQU0sRUFBRSxDQUFDLENBQUM7UUFFNUgsR0FBRyxDQUFDLElBQUksQ0FBQyxFQUFFLE9BQU8sRUFBRSxJQUFJLEVBQUUsS0FBSyxFQUFFLEtBQUssRUFBRSxDQUFDLENBQUM7SUFDOUMsQ0FBQyxDQUFDLENBQUMsS0FBSyxDQUFDLFVBQVMsR0FBRztRQUNqQixHQUFHLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDO0lBQ2xCLENBQUMsQ0FBQyxDQUFDO0FBQ1AsQ0FBQyxDQUFDLENBQUM7QUFFSCxHQUFHLENBQUMsR0FBRyxDQUFDLEtBQUssRUFBRSxVQUFTLEdBQUcsRUFBRSxHQUFHO0lBQzVCLEdBQUcsQ0FBQyxJQUFJLENBQUMsRUFBRSxFQUFFLEVBQUUsR0FBRyxDQUFDLE9BQU8sQ0FBQyxpQkFBaUIsQ0FBQyxFQUFFLENBQUMsQ0FBQztBQUNyRCxDQUFDLENBQUMsQ0FBQztBQUVILEdBQUcsQ0FBQyxHQUFHLENBQUMsVUFBVSxFQUFFLFVBQVMsR0FBRyxFQUFFLEdBQUc7SUFDakMsR0FBRyxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUMsT0FBTyxFQUFFLENBQUMsQ0FBQztBQUNqQyxDQUFDLENBQUMsQ0FBQztBQUNILEdBQUcsQ0FBQyxHQUFHLENBQUMsMkJBQTJCLEVBQUUsVUFBUyxHQUFHLEVBQUUsR0FBRztJQUNsRCxHQUFHLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxPQUFPLENBQUMsR0FBRyxDQUFDLE1BQU0sQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDO0FBQ2xELENBQUMsQ0FBQyxDQUFDO0FBQ0gsR0FBRyxDQUFDLEdBQUcsQ0FBQyxXQUFXLEVBQUUsVUFBUyxHQUFHLEVBQUUsR0FBRztJQUNsQyxHQUFHLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxJQUFJLEVBQUUsQ0FBQyxDQUFDO0FBQzlCLENBQUMsQ0FBQyxDQUFDO0FBQ0gsR0FBRyxDQUFDLEdBQUcsQ0FBQyxvQkFBb0IsRUFBRSxVQUFTLEdBQUcsRUFBRSxHQUFHO0FBRS9DLENBQUMsQ0FBQyxDQUFDO0FBRUgsR0FBRyxDQUFDLEdBQUcsQ0FBQyxvQ0FBb0MsRUFBRSxVQUFTLEdBQUcsRUFBRSxHQUFHO0lBQzNELENBQUMsQ0FBQyxHQUFHLENBQUMsUUFBUSxDQUFDLEdBQUcsQ0FBQyxHQUFHLENBQUMsTUFBTSxDQUFDLE1BQU0sQ0FBQyxFQUFFLFVBQVMsTUFBTTtRQUNsRCxNQUFNLENBQUMsSUFBSSxDQUFDLFNBQVMsRUFBRSxHQUFHLENBQUMsTUFBTSxDQUFDLE9BQU8sQ0FBQyxDQUFDO0lBRS9DLENBQUMsQ0FBQyxDQUFDO0lBQ0gsR0FBRyxDQUFDLElBQUksQ0FBQyxFQUFFLENBQUMsQ0FBQztBQUVqQixDQUFDLENBQUMsQ0FBQztBQUVILEdBQUcsQ0FBQyxJQUFJLENBQUMsMkJBQTJCLEVBQUUsVUFBUyxHQUFHLEVBQUUsR0FBRztJQUNuRCxDQUFDLENBQUMsR0FBRyxDQUFDLFFBQVEsQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLE1BQU0sQ0FBQyxNQUFNLENBQUMsRUFBRSxVQUFTLFFBQVE7UUFDckQsRUFBRSxDQUFDLEVBQUUsQ0FBQyxRQUFRLENBQUMsQ0FBQyxJQUFJLENBQUMsU0FBUyxFQUFFLEdBQUcsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUM7SUFDbkQsQ0FBQyxDQUFDLENBQUM7QUFFUCxDQUFDLENBQUMsQ0FBQztBQUNILEdBQUcsQ0FBQyxJQUFJLENBQUMsd0JBQXdCLEVBQUUsVUFBUyxHQUFHLEVBQUUsR0FBRztJQUNoRCxDQUFDLENBQUMsR0FBRyxDQUFDLFFBQVEsQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLE1BQU0sQ0FBQyxNQUFNLENBQUMsRUFBRSxVQUFTLFFBQVE7UUFDckQsRUFBRSxDQUFDLEVBQUUsQ0FBQyxRQUFRLENBQUMsQ0FBQyxJQUFJLENBQUMsTUFBTSxFQUFFLEdBQUcsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUM7SUFDaEQsQ0FBQyxDQUFDLENBQUM7QUFDUCxDQUFDLENBQUMsQ0FBQztBQUNILEdBQUcsQ0FBQyxJQUFJLENBQUMsd0JBQXdCLEVBQUUsVUFBUyxHQUFHLEVBQUUsR0FBRztJQUNoRCxDQUFDLENBQUMsR0FBRyxDQUFDLFFBQVEsQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLE1BQU0sQ0FBQyxNQUFNLENBQUMsRUFBRSxVQUFTLFFBQVE7UUFDckQsRUFBRSxDQUFDLEVBQUUsQ0FBQyxRQUFRLENBQUMsQ0FBQyxJQUFJLENBQUMsTUFBTSxFQUFFLEdBQUcsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUM7SUFDaEQsQ0FBQyxDQUFDLENBQUM7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QUUsVUFBUyxLQUFLO1lBQzFCLENBQUMsQ0FBQyxHQUFHLENBQUMsUUFBUSxDQUFDLFNBQVMsQ0FBQyxDQUFDLENBQUMsTUFBTSxDQUFDLEVBQUUsVUFBUyxRQUFRO2dCQUNqRCxFQUFFLENBQUMsRUFBRSxDQUFDLFFBQVEsQ0FBQyxDQUFDLElBQUksQ0FBQyxZQUFZLEVBQUUsRUFBRSxNQUFNLEVBQUUsQ0FBQyxDQUFDLE1BQU0sRUFBRSxDQUFDLENBQUM7WUFDN0QsQ0FBQyxDQUFDLENBQUM7UUFDUCxDQUFDLENBQUMsQ0FBQztJQUVQLENBQUM7SUFBQyxJQUFJLENBQUMsQ0FBQztRQUNKLFFBQVEsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLE9BQU8sRUFBRSxNQUFNLENBQUMsRUFBRSxDQUFDLENBQUM7UUFDbkMsTUFBTSxDQUFDLEVBQUUsQ0FBQyxZQUFZLEVBQUU7WUFDcEIsUUFBUSxDQUFDLE1BQU0sQ0FBQyxNQUFNLENBQUMsRUFBRSxDQUFDLENBQUM7UUFDL0IsQ0FBQyxDQUFDLENBQUM7SUFFUCxDQUFDO0lBRUQsT0FBTyxDQUFDLEdBQUcsQ0FBQyxTQUFTLEVBQUUsTUFBTSxDQUFDLEVBQUUsQ0FBQyxDQUFDO0FBQ3RDLENBQUMsQ0FBQyxDQUFDIiwiZmlsZSI6ImluZGV4LmpzIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0ICogYXMgbmV0IGZyb20gXCJuZXRcIjtcbmltcG9ydCAqIGFzIF8gZnJvbSBcImxvZGFzaFwiO1xuaW1wb3J0ICogYXMgUHJvbWlzZSBmcm9tIFwiYmx1ZWJpcmRcIjtcbmltcG9ydCAqIGFzIGJvZHlQYXJzZXIgZnJvbSBcImJvZHktcGFyc2VyXCI7XG5pbXBvcnQgKiBhcyBwYXRoRXhpc3RzIGZyb20gXCJwYXRoLWV4aXN0c1wiO1xuaW1wb3J0ICogYXMgSU8gZnJvbSBcInNvY2tldC5pb1wiO1xuaW1wb3J0ICogYXMgZXhwcmVzcyBmcm9tIFwiZXhwcmVzc1wiO1xuaW1wb3J0ICogYXMgand0IGZyb20gXCJqc29ud2VidG9rZW5cIjtcbmltcG9ydCAqIGFzIHJlZGlzIGZyb20gXCJyZWRpc1wiO1xuXG5sZXQgbW9tZW50ID0gcmVxdWlyZShcIm1vbWVudC10aW1lem9uZVwiKTtcblxuXG5pbXBvcnQgY291Y2hqc29uY29uZiA9IHJlcXVpcmUoXCJjb3VjaGpzb25jb25mXCIpO1xuXG5pbXBvcnQgbWFjaENsaWVudHMgPSByZXF1aXJlKFwiLi9tb2R1bGVzL21hY2hDbGllbnRzXCIpO1xuaW1wb3J0IGF1ZENsaWVudHMgPSByZXF1aXJlKFwiLi9tb2R1bGVzL2F1ZENsaWVudHNcIik7XG5cbmxldCBzb2NrZXRpb0p3dCA9IHJlcXVpcmUoXCJzb2NrZXRpby1qd3RcIik7XG5sZXQgcnBqID0gcmVxdWlyZShcInJlcXVlc3QtcHJvbWlzZS1qc29uXCIpO1xubGV0IGFlZGVzID0gcmVxdWlyZShcImFlZGVzXCIpO1xuXG5cbmxldCBhcHAgPSBleHByZXNzKCk7XG5sZXQgc2VydmVyID0gcmVxdWlyZShcImh0dHBcIikuU2VydmVyKGFwcCk7XG5sZXQgaW8gPSBJTyhzZXJ2ZXIpO1xuXG5cblxuXG5cbmlmICghcGF0aEV4aXN0cy5zeW5jKFwiLi9jb25mLmpzb25cIikpIHtcbiAgICB0aHJvdyBFcnJvcihcIm5vIGNvbmZpZ3VyYXRpb24gZm91bmRlZFwiKTtcbn1cbmxldCBjb25mID0gcmVxdWlyZShcIi4vY29uZi5qc29uXCIpO1xuXG5sZXQgQ09VQ0hEQiA9IG5ldyBjb3VjaGpzb25jb25mKGNvbmYuY291Y2hkYik7XG5cbmxldCBNYWNoaW5lcyA9IG5ldyBtYWNoQ2xpZW50cyhDT1VDSERCKTtcbmxldCBBdWRpdG9ycyA9IG5ldyBhdWRDbGllbnRzKCk7XG5cbi8vIHBhcnNlIGFwcGxpY2F0aW9uL3gtd3d3LWZvcm0tdXJsZW5jb2RlZFxuYXBwLnVzZShib2R5UGFyc2VyLnVybGVuY29kZWQoeyBleHRlbmRlZDogZmFsc2UgfSkpO1xuXG4vLyBwYXJzZSBhcHBsaWNhdGlvbi9qc29uXG5hcHAudXNlKGJvZHlQYXJzZXIuanNvbigpKTtcblxuXG5cbmlvLnVzZShzb2NrZXRpb0p3dC5hdXRob3JpemUoe1xuICAgIHNlY3JldDogY29uZi5zZWNyZXQsXG4gICAgaGFuZHNoYWtlOiB0cnVlXG59KSk7XG5cbnNlcnZlci5saXN0ZW4oY29uZi5wb3J0KTtcblxuXG5sZXQgQWVkZXMgPSBhZWRlcygpO1xubGV0IEFzZXJ2ZXIgPSBuZXQuY3JlYXRlU2VydmVyKEFlZGVzLmhhbmRsZSk7XG5cbkFzZXJ2ZXIubGlzdGVuKDE4ODMsIGZ1bmN0aW9uKCkge1xuICAgIGNvbnNvbGUubG9nKFwiTVFUVCBzZXJ2ZXIgbGlzdGVuaW5nIG9uIHBvcnRcIiwgMTg4Myk7XG59KTtcblxuXG5BZWRlcy5hdXRoZW50aWNhdGUgPSBmdW5jdGlvbihjbGllbnQsIHVzZXJuYW1lLCB0b2tlbiwgY2FsbGJhY2spIHtcblxuXG4gICAgaWYgKGNvbmYuYWRtaW4udXNlcm5hbWUgPT09IHVzZXJuYW1lKSB7XG5cbiAgICAgICAgaWYgKHRva2VuID09PSBjb25mLmFkbWluLnBhc3N3b3JkKSB7XG4gICAgICAgICAgICBjYWxsYmFjayhudWxsLCB0cnVlKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKFwidW5hdXRob3JpemVkIFwiICsgdXNlcm5hbWUpO1xuICAgICAgICAgICAgY2FsbGJhY2sobnVsbCk7XG4gICAgICAgIH1cblxuXG4gICAgfSBlbHNlIHtcblxuICAgICAgICB0cnkge1xuXG5cblxuICAgICAgICAgICAgbGV0IGRlY29kZWQ6IGFueSA9IGp3dC52ZXJpZnkoSlNPTi5wYXJzZSh0b2tlbiArIFwiXCIpLCBjb25mLnNlY3JldCwgeyBpZ25vcmVFeHBpcmF0aW9uOiB0cnVlIH0pOyAvLyB0byBiZSBjaGFuZ2VkIGluIHZlcmlmeVxuICAgICAgICAgICAgbGV0IGRiID0gZGVjb2RlZC5kYjtcbiAgICAgICAgICAgIGxldCBwYXNzd29yZCA9IGRlY29kZWQucGFzc3dvcmQ7XG4gICAgICAgICAgICBjb25zb2xlLmxvZyhcImF1dGhcIik7XG5cblxuICAgICAgICAgICAgLy8gXG4gICAgICAgICAgICBhdXRoY291Y2godXNlcm5hbWUsIHBhc3N3b3JkLCBkYikudGhlbihmdW5jdGlvbigpIHtcbiAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhcImF1dGhvcml6ZWQgXCIgKyB1c2VybmFtZSk7XG4gICAgICAgICAgICAgICAgY2xpZW50LnNlcmlhbCA9IGRlY29kZWQuc2VyaWFsO1xuICAgICAgICAgICAgICAgIGNsaWVudC5jb3VjaCA9IHsgdXNlcm5hbWU6IHVzZXJuYW1lLCBwYXNzd29yZDogcGFzc3dvcmQsIGRiOiBkYiB9O1xuICAgICAgICAgICAgICAgIGNhbGxiYWNrKG51bGwsIHRydWUpO1xuICAgICAgICAgICAgfSkuY2F0Y2goZnVuY3Rpb24oKSB7XG4gICAgICAgICAgICAgICAgY29uc29sZS5sb2coXCJ1bmF1dGhvcml6ZWQgXCIgKyB1c2VybmFtZSk7XG4gICAgICAgICAgICAgICAgY2FsbGJhY2sobnVsbCk7XG4gICAgICAgICAgICB9KTtcblxuXG4gICAgICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgICAgICAgY29uc29sZS5sb2coXCJ1bmF1dGhvcml6ZWQgXCIgKyB1c2VybmFtZSk7XG4gICAgICAgICAgICBjYWxsYmFjayhudWxsKTtcbiAgICAgICAgfVxuXG4gICAgfVxuXG59O1xuXG5BZWRlcy5vbihcImNsaWVudFwiLCBmdW5jdGlvbihjbGllbnQpIHtcblxuXG4gICAgY29uc29sZS5sb2coXCJuZXcgY2xpZW50XCIgKyBjbGllbnQuaWQpO1xuXG5cblxufSk7XG5cbkFlZGVzLm9uKFwiY2xpZW50RGlzY29ubmVjdFwiLCBmdW5jdGlvbihjbGllbnQpIHtcbiAgICBjb25zb2xlLmxvZyhcImNsaWVudERpc2Nvbm5lY3RcIik7XG59KTtcblxuQWVkZXMub24oXCJzdWJzY3JpYmVcIiwgZnVuY3Rpb24odG9waWMsIGNsaWVudCkge1xuICAgIGNvbnNvbGUubG9nKFwic3Vic2NyaWJlXCIpO1xufSk7XG5cbkFlZGVzLm9uKFwidW5zdWJzY3JpYmVcIiwgZnVuY3Rpb24odG9waWMsIGNsaWVudCkge1xuICAgIGNvbnNvbGUubG9nKFwidW5zdWJzY3JpYmVcIik7XG59KTtcblxuQWVkZXMub24oXCJwdWJsaXNoXCIsIGZ1bmN0aW9uKHBhY2tldCwgY2xpZW50KSB7XG5cbiAgICBpZiAoIWNsaWVudCkgcmV0dXJuO1xuXG4gICAgbGV0IG9iaiA9IEpTT04ucGFyc2UocGFja2V0LnBheWxvYWQudG9TdHJpbmcoKSk7XG4gICAgY29uc29sZS5sb2coXCJwdWJsaXNoXCIpO1xuXG5pZiAob2JqLmFjdGl2ZSAmJiBvYmoudWlkPT09XCIxWEc0aFFYdXNwcW8xTjRFaHlya2R3XCIpe1xuICAgICAgICBjb25zb2xlLmxvZyhcIm9mZm1vZGVcIik7XG59IGVsc2V7XG4gICAgXG5cblxuXG4gICAgaWYgKHBhY2tldC50b3BpYy5zcGxpdChcIi9cIikubGVuZ3RoID4gMSAmJiBwYWNrZXQudG9waWMuc3BsaXQoXCIvXCIpWzBdID09IFwiZGF0YVwiICYmIGNsaWVudC5jb3VjaCAmJiBjbGllbnQuY291Y2ggJiYgY2xpZW50LmNvdWNoLnVzZXJuYW1lICkge1xuXG4gICAgICAgIC8vICAgIHJwai5wb3N0KClcblxuXG4gICAgICAgIC8vIFBBVENIIFRPIEJFIFJFTU9WRURERERcbiAgICAgICAgaWYgKGNsaWVudC5jb3VjaC5kYiA9PT0gXCJtYWNoX3BjdHQzdl9lbmVyZ3l0cmFja1wiIHx8IGNsaWVudC5jb3VjaC5kYiA9PT0gXCJtYWNoX3N4Y20wcV9lbmVyZ3l0cmFja1wiKSB7IC8vIFBBVENIIFRPIEJFIFJFTU9WRURERERcbiAgICAgICAgICAgIG9iai51cGRhdGVkQXQgPSBvYmoudXBkYXRlZEF0ICsgMzYwMDAwMDtcbiAgICAgICAgICAgIG9iai5kYXRlID0gbW9tZW50LnR6KG9iai51cGRhdGVkQXQsIFwiRXVyb3BlL1JvbWVcIikuZm9ybWF0KFwiWVlZWU1NREQtSEg6bW06c3NcIik7XG4gICAgICAgIH1cbiAgICAgICAgY29uc29sZS5sb2coXCJzYXZlXCIpO1xuICAgICAgICBycGouZ2V0KFwiaHR0cDovL1wiICsgY2xpZW50LmNvdWNoLnVzZXJuYW1lICsgXCI6XCIgKyBjbGllbnQuY291Y2gucGFzc3dvcmQgKyBcIkAxOTIuMTY4LjEyMi40NDo1OTg0L1wiICsgY2xpZW50LmNvdWNoLmRiICsgXCIvXCIgKyBvYmouX2lkKS50aGVuKGZ1bmN0aW9uKGQpIHtcbiAgICAgICAgICAgIG9iai5fcmV2ID0gZC5fcmV2O1xuICAgICAgICAgICAgcnBqLnB1dChcImh0dHA6Ly9cIiArIGNsaWVudC5jb3VjaC51c2VybmFtZSArIFwiOlwiICsgY2xpZW50LmNvdWNoLnBhc3N3b3JkICsgXCJAMTkyLjE2OC4xMjIuNDQ6NTk4NC9cIiArIGNsaWVudC5jb3VjaC5kYiArIFwiL1wiICsgb2JqLl9pZCwgb2JqKS50aGVuKGZ1bmN0aW9uKCkge1xuICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKFwiYmFja3VwXCIpO1xuXG5cbiAgICAgICAgICAgICAgICBycGouZ2V0KFwiaHR0cDovL1wiICsgY2xpZW50LmNvdWNoLnVzZXJuYW1lICsgXCI6XCIgKyBjbGllbnQuY291Y2gucGFzc3dvcmQgKyBcIkAxOTIuMTY4LjEyMi40NDo1OTg0L1wiICsgY2xpZW50LmNvdWNoLmRiICsgXCIvaG9va3NcIikudGhlbihmdW5jdGlvbihkYXRhKSB7XG5cblxuICAgICAgICAgICAgICAgICAgICB0cnkge1xuXG4gICAgICAgICAgICAgICAgICAgICAgICBsZXQgaG9va3VybCA9IGRhdGFbcGFja2V0LnRvcGljLnNwbGl0KFwiL1wiKVswXV07XG5cbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKGhvb2t1cmwpO1xuXG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoZGF0YVtwYWNrZXQudG9waWMuc3BsaXQoXCIvXCIpWzBdXSkge1xuXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcnBqLnBvc3QoaG9va3VybCArIFwiL1wiICsgY2xpZW50LnNlcmlhbCArIFwiL1wiICsgY2xpZW50LmNvdWNoLmRiICsgXCIvXCIgKyBjbGllbnQuY291Y2gudXNlcm5hbWUgKyBcIi9cIiArIGNsaWVudC5jb3VjaC5wYXNzd29yZCwgeyBkYXRhOiBvYmogfSkudGhlbihmdW5jdGlvbihicm8pIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coXCJzZW5kIHRvIGFwcGxpY2FudGlvbiBtYW5hZ2VyXCIpO1xuXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfSkuY2F0Y2goZnVuY3Rpb24oZXJyKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKGVycik7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7XG5cblxuXG4gICAgICAgICAgICAgICAgICAgICAgICB9XG5cblxuICAgICAgICAgICAgICAgICAgICB9IGNhdGNoIChlcnIpIHtcblxuICAgICAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coZXJyKTtcblxuICAgICAgICAgICAgICAgICAgICB9XG5cblxuICAgICAgICAgICAgICAgIH0pLmNhdGNoKGZ1bmN0aW9uKGVycikge1xuICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhlcnIpO1xuICAgICAgICAgICAgICAgIH0pO1xuXG5cblxuXG4gICAgICAgICAgICB9KS5jYXRjaChmdW5jdGlvbihlcnIpIHtcbiAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhcInNhdmUgZXJyb3IgXCIgKyBlcnIpO1xuICAgICAgICAgICAgfSk7XG5cbiAgICAgICAgfSkuY2F0Y2goZnVuY3Rpb24oZXJyKSB7XG4gICAgICAgICAgICBpZiAoZXJyLnN0YXR1c0NvZGUgPT09IDQwNCkge1xuICAgICAgICAgICAgICAgIHJwai5wdXQoXCJodHRwOi8vXCIgKyBjbGllbnQuY291Y2gudXNlcm5hbWUgKyBcIjpcIiArIGNsaWVudC5jb3VjaC5wYXNzd29yZCArIFwiQDE5Mi4xNjguMTIyLjQ0OjU5ODQvXCIgKyBjbGllbnQuY291Y2guZGIgKyBcIi9cIiArIG9iai5faWQsIG9iaikudGhlbihmdW5jdGlvbigpIHtcbiAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coXCJiYWNrdXBcIik7XG5cblxuICAgICAgICAgICAgICAgICAgICBycGouZ2V0KFwiaHR0cDovL1wiICsgY2xpZW50LmNvdWNoLnVzZXJuYW1lICsgXCI6XCIgKyBjbGllbnQuY291Y2gucGFzc3dvcmQgKyBcIkAxOTIuMTY4LjEyMi40NDo1OTg0L1wiICsgY2xpZW50LmNvdWNoLmRiICsgXCIvaG9va3NcIikudGhlbihmdW5jdGlvbihkYXRhKSB7XG5cblxuICAgICAgICAgICAgICAgICAgICAgICAgdHJ5IHtcblxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxldCBob29rdXJsID0gZGF0YVtwYWNrZXQudG9waWMuc3BsaXQoXCIvXCIpWzBdXTtcblxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKGhvb2t1cmwpO1xuXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGRhdGFbcGFja2V0LnRvcGljLnNwbGl0KFwiL1wiKVswXV0pIHtcblxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBycGoucG9zdChob29rdXJsICsgXCIvXCIgKyBjbGllbnQuc2VyaWFsICsgXCIvXCIgKyBjbGllbnQuY291Y2guZGIgKyBcIi9cIiArIGNsaWVudC5jb3VjaC51c2VybmFtZSArIFwiL1wiICsgY2xpZW50LmNvdWNoLnBhc3N3b3JkLCB7IGRhdGE6IG9iaiB9KS50aGVuKGZ1bmN0aW9uKGJybykge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coXCJzZW5kIHRvIGFwcGxpY2FudGlvbiBtYW5hZ2VyXCIpO1xuXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pLmNhdGNoKGZ1bmN0aW9uKGVycikge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coZXJyKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7XG5cblxuXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuXG5cbiAgICAgICAgICAgICAgICAgICAgICAgIH0gY2F0Y2ggKGVycikge1xuXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coZXJyKTtcblxuICAgICAgICAgICAgICAgICAgICAgICAgfVxuXG5cbiAgICAgICAgICAgICAgICAgICAgfSkuY2F0Y2goZnVuY3Rpb24oZXJyKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhlcnIpO1xuICAgICAgICAgICAgICAgICAgICB9KTtcblxuXG5cbiAgICAgICAgICAgICAgICB9KS5jYXRjaChmdW5jdGlvbihlcnIpIHtcbiAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coXCJzYXZlIGVycm9yIFwiICsgZXJyKTtcbiAgICAgICAgICAgICAgICB9KTtcblxuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhlcnIpO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgIH0pO1xuXG5cbiAgICB9XG59XG5cblxuXG59KTtcblxuXG5pbnRlcmZhY2UgSVNvY2tldCB7XG5cbiAgICBpZDogc3RyaW5nO1xuICAgIGVtaXQ6IEZ1bmN0aW9uO1xuICAgIG9uOiBGdW5jdGlvbjtcbiAgICBkZWNvZGVkX3Rva2VuOiB7XG4gICAgICAgIGRiOiBzdHJpbmc7XG4gICAgICAgIHVzZXI6IHN0cmluZztcbiAgICAgICAgcGFzc3dvcmQ6IHN0cmluZztcbiAgICAgICAgc2VyaWFsOiBzdHJpbmc7XG4gICAgICAgIHNlcmlhbHM6IHN0cmluZ1tdXG4gICAgfTtcbn1cblxuXG5cblxuYXBwLmdldChcIi9cIiwgZnVuY3Rpb24ocmVxLCByZXMpIHtcbiAgICByZXMuanNvbih7IG9ubGluZTogdHJ1ZSB9KTtcbn0pO1xuXG5cblxuXG5mdW5jdGlvbiBhdXRoY291Y2godXNlcjogc3RyaW5nLCBwYXNzd29yZDogc3RyaW5nLCBkYjogc3RyaW5nKSB7XG4gICAgcmV0dXJuIG5ldyBQcm9taXNlKGZ1bmN0aW9uKHJlc29sdmUsIHJlamVjdCkge1xuICAgICAgICBycGouZ2V0KENPVUNIREIuZm9yKHVzZXIsIHBhc3N3b3JkLCBkYikpLnRoZW4oZnVuY3Rpb24oKSB7XG4gICAgICAgICAgICByZXNvbHZlKHsgc3VjY2VzczogdHJ1ZSB9KTtcbiAgICAgICAgfSkuY2F0Y2goZnVuY3Rpb24oZXJyKSB7XG4gICAgICAgICAgICByZWplY3QoeyBlcnJvcjogXCJ3cm9uZyBjcmVkZW50aWFsc1wiIH0pO1xuICAgICAgICB9KTtcbiAgICB9KTtcbn1cblxuZnVuY3Rpb24gYXV0aG9yaXplc29ja2V0KHByb2ZpbGUpOiB7fSB7XG4gICAgcmV0dXJuIGp3dC5zaWduKHByb2ZpbGUsIGNvbmYuc2VjcmV0LCB7IGV4cGlyZXNJbk1pbnV0ZXM6IDYwICogNSB9KTtcbn1cblxuYXBwLnBvc3QoXCIvbG9naW5cIiwgZnVuY3Rpb24ocmVxLCByZXMpIHtcbiAgICBhdXRoY291Y2gocmVxLmJvZHkudXNlciwgcmVxLmJvZHkucGFzc3dvcmQsIHJlcS5ib2R5LmRiKS50aGVuKGZ1bmN0aW9uKCkge1xuXG4gICAgICAgIGxldCB0b2tlbiA9IGF1dGhvcml6ZXNvY2tldCh7IHVzZXI6IHJlcS5ib2R5LnVzZXIsIHBhc3N3b3JkOiByZXEuYm9keS5wYXNzd29yZCwgZGI6IHJlcS5ib2R5LmRiLCBzZXJpYWw6IHJlcS5ib2R5LnNlcmlhbCB9KTtcblxuICAgICAgICByZXMuanNvbih7IHN1Y2Nlc3M6IHRydWUsIHRva2VuOiB0b2tlbiB9KTtcbiAgICB9KS5jYXRjaChmdW5jdGlvbihlcnIpIHtcbiAgICAgICAgcmVzLmpzb24oZXJyKTtcbiAgICB9KTtcbn0pO1xuXG5hcHAuZ2V0KFwiL2lwXCIsIGZ1bmN0aW9uKHJlcSwgcmVzKSB7XG4gICAgcmVzLmpzb24oeyBpcDogcmVxLmhlYWRlcnNbXCJ4LWZvcndhcmRlZC1mb3JcIl0gfSk7XG59KTtcblxuYXBwLmdldChcIi9zb2NrZXRzXCIsIGZ1bmN0aW9uKHJlcSwgcmVzKSB7XG4gICAgcmVzLmpzb24oTWFjaGluZXMuc29ja2V0cygpKTtcbn0pO1xuYXBwLmdldChcIi9tYWNoaW5lcy86c2VyaWFsL3NvY2tldHNcIiwgZnVuY3Rpb24ocmVxLCByZXMpIHtcbiAgICByZXMuanNvbihNYWNoaW5lcy5zb2NrZXRzKHJlcS5wYXJhbXMuc2VyaWFsKSk7XG59KTtcbmFwcC5nZXQoXCIvbWFjaGluZXNcIiwgZnVuY3Rpb24ocmVxLCByZXMpIHtcbiAgICByZXMuanNvbihNYWNoaW5lcy5saXN0KCkpO1xufSk7XG5hcHAuZ2V0KFwiL2FwcC86YXBwL21hY2hpbmVzXCIsIGZ1bmN0aW9uKHJlcSwgcmVzKSB7XG4gICAgLy8gcmVzLmpzb24oTWFjaGluZXMuc2VyaWFscygpKVxufSk7XG5cbmFwcC5nZXQoXCIvbWFjaGluZXMvOnNlcmlhbC9tZXNzYWdlLzptZXNzYWdlXCIsIGZ1bmN0aW9uKHJlcSwgcmVzKSB7XG4gICAgXy5tYXAoTWFjaGluZXMuaW9zKHJlcS5wYXJhbXMuc2VyaWFsKSwgZnVuY3Rpb24oc29ja2V0KSB7XG4gICAgICAgIHNvY2tldC5lbWl0KFwibWVzc2FnZVwiLCByZXEucGFyYW1zLm1lc3NhZ2UpO1xuXG4gICAgfSk7XG4gICAgcmVzLmpzb24oe30pO1xuXG59KTtcblxuYXBwLnBvc3QoXCIvbWFjaGluZXMvOnNlcmlhbC9tZXNzYWdlXCIsIGZ1bmN0aW9uKHJlcSwgcmVzKSB7XG4gICAgXy5tYXAoTWFjaGluZXMubGlzdChyZXEucGFyYW1zLnNlcmlhbCksIGZ1bmN0aW9uKHNvY2tldGlkKSB7XG4gICAgICAgIGlvLnRvKHNvY2tldGlkKS5lbWl0KFwibWVzc2FnZVwiLCByZXEuYm9keS5kYXRhKTtcbiAgICB9KTtcblxufSk7XG5hcHAucG9zdChcIi9tYWNoaW5lcy86c2VyaWFsL2RhdGFcIiwgZnVuY3Rpb24ocmVxLCByZXMpIHtcbiAgICBfLm1hcChNYWNoaW5lcy5saXN0KHJlcS5wYXJhbXMuc2VyaWFsKSwgZnVuY3Rpb24oc29ja2V0aWQpIHtcbiAgICAgICAgaW8udG8oc29ja2V0aWQpLmVtaXQoXCJkYXRhXCIsIHJlcS5ib2R5LmRhdGEpO1xuICAgIH0pO1xufSk7XG5hcHAucG9zdChcIi9tYWNoaW5lcy86c2VyaWFsL2V4ZWNcIiwgZnVuY3Rpb24ocmVxLCByZXMpIHtcbiAgICBfLm1hcChNYWNoaW5lcy5saXN0KHJlcS5wYXJhbXMuc2VyaWFsKSwgZnVuY3Rpb24oc29ja2V0aWQpIHtcbiAgICAgICAgaW8udG8oc29ja2V0aWQpLmVtaXQoXCJleGVjXCIsIHJlcS5ib2R5LmRhdGEpO1xuICAgIH0pO1xufSk7XG5hcHAucG9zdChcIi9tYWNoaW5lcy86c2VyaWFsL25wbVwiLCBmdW5jdGlvbihyZXEsIHJlcykge1xuICAgIF8ubWFwKE1hY2hpbmVzLmxpc3QocmVxLnBhcmFtcy5zZXJpYWwpLCBmdW5jdGlvbihzb2NrZXRpZCkge1xuICAgICAgICBpby50byhzb2NrZXRpZCkuZW1pdChcIm5wbVwiLCByZXEuYm9keS5kYXRhKTtcbiAgICB9KTtcbn0pO1xuYXBwLnBvc3QoXCIvbWFjaGluZXMvOnNlcmlhbC90YXNrXCIsIGZ1bmN0aW9uKHJlcSwgcmVzKSB7XG4gICAgXy5tYXAoTWFjaGluZXMubGlzdChyZXEucGFyYW1zLnNlcmlhbCksIGZ1bmN0aW9uKHNvY2tldGlkKSB7XG4gICAgICAgIGlvLnRvKHNvY2tldGlkKS5lbWl0KFwidGFza1wiLCByZXEuYm9keS5kYXRhKTtcbiAgICB9KTtcbn0pO1xuXG5pby5vbihcImNvbm5lY3Rpb25cIiwgZnVuY3Rpb24oc29ja2V0OiBJU29ja2V0KSB7XG4gICAgbGV0IGMgPSBzb2NrZXQuZGVjb2RlZF90b2tlbjtcblxuICAgIGlmIChjLmRiKSB7XG4gICAgICAgIGNvbnNvbGUubG9nKGMuZGIpO1xuXG4gICAgICAgIE1hY2hpbmVzLmFkZChjLnVzZXIsIGMucGFzc3dvcmQsIGMuZGIsIGMuc2VyaWFsLCBzb2NrZXQpO1xuICAgICAgICBfLm1hcChBdWRpdG9ycy5mb3JzZXJpYWwoYy5zZXJpYWwpLCBmdW5jdGlvbihzb2NrZXRpZCkge1xuICAgICAgICAgICAgaW8udG8oc29ja2V0aWQpLmVtaXQoXCJtYWNoaW5lIGNvbm5lY3Rpb25cIiwgeyBzZXJpYWw6IGMuc2VyaWFsIH0pO1xuICAgICAgICB9KTtcblxuICAgICAgICBzb2NrZXQub24oXCJkaXNjb25uZWN0XCIsIGZ1bmN0aW9uKCkge1xuXG4gICAgICAgICAgICBfLm1hcChBdWRpdG9ycy5mb3JzZXJpYWwoYy5zZXJpYWwpLCBmdW5jdGlvbihzb2NrZXRpZCkge1xuICAgICAgICAgICAgICAgIGlvLnRvKHNvY2tldGlkKS5lbWl0KFwibWFjaGluZSBkaXNjb25uZWN0aW9uXCIsIHsgc2VyaWFsOiBjLnNlcmlhbCB9KTtcbiAgICAgICAgICAgIH0pO1xuXG4gICAgICAgICAgICBNYWNoaW5lcy5yZW1vdmUoYy5zZXJpYWwsIHNvY2tldC5pZCk7XG4gICAgICAgIH0pO1xuICAgICAgICBzb2NrZXQub24oXCJtZXNzYWdlXCIsIGZ1bmN0aW9uKG1lc3NhZ2UpIHtcbiAgICAgICAgICAgIE1hY2hpbmVzLnB1c2hkYXRhKGMuc2VyaWFsLCBcIm1lc3NhZ2VcIiwgbWVzc2FnZSkudGhlbihmdW5jdGlvbihkb2NzKSB7XG5cbiAgICAgICAgICAgICAgICBfLm1hcChBdWRpdG9ycy5mb3JzZXJpYWwoYy5zZXJpYWwpLCBmdW5jdGlvbihzb2NrZXRpZCkge1xuICAgICAgICAgICAgICAgICAgICBpby50byhzb2NrZXRpZCkuZW1pdChcIm1hY2hpbmUgbWVzc2FnZVwiLCB7IHNlcmlhbDogYy5zZXJpYWwsIGRhdGE6IG1lc3NhZ2UgfSk7XG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfSk7XG4gICAgICAgIHNvY2tldC5vbihcImRhdGFcIiwgZnVuY3Rpb24oZGF0YSkge1xuICAgICAgICAgICAgTWFjaGluZXMucHVzaGRhdGEoYy5zZXJpYWwsIFwiZGF0YVwiLCBkYXRhKS50aGVuKGZ1bmN0aW9uKGRvY3MpIHtcblxuICAgICAgICAgICAgICAgIF8ubWFwKEF1ZGl0b3JzLmZvcnNlcmlhbChjLnNlcmlhbCksIGZ1bmN0aW9uKHNvY2tldGlkKSB7XG4gICAgICAgICAgICAgICAgICAgIGlvLnRvKHNvY2tldGlkKS5lbWl0KFwibWFjaGluZSBkYXRhXCIsIHsgc2VyaWFsOiBjLnNlcmlhbCwgZGF0YTogZGF0YSB9KTtcbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9KTtcbiAgICAgICAgc29ja2V0Lm9uKFwiZG9jc1wiLCBmdW5jdGlvbihkb2NzKSB7XG4gICAgICAgICAgICBNYWNoaW5lcy5wdXNoZGF0YShjLnNlcmlhbCwgXCJkb2NzXCIsIGRvY3MpLnRoZW4oZnVuY3Rpb24oZG9jcykge1xuICAgICAgICAgICAgICAgIF8ubWFwKEF1ZGl0b3JzLmZvcnNlcmlhbChjLnNlcmlhbCksIGZ1bmN0aW9uKHNvY2tldGlkKSB7XG4gICAgICAgICAgICAgICAgICAgIGlvLnRvKHNvY2tldGlkKS5lbWl0KFwibWFjaGluZSBkb2NzXCIsIHsgc2VyaWFsOiBjLnNlcmlhbCwgZGF0YTogZG9jcyB9KTtcbiAgICAgICAgICAgICAgICB9KTtcblxuICAgICAgICAgICAgfSk7XG4gICAgICAgIH0pO1xuICAgICAgICBzb2NrZXQub24oXCJ1cFwiLCBmdW5jdGlvbihkYXRhcykge1xuICAgICAgICAgICAgXy5tYXAoQXVkaXRvcnMuZm9yc2VyaWFsKGMuc2VyaWFsKSwgZnVuY3Rpb24oc29ja2V0aWQpIHtcbiAgICAgICAgICAgICAgICBpby50byhzb2NrZXRpZCkuZW1pdChcIm1hY2hpbmUgdXBcIiwgeyBzZXJpYWw6IGMuc2VyaWFsIH0pO1xuICAgICAgICAgICAgfSk7XG4gICAgICAgIH0pO1xuXG4gICAgfSBlbHNlIHtcbiAgICAgICAgQXVkaXRvcnMuYWRkKGMuc2VyaWFscywgc29ja2V0LmlkKTtcbiAgICAgICAgc29ja2V0Lm9uKFwiZGlzY29ubmVjdFwiLCBmdW5jdGlvbigpIHtcbiAgICAgICAgICAgIEF1ZGl0b3JzLnJlbW92ZShzb2NrZXQuaWQpO1xuICAgICAgICB9KTtcblxuICAgIH1cblxuICAgIGNvbnNvbGUubG9nKFwiaGVsbG8hIFwiLCBzb2NrZXQuaWQpO1xufSk7XG4iXSwic291cmNlUm9vdCI6Ii9zb3VyY2UvIn0=
