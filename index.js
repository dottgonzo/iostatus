var net = require("net");
var _ = require("lodash");
var Promise = require("bluebird");
var bodyParser = require("body-parser");
var pathExists = require("path-exists");
var IO = require("socket.io");
var express = require("express");
var jwt = require("jsonwebtoken");
var couchjsonconf = require("couchjsonconf");
var machClients = require("./modules/machClients");
var audClients = require("./modules/audClients");
var socketioJwt = require("socketio-jwt");
var rpj = require('request-promise-json');
var aedes = require("aedes");
var app = express();
var server = require('http').Server(app);
var io = IO(server);
if (!pathExists.sync('./conf.json')) {
    throw Error('no configuration founded');
}
var conf = require('./conf.json');
var COUCHDB = new couchjsonconf(conf.couchdb);
var Machines = new machClients(COUCHDB);
var Auditors = new audClients();
app.use(bodyParser.urlencoded({ extended: false }));
app.use(bodyParser.json());
io.use(socketioJwt.authorize({
    secret: conf.secret,
    handshake: true
}));
server.listen(conf.port);
var Aedes = aedes();
var Aserver = net.createServer(Aedes.handle);
Aserver.listen(1883, function () {
    console.log('MQTT server listening on port', 1883);
});
Aedes.authenticate = function (client, username, token, callback) {
    if (conf.admin.username == username) {
        if (token == conf.admin.password) {
            callback(null, true);
        }
        else {
            console.log("unauthorized " + username);
            callback(null);
        }
    }
    else {
        try {
            var decoded = jwt.verify(JSON.parse(token + ""), conf.secret, { ignoreExpiration: true });
            var db = decoded.db;
            var password = decoded.password;
            console.log("auth");
            console.log(username);
            console.log(password);
            console.log(db);
            authcouch(username, password, db).then(function () {
                console.log("authorized " + username);
                client.couch = { username: username, password: password, db: db };
                callback(null, true);
            }).catch(function () {
                console.log("unauthorized " + username);
                callback(null);
            });
        }
        catch (err) {
            console.log("unauthorized " + username);
            callback(null);
        }
    }
};
Aedes.on('client', function (client) {
    console.log("new client" + client.id);
    console.log(client.couch);
});
Aedes.on('clientDisconnect', function (client) {
    console.log("clientDisconnect");
});
Aedes.on('subscribe', function (topic, client) {
    console.log("subscribe");
});
Aedes.on('unsubscribe', function (topic, client) {
    console.log("unsubscribe");
});
Aedes.on('publish', function (packet, client) {
    if (!client)
        return;
    var obj = JSON.parse(packet.payload.toString());
    console.log("publish");
    if (packet.topic.split("/").length > 1 && packet.topic.split("/")[0] == "data" && client.couch && client.couch && client.couch.username) {
        console.log("save");
        rpj.get("http://" + client.couch.username + ":" + client.couch.password + "@192.168.122.44:5984/" + client.couch.db + '/' + obj._id).then(function (d) {
            obj._rev = d._rev;
            rpj.put("http://" + client.couch.username + ":" + client.couch.password + "@192.168.122.44:5984/" + client.couch.db + '/' + obj._id, obj).then(function () {
                console.log("backup");
            }).catch(function (err) {
                console.log("save error " + err);
            });
        }).catch(function (err) {
            if (err.statusCode == 404) {
                rpj.put("http://" + client.couch.username + ":" + client.couch.password + "@192.168.122.44:5984/" + client.couch.db + '/' + obj._id, obj).then(function () {
                    console.log("backup");
                }).catch(function (err) {
                    console.log("save error " + err);
                });
            }
            else {
                console.log(err);
            }
        });
    }
});
app.get('/', function (req, res) {
    res.json({ online: true });
});
function authcouch(user, password, db) {
    return new Promise(function (resolve, reject) {
        rpj.get(COUCHDB.for(user, password, db)).then(function () {
            resolve({ success: true });
        }).catch(function (err) {
            reject({ error: 'wrong credentials' });
        });
    });
}
function authorizesocket(profile) {
    return jwt.sign(profile, conf.secret, { expiresInMinutes: 60 * 5 });
}
app.post('/login', function (req, res) {
    authcouch(req.body.user, req.body.password, req.body.db).then(function () {
        var token = authorizesocket({ user: req.body.user, password: req.body.password, db: req.body.db, serial: req.body.serial });
        res.json({ success: true, token: token });
    }).catch(function (err) {
        res.json(err);
    });
});
app.get('/ip', function (req, res) {
    res.json({ ip: req.headers['x-forwarded-for'] });
});
app.get('/sockets', function (req, res) {
    res.json(Machines.sockets());
});
app.get('/machines/:serial/sockets', function (req, res) {
    res.json(Machines.sockets(req.params.serial));
});
app.get('/machines', function (req, res) {
    res.json(Machines.list());
});
app.get('/app/:app/machines', function (req, res) {
});
app.get('/machines/:serial/message/:message', function (req, res) {
    _.map(Machines.ios(req.params.serial), function (socket) {
        socket.emit('message', req.params.message);
    });
    res.json({});
});
app.post('/machines/:serial/message', function (req, res) {
    _.map(Machines.list(req.params.serial), function (socketid) {
        io.to(socketid).emit('message', req.body.data);
    });
});
app.post('/machines/:serial/data', function (req, res) {
    _.map(Machines.list(req.params.serial), function (socketid) {
        io.to(socketid).emit('data', req.body.data);
    });
});
app.post('/machines/:serial/exec', function (req, res) {
    _.map(Machines.list(req.params.serial), function (socketid) {
        io.to(socketid).emit('exec', req.body.data);
    });
});
app.post('/machines/:serial/npm', function (req, res) {
    _.map(Machines.list(req.params.serial), function (socketid) {
        io.to(socketid).emit('npm', req.body.data);
    });
});
app.post('/machines/:serial/task', function (req, res) {
    _.map(Machines.list(req.params.serial), function (socketid) {
        io.to(socketid).emit('task', req.body.data);
    });
});
io.on('connection', function (socket) {
    var c = socket.decoded_token;
    if (c.db) {
        console.log(c.db);
        Machines.add(c.user, c.password, c.db, c.serial, socket);
        _.map(Auditors.forserial(c.serial), function (socketid) {
            io.to(socketid).emit('machine connection', { serial: c.serial });
        });
        socket.on('disconnect', function () {
            _.map(Auditors.forserial(c.serial), function (socketid) {
                io.to(socketid).emit('machine disconnection', { serial: c.serial });
            });
            Machines.remove(c.serial, socket.id);
        });
        socket.on('message', function (message) {
            Machines.pushdata(c.serial, 'message', message).then(function (docs) {
                _.map(Auditors.forserial(c.serial), function (socketid) {
                    io.to(socketid).emit('machine message', { serial: c.serial, data: message });
                });
            });
        });
        socket.on('data', function (data) {
            Machines.pushdata(c.serial, 'data', data).then(function (docs) {
                _.map(Auditors.forserial(c.serial), function (socketid) {
                    io.to(socketid).emit('machine data', { serial: c.serial, data: data });
                });
            });
        });
        socket.on('docs', function (docs) {
            Machines.pushdata(c.serial, 'docs', docs).then(function (docs) {
                _.map(Auditors.forserial(c.serial), function (socketid) {
                    io.to(socketid).emit('machine docs', { serial: c.serial, data: docs });
                });
            });
        });
        socket.on('up', function (datas) {
            _.map(Auditors.forserial(c.serial), function (socketid) {
                io.to(socketid).emit('machine up', { serial: c.serial });
            });
        });
    }
    else {
        Auditors.add(c.serials, socket.id);
        socket.on('disconnect', function () {
            Auditors.remove(socket.id);
        });
    }
    console.log('hello! ', socket.id);
});

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImluZGV4LnRzIl0sIm5hbWVzIjpbImF1dGhjb3VjaCIsImF1dGhvcml6ZXNvY2tldCJdLCJtYXBwaW5ncyI6IkFBQUEsSUFBWSxHQUFHLFdBQU0sS0FBSyxDQUFDLENBQUE7QUFDM0IsSUFBWSxDQUFDLFdBQU0sUUFBUSxDQUFDLENBQUE7QUFDNUIsSUFBWSxPQUFPLFdBQU0sVUFBVSxDQUFDLENBQUE7QUFDcEMsSUFBWSxVQUFVLFdBQU0sYUFBYSxDQUFDLENBQUE7QUFDMUMsSUFBWSxVQUFVLFdBQU0sYUFBYSxDQUFDLENBQUE7QUFDMUMsSUFBWSxFQUFFLFdBQU0sV0FBVyxDQUFDLENBQUE7QUFDaEMsSUFBWSxPQUFPLFdBQU0sU0FBUyxDQUFDLENBQUE7QUFDbkMsSUFBWSxHQUFHLFdBQU0sY0FBYyxDQUFDLENBQUE7QUFHcEMsSUFBTyxhQUFhLFdBQVcsZUFBZSxDQUFDLENBQUM7QUFFaEQsSUFBTyxXQUFXLFdBQVcsdUJBQXVCLENBQUMsQ0FBQztBQUN0RCxJQUFPLFVBQVUsV0FBVyxzQkFBc0IsQ0FBQyxDQUFDO0FBRXBELElBQUksV0FBVyxHQUFHLE9BQU8sQ0FBQyxjQUFjLENBQUMsQ0FBQztBQUMxQyxJQUFJLEdBQUcsR0FBRyxPQUFPLENBQUMsc0JBQXNCLENBQUMsQ0FBQztBQUMxQyxJQUFJLEtBQUssR0FBRyxPQUFPLENBQUMsT0FBTyxDQUFDLENBQUM7QUFHN0IsSUFBSSxHQUFHLEdBQUcsT0FBTyxFQUFFLENBQUM7QUFDcEIsSUFBSSxNQUFNLEdBQUcsT0FBTyxDQUFDLE1BQU0sQ0FBQyxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsQ0FBQztBQUN6QyxJQUFJLEVBQUUsR0FBRyxFQUFFLENBQUMsTUFBTSxDQUFDLENBQUM7QUFNcEIsRUFBRSxDQUFDLENBQUMsQ0FBQyxVQUFVLENBQUMsSUFBSSxDQUFDLGFBQWEsQ0FBQyxDQUFDLENBQUMsQ0FBQztJQUNsQyxNQUFNLEtBQUssQ0FBQywwQkFBMEIsQ0FBQyxDQUFBO0FBQzNDLENBQUM7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QU0sQ0FBQztJQUVwQixJQUFJLEdBQUcsR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDLE1BQU0sQ0FBQyxPQUFPLENBQUMsUUFBUSxFQUFFLENBQUMsQ0FBQztJQUNoRCxPQUFPLENBQUMsR0FBRyxDQUFDLFNBQVMsQ0FBQyxDQUFDO0lBRXZCLEVBQUUsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxLQUFLLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxDQUFDLE1BQU0sR0FBRyxDQUFDLElBQUksTUFBTSxDQUFDLEtBQUssQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDLElBQUksTUFBTSxJQUFJLE1BQU0sQ0FBQyxLQUFLLElBQUksTUFBTSxDQUFDLEtBQUssSUFBSSxNQUFNLENBQUMsS0FBSyxDQUFDLFFBQVEsQ0FBQyxDQUFDLENBQUM7UUFFdEksT0FBTyxDQUFDLEdBQUcsQ0FBQyxNQUFNLENBQUMsQ0FBQztRQUNwQixHQUFHLENBQUMsR0FBRyxDQUFDLFNBQVMsR0FBRyxNQUFNLENBQUMsS0FBSyxDQUFDLFFBQVEsR0FBRyxHQUFHLEdBQUcsTUFBTSxDQUFDLEtBQUssQ0FBQyxRQUFRLEdBQUcsdUJBQXVCLEdBQUcsTUFBTSxDQUFDLEtBQUssQ0FBQyxFQUFFLEdBQUcsR0FBRyxHQUFHLEdBQUcsQ0FBQyxHQUFHLENBQUMsQ0FBQyxJQUFJLENBQUMsVUFBUyxDQUFDO1lBQ2hKLEdBQUcsQ0FBQyxJQUFJLEdBQUcsQ0FBQyxDQUFDLElBQUksQ0FBQztZQUNsQixHQUFHLENBQUMsR0FBRyxDQUFDLFNBQVMsR0FBRyxNQUFNLENBQUMsS0FBSyxDQUFDLFFBQVEsR0FBRyxHQUFHLEdBQUcsTUFBTSxDQUFDLEtBQUssQ0FBQyxRQUFRLEdBQUcsdUJBQXVCLEdBQUcsTUFBTSxDQUFDLEtBQUssQ0FBQyxFQUFFLEdBQUcsR0FBRyxHQUFHLEdBQUcsQ0FBQyxHQUFHLEVBQUUsR0FBRyxDQUFDLENBQUMsSUFBSSxDQUFDO2dCQUMzSSxPQUFPLENBQUMsR0FBRyxDQUFDLFFBQVEsQ0FBQyxDQUFD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QUMsQ0FBQyxHQUFHLENBQUMsUUFBUSxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsTUFBTSxDQUFDLE1BQU0sQ0FBQyxFQUFFLFVBQVMsUUFBUTtRQUNyRCxFQUFFLENBQUMsRUFBRSxDQUFDLFFBQVEsQ0FBQyxDQUFDLElBQUksQ0FBQyxNQUFNLEVBQUUsR0FBRyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQztJQUNoRCxDQUFDLENBQUMsQ0FBQTtBQUNOLENBQUMsQ0FBQyxDQUFDO0FBQ0gsR0FBRyxDQUFDLElBQUksQ0FBQyx1QkFBdUIsRUFBRSxVQUFTLEdBQUcsRUFBRSxHQUFHO0lBQy9DLENBQUMsQ0FBQyxHQUFHLENBQUMsUUFBUSxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsTUFBTSxDQUFDLE1BQU0sQ0FBQyxFQUFFLFVBQVMsUUFBUTtRQUNyRCxFQUFFLENBQUMsRUFBRSxDQUFDLFFBQVEsQ0FBQyxDQUFDLElBQUksQ0FBQyxLQUFLLEVBQUUsR0FBRyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQztJQUMvQyxDQUFDLENBQUMsQ0FBQTtBQUNOLENBQUMsQ0FBQyxDQUFDO0FBQ0gsR0FBRyxDQUFDLElBQUksQ0FBQyx3QkFBd0IsRUFBRSxVQUFTLEdBQUcsRUFBRSxHQUFHO0lBQ2hELENBQUMsQ0FBQyxHQUFHLENBQUMsUUFBUSxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsTUFBTSxDQUFDLE1BQU0sQ0FBQyxFQUFFLFVBQVMsUUFBUTtRQUNyRCxFQUFFLENBQUMsRUFBRSxDQUFDLFFBQVEsQ0FBQyxDQUFDLElBQUksQ0FBQyxNQUFNLEVBQUUsR0FBRyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQztJQUNoRCxDQUFDLENBQUMsQ0FBQTtBQUNOLENBQUMsQ0FBQyxDQUFDO0FBRUgsRUFBRSxDQUFDLEVBQUUsQ0FBQyxZQUFZLEVBQUUsVUFBUyxNQUFlO0lBQ3hDLElBQUksQ0FBQyxHQUFHLE1BQU0sQ0FBQyxhQUFhLENBQUM7SUFFN0IsRUFBRSxDQUFDLENBQUMsQ0FB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LENBQUMsUUFBUSxDQUFDLENBQUMsSUFBSSxDQUFDLGNBQWMsRUFBRSxFQUFFLE1BQU0sRUFBRSxDQUFDLENBQUMsTUFBTSxFQUFFLElBQUksRUFBRSxJQUFJLEVBQUUsQ0FBQyxDQUFDO2dCQUMzRSxDQUFDLENBQUMsQ0FBQTtZQUVOLENBQUMsQ0FBQyxDQUFBO1FBQ04sQ0FBQyxDQUFDLENBQUM7UUFDSCxNQUFNLENBQUMsRUFBRSxDQUFDLElBQUksRUFBRSxVQUFTLEtBQUs7WUFDMUIsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxRQUFRLENBQUMsU0FBUyxDQUFDLENBQUMsQ0FBQyxNQUFNLENBQUMsRUFBRSxVQUFTLFFBQVE7Z0JBQ2pELEVBQUUsQ0FBQyxFQUFFLENBQUMsUUFBUSxDQUFDLENBQUMsSUFBSSxDQUFDLFlBQVksRUFBRSxFQUFFLE1BQU0sRUFBRSxDQUFDLENBQUMsTUFBTSxFQUFFLENBQUMsQ0FBQztZQUM3RCxDQUFDLENBQUMsQ0FBQTtRQUNOLENBQUMsQ0FBQyxDQUFBO0lBRU4sQ0FBQztJQUFDLElBQUksQ0FBQyxDQUFDO1FBQ0osUUFBUSxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsT0FBTyxFQUFFLE1BQU0sQ0FBQyxFQUFFLENBQUMsQ0FBQTtRQUNsQyxNQUFNLENBQUMsRUFBRSxDQUFDLFlBQVksRUFBRTtZQUNwQixRQUFRLENBQUMsTUFBTSxDQUFDLE1BQU0sQ0FBQyxFQUFFLENBQUMsQ0FBQTtRQUM5QixDQUFDLENBQUMsQ0FBQztJQUVQLENBQUM7SUFFRCxPQUFPLENBQUMsR0FBRyxDQUFDLFNBQVMsRUFBRSxNQUFNLENBQUMsRUFBRSxDQUFDLENBQUM7QUFDdEMsQ0FBQyxDQUFDLENBQUMiLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgKiBhcyBuZXQgZnJvbSBcIm5ldFwiO1xuaW1wb3J0ICogYXMgXyBmcm9tIFwibG9kYXNoXCI7XG5pbXBvcnQgKiBhcyBQcm9taXNlIGZyb20gXCJibHVlYmlyZFwiO1xuaW1wb3J0ICogYXMgYm9keVBhcnNlciBmcm9tIFwiYm9keS1wYXJzZXJcIjtcbmltcG9ydCAqIGFzIHBhdGhFeGlzdHMgZnJvbSBcInBhdGgtZXhpc3RzXCI7XG5pbXBvcnQgKiBhcyBJTyBmcm9tIFwic29ja2V0LmlvXCI7XG5pbXBvcnQgKiBhcyBleHByZXNzIGZyb20gXCJleHByZXNzXCI7XG5pbXBvcnQgKiBhcyBqd3QgZnJvbSBcImpzb253ZWJ0b2tlblwiO1xuaW1wb3J0ICogYXMgcmVkaXMgZnJvbSBcInJlZGlzXCI7XG5cbmltcG9ydCBjb3VjaGpzb25jb25mID0gcmVxdWlyZShcImNvdWNoanNvbmNvbmZcIik7XG5cbmltcG9ydCBtYWNoQ2xpZW50cyA9IHJlcXVpcmUoXCIuL21vZHVsZXMvbWFjaENsaWVudHNcIik7XG5pbXBvcnQgYXVkQ2xpZW50cyA9IHJlcXVpcmUoXCIuL21vZHVsZXMvYXVkQ2xpZW50c1wiKTtcblxubGV0IHNvY2tldGlvSnd0ID0gcmVxdWlyZShcInNvY2tldGlvLWp3dFwiKTtcbmxldCBycGogPSByZXF1aXJlKCdyZXF1ZXN0LXByb21pc2UtanNvbicpO1xubGV0IGFlZGVzID0gcmVxdWlyZShcImFlZGVzXCIpO1xuXG5cbmxldCBhcHAgPSBleHByZXNzKCk7XG5sZXQgc2VydmVyID0gcmVxdWlyZSgnaHR0cCcpLlNlcnZlcihhcHApO1xubGV0IGlvID0gSU8oc2VydmVyKTtcblxuXG5cblxuXG5pZiAoIXBhdGhFeGlzdHMuc3luYygnLi9jb25mLmpzb24nKSkge1xuICAgIHRocm93IEVycm9yKCdubyBjb25maWd1cmF0aW9uIGZvdW5kZWQnKVxufVxubGV0IGNvbmYgPSByZXF1aXJlKCcuL2NvbmYuanNvbicpXG5cbmxldCBDT1VDSERCID0gbmV3IGNvdWNoanNvbmNvbmYoY29uZi5jb3VjaGRiKVxuXG5sZXQgTWFjaGluZXMgPSBuZXcgbWFjaENsaWVudHMoQ09VQ0hEQik7XG5sZXQgQXVkaXRvcnMgPSBuZXcgYXVkQ2xpZW50cygpO1xuXG4vLyBwYXJzZSBhcHBsaWNhdGlvbi94LXd3dy1mb3JtLXVybGVuY29kZWRcbmFwcC51c2UoYm9keVBhcnNlci51cmxlbmNvZGVkKHsgZXh0ZW5kZWQ6IGZhbHNlIH0pKVxuXG4vLyBwYXJzZSBhcHBsaWNhdGlvbi9qc29uXG5hcHAudXNlKGJvZHlQYXJzZXIuanNvbigpKVxuXG5cblxuaW8udXNlKHNvY2tldGlvSnd0LmF1dGhvcml6ZSh7XG4gICAgc2VjcmV0OiBjb25mLnNlY3JldCxcbiAgICBoYW5kc2hha2U6IHRydWVcbn0pKTtcblxuc2VydmVyLmxpc3Rlbihjb25mLnBvcnQpO1xuXG5cbmxldCBBZWRlcyA9IGFlZGVzKCk7XG5sZXQgQXNlcnZlciA9IG5ldC5jcmVhdGVTZXJ2ZXIoQWVkZXMuaGFuZGxlKTtcblxuQXNlcnZlci5saXN0ZW4oMTg4MywgZnVuY3Rpb24oKSB7XG4gICAgY29uc29sZS5sb2coJ01RVFQgc2VydmVyIGxpc3RlbmluZyBvbiBwb3J0JywgMTg4Mylcbn0pO1xuXG5cbkFlZGVzLmF1dGhlbnRpY2F0ZSA9IGZ1bmN0aW9uKGNsaWVudCwgdXNlcm5hbWUsIHRva2VuLCBjYWxsYmFjaykge1xuXG5cbiAgICBpZiAoY29uZi5hZG1pbi51c2VybmFtZSA9PSB1c2VybmFtZSkge1xuXG4gICAgICAgIGlmICh0b2tlbiA9PSBjb25mLmFkbWluLnBhc3N3b3JkKSB7XG4gICAgICAgICAgICBjYWxsYmFjayhudWxsLCB0cnVlKVxuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgY29uc29sZS5sb2coXCJ1bmF1dGhvcml6ZWQgXCIgKyB1c2VybmFtZSlcbiAgICAgICAgICAgIGNhbGxiYWNrKG51bGwpXG4gICAgICAgIH1cblxuXG4gICAgfSBlbHNlIHtcblxuICAgICAgICB0cnkge1xuXG5cblxuICAgICAgICAgICAgbGV0IGRlY29kZWQ6IGFueSA9IGp3dC52ZXJpZnkoSlNPTi5wYXJzZSh0b2tlbiArIFwiXCIpLCBjb25mLnNlY3JldCwgeyBpZ25vcmVFeHBpcmF0aW9uOiB0cnVlIH0pOyAvLyB0byBiZSBjaGFuZ2VkIGluIHZlcmlmeVxuICAgICAgICAgICAgbGV0IGRiID0gZGVjb2RlZC5kYjtcbiAgICAgICAgICAgIGxldCBwYXNzd29yZCA9IGRlY29kZWQucGFzc3dvcmQ7XG4gICAgICAgICAgICBjb25zb2xlLmxvZyhcImF1dGhcIik7XG4gICAgICAgICAgICBjb25zb2xlLmxvZyh1c2VybmFtZSk7XG4gICAgICAgICAgICBjb25zb2xlLmxvZyhwYXNzd29yZCk7XG4gICAgICAgICAgICBjb25zb2xlLmxvZyhkYik7XG4gICAgICAgICAgICAvLyBcbiAgICAgICAgICAgIGF1dGhjb3VjaCh1c2VybmFtZSwgcGFzc3dvcmQsIGRiKS50aGVuKGZ1bmN0aW9uKCkge1xuICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKFwiYXV0aG9yaXplZCBcIiArIHVzZXJuYW1lKVxuICAgICAgICAgICAgICAgIGNsaWVudC5jb3VjaCA9IHsgdXNlcm5hbWU6IHVzZXJuYW1lLCBwYXNzd29yZDogcGFzc3dvcmQsIGRiOiBkYiB9XG4gICAgICAgICAgICAgICAgY2FsbGJhY2sobnVsbCwgdHJ1ZSlcbiAgICAgICAgICAgIH0pLmNhdGNoKGZ1bmN0aW9uKCkge1xuICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKFwidW5hdXRob3JpemVkIFwiICsgdXNlcm5hbWUpXG4gICAgICAgICAgICAgICAgY2FsbGJhY2sobnVsbClcbiAgICAgICAgICAgIH0pXG5cblxuICAgICAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKFwidW5hdXRob3JpemVkIFwiICsgdXNlcm5hbWUpXG4gICAgICAgICAgICBjYWxsYmFjayhudWxsKVxuICAgICAgICB9XG5cbiAgICB9XG5cbn1cblxuQWVkZXMub24oJ2NsaWVudCcsIGZ1bmN0aW9uKGNsaWVudCkge1xuXG5cbiAgICBjb25zb2xlLmxvZyhcIm5ldyBjbGllbnRcIiArIGNsaWVudC5pZClcblxuICAgIGNvbnNvbGUubG9nKGNsaWVudC5jb3VjaClcblxufSk7XG5cbkFlZGVzLm9uKCdjbGllbnREaXNjb25uZWN0JywgZnVuY3Rpb24oY2xpZW50KSB7XG4gICAgY29uc29sZS5sb2coXCJjbGllbnREaXNjb25uZWN0XCIpXG59KTtcblxuQWVkZXMub24oJ3N1YnNjcmliZScsIGZ1bmN0aW9uKHRvcGljLCBjbGllbnQpIHtcbiAgICBjb25zb2xlLmxvZyhcInN1YnNjcmliZVwiKVxufSk7XG5cbkFlZGVzLm9uKCd1bnN1YnNjcmliZScsIGZ1bmN0aW9uKHRvcGljLCBjbGllbnQpIHtcbiAgICBjb25zb2xlLmxvZyhcInVuc3Vic2NyaWJlXCIpXG59KTtcblxuQWVkZXMub24oJ3B1Ymxpc2gnLCBmdW5jdGlvbihwYWNrZXQsIGNsaWVudCkge1xuXG4gICAgaWYgKCFjbGllbnQpIHJldHVybjtcblxuICAgIGxldCBvYmogPSBKU09OLnBhcnNlKHBhY2tldC5wYXlsb2FkLnRvU3RyaW5nKCkpO1xuICAgIGNvbnNvbGUubG9nKFwicHVibGlzaFwiKTtcblxuICAgIGlmIChwYWNrZXQudG9waWMuc3BsaXQoXCIvXCIpLmxlbmd0aCA+IDEgJiYgcGFja2V0LnRvcGljLnNwbGl0KFwiL1wiKVswXSA9PSBcImRhdGFcIiAmJiBjbGllbnQuY291Y2ggJiYgY2xpZW50LmNvdWNoICYmIGNsaWVudC5jb3VjaC51c2VybmFtZSkge1xuICAgICAgICAvLyAgICBycGoucG9zdCgpXG4gICAgICAgIGNvbnNvbGUubG9nKFwic2F2ZVwiKTtcbiAgICAgICAgcnBqLmdldChcImh0dHA6Ly9cIiArIGNsaWVudC5jb3VjaC51c2VybmFtZSArIFwiOlwiICsgY2xpZW50LmNvdWNoLnBhc3N3b3JkICsgXCJAMTkyLjE2OC4xMjIuNDQ6NTk4NC9cIiArIGNsaWVudC5jb3VjaC5kYiArICcvJyArIG9iai5faWQpLnRoZW4oZnVuY3Rpb24oZCkge1xuICAgICAgICAgICAgb2JqLl9yZXYgPSBkLl9yZXY7XG4gICAgICAgICAgICBycGoucHV0KFwiaHR0cDovL1wiICsgY2xpZW50LmNvdWNoLnVzZXJuYW1lICsgXCI6XCIgKyBjbGllbnQuY291Y2gucGFzc3dvcmQgKyBcIkAxOTIuMTY4LjEyMi40NDo1OTg0L1wiICsgY2xpZW50LmNvdWNoLmRiICsgJy8nICsgb2JqLl9pZCwgb2JqKS50aGVuKGZ1bmN0aW9uKCkge1xuICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKFwiYmFja3VwXCIpO1xuICAgICAgICAgICAgfSkuY2F0Y2goZnVuY3Rpb24oZXJyKSB7XG4gICAgICAgICAgICAgICAgY29uc29sZS5sb2coXCJzYXZlIGVycm9yIFwiICsgZXJyKTtcbiAgICAgICAgICAgIH0pO1xuXG4gICAgICAgIH0pLmNhdGNoKGZ1bmN0aW9uKGVycikge1xuICAgICAgICAgICAgaWYgKGVyci5zdGF0dXNDb2RlID09IDQwNCkge1xuICAgICAgICAgICAgICAgIHJwai5wdXQoXCJodHRwOi8vXCIgKyBjbGllbnQuY291Y2gudXNlcm5hbWUgKyBcIjpcIiArIGNsaWVudC5jb3VjaC5wYXNzd29yZCArIFwiQDE5Mi4xNjguMTIyLjQ0OjU5ODQvXCIgKyBjbGllbnQuY291Y2guZGIgKyAnLycgKyBvYmouX2lkLCBvYmopLnRoZW4oZnVuY3Rpb24oKSB7XG4gICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKFwiYmFja3VwXCIpO1xuICAgICAgICAgICAgICAgIH0pLmNhdGNoKGZ1bmN0aW9uKGVycikge1xuICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhcInNhdmUgZXJyb3IgXCIgKyBlcnIpO1xuICAgICAgICAgICAgICAgIH0pO1xuXG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKGVycilcbiAgICAgICAgICAgIH1cblxuICAgICAgICB9KVxuXG5cbiAgICB9XG5cblxuXG5cbn0pO1xuXG5cbmludGVyZmFjZSBJU29ja2V0IHtcblxuICAgIGlkOiBzdHJpbmc7XG4gICAgZW1pdDogRnVuY3Rpb247XG4gICAgb246IEZ1bmN0aW9uO1xuICAgIGRlY29kZWRfdG9rZW46IHtcbiAgICAgICAgZGI6IHN0cmluZztcbiAgICAgICAgdXNlcjogc3RyaW5nO1xuICAgICAgICBwYXNzd29yZDogc3RyaW5nO1xuICAgICAgICBzZXJpYWw6IHN0cmluZztcbiAgICAgICAgc2VyaWFsczogc3RyaW5nW11cbiAgICB9XG59XG5cblxuXG5cbmFwcC5nZXQoJy8nLCBmdW5jdGlvbihyZXEsIHJlcykge1xuICAgIHJlcy5qc29uKHsgb25saW5lOiB0cnVlIH0pXG59KTtcblxuXG5cblxuZnVuY3Rpb24gYXV0aGNvdWNoKHVzZXI6IHN0cmluZywgcGFzc3dvcmQ6IHN0cmluZywgZGI6IHN0cmluZykge1xuICAgIHJldHVybiBuZXcgUHJvbWlzZShmdW5jdGlvbihyZXNvbHZlLCByZWplY3QpIHtcbiAgICAgICAgcnBqLmdldChDT1VDSERCLmZvcih1c2VyLCBwYXNzd29yZCwgZGIpKS50aGVuKGZ1bmN0aW9uKCkge1xuICAgICAgICAgICAgcmVzb2x2ZSh7IHN1Y2Nlc3M6IHRydWUgfSlcbiAgICAgICAgfSkuY2F0Y2goZnVuY3Rpb24oZXJyKSB7XG4gICAgICAgICAgICByZWplY3QoeyBlcnJvcjogJ3dyb25nIGNyZWRlbnRpYWxzJyB9KVxuICAgICAgICB9KVxuICAgIH0pXG59XG5cbmZ1bmN0aW9uIGF1dGhvcml6ZXNvY2tldChwcm9maWxlKToge30ge1xuICAgIHJldHVybiBqd3Quc2lnbihwcm9maWxlLCBjb25mLnNlY3JldCwgeyBleHBpcmVzSW5NaW51dGVzOiA2MCAqIDUgfSk7XG59XG5cbmFwcC5wb3N0KCcvbG9naW4nLCBmdW5jdGlvbihyZXEsIHJlcykge1xuICAgIGF1dGhjb3VjaChyZXEuYm9keS51c2VyLCByZXEuYm9keS5wYXNzd29yZCwgcmVxLmJvZHkuZGIpLnRoZW4oZnVuY3Rpb24oKSB7XG5cbiAgICAgICAgbGV0IHRva2VuID0gYXV0aG9yaXplc29ja2V0KHsgdXNlcjogcmVxLmJvZHkudXNlciwgcGFzc3dvcmQ6IHJlcS5ib2R5LnBhc3N3b3JkLCBkYjogcmVxLmJvZHkuZGIsIHNlcmlhbDogcmVxLmJvZHkuc2VyaWFsIH0pXG5cbiAgICAgICAgcmVzLmpzb24oeyBzdWNjZXNzOiB0cnVlLCB0b2tlbjogdG9rZW4gfSlcbiAgICB9KS5jYXRjaChmdW5jdGlvbihlcnIpIHtcbiAgICAgICAgcmVzLmpzb24oZXJyKVxuICAgIH0pXG59KTtcblxuYXBwLmdldCgnL2lwJywgZnVuY3Rpb24ocmVxLCByZXMpIHtcbiAgICByZXMuanNvbih7IGlwOiByZXEuaGVhZGVyc1sneC1mb3J3YXJkZWQtZm9yJ10gfSlcbn0pO1xuXG5hcHAuZ2V0KCcvc29ja2V0cycsIGZ1bmN0aW9uKHJlcSwgcmVzKSB7XG4gICAgcmVzLmpzb24oTWFjaGluZXMuc29ja2V0cygpKVxufSk7XG5hcHAuZ2V0KCcvbWFjaGluZXMvOnNlcmlhbC9zb2NrZXRzJywgZnVuY3Rpb24ocmVxLCByZXMpIHtcbiAgICByZXMuanNvbihNYWNoaW5lcy5zb2NrZXRzKHJlcS5wYXJhbXMuc2VyaWFsKSlcbn0pO1xuYXBwLmdldCgnL21hY2hpbmVzJywgZnVuY3Rpb24ocmVxLCByZXMpIHtcbiAgICByZXMuanNvbihNYWNoaW5lcy5saXN0KCkpXG59KTtcbmFwcC5nZXQoJy9hcHAvOmFwcC9tYWNoaW5lcycsIGZ1bmN0aW9uKHJlcSwgcmVzKSB7XG4gICAgLy8gcmVzLmpzb24oTWFjaGluZXMuc2VyaWFscygpKVxufSk7XG5cbmFwcC5nZXQoJy9tYWNoaW5lcy86c2VyaWFsL21lc3NhZ2UvOm1lc3NhZ2UnLCBmdW5jdGlvbihyZXEsIHJlcykge1xuICAgIF8ubWFwKE1hY2hpbmVzLmlvcyhyZXEucGFyYW1zLnNlcmlhbCksIGZ1bmN0aW9uKHNvY2tldCkge1xuICAgICAgICBzb2NrZXQuZW1pdCgnbWVzc2FnZScsIHJlcS5wYXJhbXMubWVzc2FnZSk7XG5cbiAgICB9KVxuICAgIHJlcy5qc29uKHt9KVxuXG59KTtcblxuYXBwLnBvc3QoJy9tYWNoaW5lcy86c2VyaWFsL21lc3NhZ2UnLCBmdW5jdGlvbihyZXEsIHJlcykge1xuICAgIF8ubWFwKE1hY2hpbmVzLmxpc3QocmVxLnBhcmFtcy5zZXJpYWwpLCBmdW5jdGlvbihzb2NrZXRpZCkge1xuICAgICAgICBpby50byhzb2NrZXRpZCkuZW1pdCgnbWVzc2FnZScsIHJlcS5ib2R5LmRhdGEpO1xuICAgIH0pXG5cbn0pO1xuYXBwLnBvc3QoJy9tYWNoaW5lcy86c2VyaWFsL2RhdGEnLCBmdW5jdGlvbihyZXEsIHJlcykge1xuICAgIF8ubWFwKE1hY2hpbmVzLmxpc3QocmVxLnBhcmFtcy5zZXJpYWwpLCBmdW5jdGlvbihzb2NrZXRpZCkge1xuICAgICAgICBpby50byhzb2NrZXRpZCkuZW1pdCgnZGF0YScsIHJlcS5ib2R5LmRhdGEpO1xuICAgIH0pXG59KTtcbmFwcC5wb3N0KCcvbWFjaGluZXMvOnNlcmlhbC9leGVjJywgZnVuY3Rpb24ocmVxLCByZXMpIHtcbiAgICBfLm1hcChNYWNoaW5lcy5saXN0KHJlcS5wYXJhbXMuc2VyaWFsKSwgZnVuY3Rpb24oc29ja2V0aWQpIHtcbiAgICAgICAgaW8udG8oc29ja2V0aWQpLmVtaXQoJ2V4ZWMnLCByZXEuYm9keS5kYXRhKTtcbiAgICB9KVxufSk7XG5hcHAucG9zdCgnL21hY2hpbmVzLzpzZXJpYWwvbnBtJywgZnVuY3Rpb24ocmVxLCByZXMpIHtcbiAgICBfLm1hcChNYWNoaW5lcy5saXN0KHJlcS5wYXJhbXMuc2VyaWFsKSwgZnVuY3Rpb24oc29ja2V0aWQpIHtcbiAgICAgICAgaW8udG8oc29ja2V0aWQpLmVtaXQoJ25wbScsIHJlcS5ib2R5LmRhdGEpO1xuICAgIH0pXG59KTtcbmFwcC5wb3N0KCcvbWFjaGluZXMvOnNlcmlhbC90YXNrJywgZnVuY3Rpb24ocmVxLCByZXMpIHtcbiAgICBfLm1hcChNYWNoaW5lcy5saXN0KHJlcS5wYXJhbXMuc2VyaWFsKSwgZnVuY3Rpb24oc29ja2V0aWQpIHtcbiAgICAgICAgaW8udG8oc29ja2V0aWQpLmVtaXQoJ3Rhc2snLCByZXEuYm9keS5kYXRhKTtcbiAgICB9KVxufSk7XG5cbmlvLm9uKCdjb25uZWN0aW9uJywgZnVuY3Rpb24oc29ja2V0OiBJU29ja2V0KSB7XG4gICAgbGV0IGMgPSBzb2NrZXQuZGVjb2RlZF90b2tlbjtcblxuICAgIGlmIChjLmRiKSB7XG4gICAgICAgIGNvbnNvbGUubG9nKGMuZGIpXG5cbiAgICAgICAgTWFjaGluZXMuYWRkKGMudXNlciwgYy5wYXNzd29yZCwgYy5kYiwgYy5zZXJpYWwsIHNvY2tldCk7XG4gICAgICAgIF8ubWFwKEF1ZGl0b3JzLmZvcnNlcmlhbChjLnNlcmlhbCksIGZ1bmN0aW9uKHNvY2tldGlkKSB7XG4gICAgICAgICAgICBpby50byhzb2NrZXRpZCkuZW1pdCgnbWFjaGluZSBjb25uZWN0aW9uJywgeyBzZXJpYWw6IGMuc2VyaWFsIH0pO1xuICAgICAgICB9KVxuXG4gICAgICAgIHNvY2tldC5vbignZGlzY29ubmVjdCcsIGZ1bmN0aW9uKCkge1xuXG4gICAgICAgICAgICBfLm1hcChBdWRpdG9ycy5mb3JzZXJpYWwoYy5zZXJpYWwpLCBmdW5jdGlvbihzb2NrZXRpZCkge1xuICAgICAgICAgICAgICAgIGlvLnRvKHNvY2tldGlkKS5lbWl0KCdtYWNoaW5lIGRpc2Nvbm5lY3Rpb24nLCB7IHNlcmlhbDogYy5zZXJpYWwgfSk7XG4gICAgICAgICAgICB9KVxuXG4gICAgICAgICAgICBNYWNoaW5lcy5yZW1vdmUoYy5zZXJpYWwsIHNvY2tldC5pZCk7XG4gICAgICAgIH0pO1xuICAgICAgICBzb2NrZXQub24oJ21lc3NhZ2UnLCBmdW5jdGlvbihtZXNzYWdlKSB7XG4gICAgICAgICAgICBNYWNoaW5lcy5wdXNoZGF0YShjLnNlcmlhbCwgJ21lc3NhZ2UnLCBtZXNzYWdlKS50aGVuKGZ1bmN0aW9uKGRvY3MpIHtcblxuICAgICAgICAgICAgICAgIF8ubWFwKEF1ZGl0b3JzLmZvcnNlcmlhbChjLnNlcmlhbCksIGZ1bmN0aW9uKHNvY2tldGlkKSB7XG4gICAgICAgICAgICAgICAgICAgIGlvLnRvKHNvY2tldGlkKS5lbWl0KCdtYWNoaW5lIG1lc3NhZ2UnLCB7IHNlcmlhbDogYy5zZXJpYWwsIGRhdGE6IG1lc3NhZ2UgfSk7XG4gICAgICAgICAgICAgICAgfSlcbiAgICAgICAgICAgIH0pXG4gICAgICAgIH0pO1xuICAgICAgICBzb2NrZXQub24oJ2RhdGEnLCBmdW5jdGlvbihkYXRhKSB7XG4gICAgICAgICAgICBNYWNoaW5lcy5wdXNoZGF0YShjLnNlcmlhbCwgJ2RhdGEnLCBkYXRhKS50aGVuKGZ1bmN0aW9uKGRvY3MpIHtcblxuICAgICAgICAgICAgICAgIF8ubWFwKEF1ZGl0b3JzLmZvcnNlcmlhbChjLnNlcmlhbCksIGZ1bmN0aW9uKHNvY2tldGlkKSB7XG4gICAgICAgICAgICAgICAgICAgIGlvLnRvKHNvY2tldGlkKS5lbWl0KCdtYWNoaW5lIGRhdGEnLCB7IHNlcmlhbDogYy5zZXJpYWwsIGRhdGE6IGRhdGEgfSk7XG4gICAgICAgICAgICAgICAgfSlcbiAgICAgICAgICAgIH0pXG4gICAgICAgIH0pO1xuICAgICAgICBzb2NrZXQub24oJ2RvY3MnLCBmdW5jdGlvbihkb2NzKSB7XG4gICAgICAgICAgICBNYWNoaW5lcy5wdXNoZGF0YShjLnNlcmlhbCwgJ2RvY3MnLCBkb2NzKS50aGVuKGZ1bmN0aW9uKGRvY3MpIHtcbiAgICAgICAgICAgICAgICBfLm1hcChBdWRpdG9ycy5mb3JzZXJpYWwoYy5zZXJpYWwpLCBmdW5jdGlvbihzb2NrZXRpZCkge1xuICAgICAgICAgICAgICAgICAgICBpby50byhzb2NrZXRpZCkuZW1pdCgnbWFjaGluZSBkb2NzJywgeyBzZXJpYWw6IGMuc2VyaWFsLCBkYXRhOiBkb2NzIH0pO1xuICAgICAgICAgICAgICAgIH0pXG5cbiAgICAgICAgICAgIH0pXG4gICAgICAgIH0pO1xuICAgICAgICBzb2NrZXQub24oJ3VwJywgZnVuY3Rpb24oZGF0YXMpIHtcbiAgICAgICAgICAgIF8ubWFwKEF1ZGl0b3JzLmZvcnNlcmlhbChjLnNlcmlhbCksIGZ1bmN0aW9uKHNvY2tldGlkKSB7XG4gICAgICAgICAgICAgICAgaW8udG8oc29ja2V0aWQpLmVtaXQoJ21hY2hpbmUgdXAnLCB7IHNlcmlhbDogYy5zZXJpYWwgfSk7XG4gICAgICAgICAgICB9KVxuICAgICAgICB9KVxuXG4gICAgfSBlbHNlIHtcbiAgICAgICAgQXVkaXRvcnMuYWRkKGMuc2VyaWFscywgc29ja2V0LmlkKVxuICAgICAgICBzb2NrZXQub24oJ2Rpc2Nvbm5lY3QnLCBmdW5jdGlvbigpIHtcbiAgICAgICAgICAgIEF1ZGl0b3JzLnJlbW92ZShzb2NrZXQuaWQpXG4gICAgICAgIH0pO1xuXG4gICAgfVxuXG4gICAgY29uc29sZS5sb2coJ2hlbGxvISAnLCBzb2NrZXQuaWQpO1xufSk7XG4iXSwic291cmNlUm9vdCI6Ii9zb3VyY2UvIn0=
