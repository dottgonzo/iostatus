var net = require("net");
var _ = require("lodash");
var Promise = require("bluebird");
var bodyParser = require("body-parser");
var pathExists = require("path-exists");
var IO = require("socket.io");
var express = require("express");
var jwt = require("jsonwebtoken");
var couchjsonconf = require("couchjsonconf");
var machClients = require("./modules/machClients");
var audClients = require("./modules/audClients");
var socketioJwt = require("socketio-jwt");
var rpj = require('request-promise-json');
var aedes = require("aedes");
var app = express();
var server = require('http').Server(app);
var io = IO(server);
if (!pathExists.sync('./conf.json')) {
    throw Error('no configuration founded');
}
var conf = require('./conf.json');
var COUCHDB = new couchjsonconf(conf.couchdb);
var Machines = new machClients(COUCHDB);
var Auditors = new audClients();
app.use(bodyParser.urlencoded({ extended: false }));
app.use(bodyParser.json());
io.use(socketioJwt.authorize({
    secret: conf.secret,
    handshake: true
}));
server.listen(conf.port);
var Aedes = aedes();
var Aserver = net.createServer(Aedes.handle);
Aserver.listen(1883, function () {
    console.log('MQTT server listening on port', 1883);
});
Aedes.authenticate = function (client, username, password, callback) {
    console.log(client);
    console.log("auth");
    console.log(username);
};
Aedes.on('client', function (client) {
    console.log(client.username);
    console.log(client.password);
    console.log("new client" + client.id);
});
Aedes.on('clientDisconnect', function (client) {
    console.log("clientDisconnect");
});
Aedes.on('subscribe', function (topic, client) {
    console.log("subscribe");
});
Aedes.on('unsubscribe', function (topic, client) {
    console.log("unsubscribe");
});
Aedes.on('publish', function (packet, client) {
    if (!client)
        return;
    packet.payloadString = packet.payload.toString();
    packet.payloadLength = packet.payload.length;
    packet.payload = JSON.stringify(packet.payload);
    packet.timestamp = new Date();
    console.log("publish");
});
app.get('/', function (req, res) {
    res.json({ online: true });
});
function authcouch(user, password, db) {
    return new Promise(function (resolve, reject) {
        rpj.get(COUCHDB.for(user, password, db)).then(function () {
            resolve({ success: true });
        }).catch(function (err) {
            reject({ error: 'wrong credentials' });
        });
    });
}
function authorizesocket(profile) {
    return jwt.sign(profile, conf.secret, { expiresInMinutes: 60 * 5 });
}
app.post('/login', function (req, res) {
    authcouch(req.body.user, req.body.password, req.body.db).then(function () {
        var token = authorizesocket({ user: req.body.user, password: req.body.password, db: req.body.db, serial: req.body.serial });
        res.json({ success: true, token: token });
    }).catch(function (err) {
        res.json(err);
    });
});
app.get('/ip', function (req, res) {
    res.json({ ip: req.headers['x-forwarded-for'] });
});
app.get('/sockets', function (req, res) {
    res.json(Machines.sockets());
});
app.get('/machines/:serial/sockets', function (req, res) {
    res.json(Machines.sockets(req.params.serial));
});
app.get('/machines', function (req, res) {
    res.json(Machines.list());
});
app.get('/app/:app/machines', function (req, res) {
});
app.get('/machines/:serial/message/:message', function (req, res) {
    _.map(Machines.ios(req.params.serial), function (socket) {
        socket.emit('message', req.params.message);
    });
    res.json({});
});
app.post('/machines/:serial/message', function (req, res) {
    _.map(Machines.list(req.params.serial), function (socketid) {
        io.to(socketid).emit('message', req.body.data);
    });
});
app.post('/machines/:serial/data', function (req, res) {
    _.map(Machines.list(req.params.serial), function (socketid) {
        io.to(socketid).emit('data', req.body.data);
    });
});
app.post('/machines/:serial/exec', function (req, res) {
    _.map(Machines.list(req.params.serial), function (socketid) {
        io.to(socketid).emit('exec', req.body.data);
    });
});
app.post('/machines/:serial/npm', function (req, res) {
    _.map(Machines.list(req.params.serial), function (socketid) {
        io.to(socketid).emit('npm', req.body.data);
    });
});
app.post('/machines/:serial/task', function (req, res) {
    _.map(Machines.list(req.params.serial), function (socketid) {
        io.to(socketid).emit('task', req.body.data);
    });
});
io.on('connection', function (socket) {
    var c = socket.decoded_token;
    if (c.db) {
        console.log(c.db);
        Machines.add(c.user, c.password, c.db, c.serial, socket);
        _.map(Auditors.forserial(c.serial), function (socketid) {
            io.to(socketid).emit('machine connection', { serial: c.serial });
        });
        socket.on('disconnect', function () {
            _.map(Auditors.forserial(c.serial), function (socketid) {
                io.to(socketid).emit('machine disconnection', { serial: c.serial });
            });
            Machines.remove(c.serial, socket.id);
        });
        socket.on('message', function (message) {
            Machines.pushdata(c.serial, 'message', message).then(function (docs) {
                _.map(Auditors.forserial(c.serial), function (socketid) {
                    io.to(socketid).emit('machine message', { serial: c.serial, data: message });
                });
            });
        });
        socket.on('data', function (data) {
            Machines.pushdata(c.serial, 'data', data).then(function (docs) {
                _.map(Auditors.forserial(c.serial), function (socketid) {
                    io.to(socketid).emit('machine data', { serial: c.serial, data: data });
                });
            });
        });
        socket.on('docs', function (docs) {
            Machines.pushdata(c.serial, 'docs', docs).then(function (docs) {
                _.map(Auditors.forserial(c.serial), function (socketid) {
                    io.to(socketid).emit('machine docs', { serial: c.serial, data: docs });
                });
            });
        });
        socket.on('up', function (datas) {
            _.map(Auditors.forserial(c.serial), function (socketid) {
                io.to(socketid).emit('machine up', { serial: c.serial });
            });
        });
    }
    else {
        Auditors.add(c.serials, socket.id);
        socket.on('disconnect', function () {
            Auditors.remove(socket.id);
        });
    }
    console.log('hello! ', socket.id);
});

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImluZGV4LnRzIl0sIm5hbWVzIjpbImF1dGhjb3VjaCIsImF1dGhvcml6ZXNvY2tldCJdLCJtYXBwaW5ncyI6IkFBQUEsSUFBWSxHQUFHLFdBQU0sS0FBSyxDQUFDLENBQUE7QUFDM0IsSUFBWSxDQUFDLFdBQU0sUUFBUSxDQUFDLENBQUE7QUFDNUIsSUFBWSxPQUFPLFdBQU0sVUFBVSxDQUFDLENBQUE7QUFDcEMsSUFBWSxVQUFVLFdBQU0sYUFBYSxDQUFDLENBQUE7QUFDMUMsSUFBWSxVQUFVLFdBQU0sYUFBYSxDQUFDLENBQUE7QUFDMUMsSUFBWSxFQUFFLFdBQU0sV0FBWSxDQUFDLENBQUE7QUFDakMsSUFBWSxPQUFPLFdBQU0sU0FBUyxDQUFDLENBQUE7QUFDbkMsSUFBWSxHQUFHLFdBQU0sY0FBYyxDQUFDLENBQUE7QUFHcEMsSUFBTyxhQUFhLFdBQVcsZUFBZSxDQUFDLENBQUM7QUFFaEQsSUFBTyxXQUFXLFdBQVcsdUJBQXVCLENBQUMsQ0FBQztBQUN0RCxJQUFPLFVBQVUsV0FBVyxzQkFBc0IsQ0FBQyxDQUFDO0FBRXBELElBQUksV0FBVyxHQUFLLE9BQU8sQ0FBQyxjQUFjLENBQUMsQ0FBQztBQUM1QyxJQUFJLEdBQUcsR0FBRyxPQUFPLENBQUMsc0JBQXNCLENBQUMsQ0FBQztBQUMxQyxJQUFJLEtBQUssR0FBRyxPQUFPLENBQUMsT0FBTyxDQUFDLENBQUM7QUFHN0IsSUFBSSxHQUFHLEdBQUcsT0FBTyxFQUFFLENBQUM7QUFDcEIsSUFBSSxNQUFNLEdBQUcsT0FBTyxDQUFDLE1BQU0sQ0FBQyxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsQ0FBQztBQUN6QyxJQUFJLEVBQUUsR0FBRyxFQUFFLENBQUMsTUFBTSxDQUFDLENBQUM7QUFNcEIsRUFBRSxDQUFDLENBQUMsQ0FBQyxVQUFVLENBQUMsSUFBSSxDQUFDLGFBQWEsQ0FBQyxDQUFDLENBQUEsQ0FBQztJQUNuQyxNQUFNLEtBQUssQ0FBQywwQkFBMEIsQ0FBQyxDQUFBO0FBQ3pDLENBQUM7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QUFDLENBQUMsR0FBRyxDQUFDLFFBQVEsQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLE1BQU0sQ0FBQyxNQUFNLENBQUMsRUFBQyxVQUFTLFFBQVE7UUFDdEQsRUFBRSxDQUFDLEVBQUUsQ0FBQyxRQUFRLENBQUMsQ0FBQyxJQUFJLENBQUMsTUFBTSxFQUFFLEdBQUcsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUM7SUFDOUMsQ0FBQyxDQUFDLENBQUE7QUFDSixDQUFDLENBQUMsQ0FBQztBQUNILEdBQUcsQ0FBQyxJQUFJLENBQUMsd0JBQXdCLEVBQUUsVUFBVSxHQUFHLEVBQUUsR0FBRztJQUNuRCxDQUFDLENBQUMsR0FBRyxDQUFDLFFBQVEsQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLE1BQU0sQ0FBQyxNQUFNLENBQUMsRUFBQyxVQUFTLFFBQVE7UUFDdEQsRUFBRSxDQUFDLEVBQUUsQ0FBQyxRQUFRLENBQUMsQ0FBQyxJQUFJLENBQUMsTUFBTSxFQUFFLEdBQUcsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUM7SUFDOUMsQ0FBQyxDQUFDLENBQUE7QUFDSixDQUFDLENBQUMsQ0FBQztBQUNILEdBQUcsQ0FBQyxJQUFJLENBQUMsdUJBQXVCLEVBQUUsVUFBVSxHQUFHLEVBQUUsR0FBRztJQUNsRCxDQUFDLENBQUMsR0FBRyxDQUFDLFFBQVEsQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLE1BQU0sQ0FBQyxNQUFNLENBQUMsRUFBQyxVQUFTLFFBQVE7UUFDdEQsRUFBRSxDQUFDLEVBQUUsQ0FBQyxRQUFRLENBQUMsQ0FBQyxJQUFJLENBQUMsS0FBSyxFQUFFLEdBQUcsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUM7SUFDN0MsQ0FBQyxDQUFDLENBQUE7QUFDSixDQUFDLENBQUMsQ0FBQztBQUNILEdBQUcsQ0FBQyxJQUFJLENBQUMsd0JBQXdCLEVBQUUsVUFBVSxHQUFHLEVBQUUsR0FBRztJQUNuRCxDQUFDLENBQUMsR0FBRyxDQUFDLFFBQVEsQ0FBQyxJQUFJLENBQUMsR0FBRyxD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RUFBRSxDQUFDLENBQUE7UUFDNUIsQ0FBQyxDQUFDLENBQUM7SUFFTCxDQUFDO0lBRUQsT0FBTyxDQUFDLEdBQUcsQ0FBQyxTQUFTLEVBQUUsTUFBTSxDQUFDLEVBQUUsQ0FBQyxDQUFDO0FBQ2xDLENBQUMsQ0FBQyxDQUFDIiwiZmlsZSI6ImluZGV4LmpzIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0ICogYXMgbmV0IGZyb20gXCJuZXRcIjtcbmltcG9ydCAqIGFzIF8gZnJvbSBcImxvZGFzaFwiO1xuaW1wb3J0ICogYXMgUHJvbWlzZSBmcm9tIFwiYmx1ZWJpcmRcIjtcbmltcG9ydCAqIGFzIGJvZHlQYXJzZXIgZnJvbSBcImJvZHktcGFyc2VyXCI7XG5pbXBvcnQgKiBhcyBwYXRoRXhpc3RzIGZyb20gXCJwYXRoLWV4aXN0c1wiO1xuaW1wb3J0ICogYXMgSU8gZnJvbSBcInNvY2tldC5pb1wiIDtcbmltcG9ydCAqIGFzIGV4cHJlc3MgZnJvbSBcImV4cHJlc3NcIjtcbmltcG9ydCAqIGFzIGp3dCBmcm9tIFwianNvbndlYnRva2VuXCI7XG5pbXBvcnQgKiBhcyByZWRpcyBmcm9tIFwicmVkaXNcIjtcblxuaW1wb3J0IGNvdWNoanNvbmNvbmYgPSByZXF1aXJlKFwiY291Y2hqc29uY29uZlwiKTtcblxuaW1wb3J0IG1hY2hDbGllbnRzID0gcmVxdWlyZShcIi4vbW9kdWxlcy9tYWNoQ2xpZW50c1wiKTtcbmltcG9ydCBhdWRDbGllbnRzID0gcmVxdWlyZShcIi4vbW9kdWxlcy9hdWRDbGllbnRzXCIpO1xuXG5sZXQgc29ja2V0aW9Kd3QgICA9IHJlcXVpcmUoXCJzb2NrZXRpby1qd3RcIik7XG5sZXQgcnBqID0gcmVxdWlyZSgncmVxdWVzdC1wcm9taXNlLWpzb24nKTtcbmxldCBhZWRlcyA9IHJlcXVpcmUoXCJhZWRlc1wiKTtcblxuXG5sZXQgYXBwID0gZXhwcmVzcygpO1xubGV0IHNlcnZlciA9IHJlcXVpcmUoJ2h0dHAnKS5TZXJ2ZXIoYXBwKTtcbmxldCBpbyA9IElPKHNlcnZlcik7XG5cblxuXG5cblxuaWYgKCFwYXRoRXhpc3RzLnN5bmMoJy4vY29uZi5qc29uJykpe1xuICB0aHJvdyBFcnJvcignbm8gY29uZmlndXJhdGlvbiBmb3VuZGVkJylcbn1cbmxldCBjb25mPXJlcXVpcmUoJy4vY29uZi5qc29uJylcblxubGV0IENPVUNIREI9IG5ldyBjb3VjaGpzb25jb25mKGNvbmYuY291Y2hkYilcblxubGV0IE1hY2hpbmVzPW5ldyBtYWNoQ2xpZW50cyhDT1VDSERCKTtcbmxldCBBdWRpdG9ycz1uZXcgYXVkQ2xpZW50cygpO1xuXG4vLyBwYXJzZSBhcHBsaWNhdGlvbi94LXd3dy1mb3JtLXVybGVuY29kZWRcbmFwcC51c2UoYm9keVBhcnNlci51cmxlbmNvZGVkKHsgZXh0ZW5kZWQ6IGZhbHNlIH0pKVxuXG4vLyBwYXJzZSBhcHBsaWNhdGlvbi9qc29uXG5hcHAudXNlKGJvZHlQYXJzZXIuanNvbigpKVxuXG5cblxuaW8udXNlKHNvY2tldGlvSnd0LmF1dGhvcml6ZSh7XG4gIHNlY3JldDogY29uZi5zZWNyZXQsXG4gIGhhbmRzaGFrZTogdHJ1ZVxufSkpO1xuXG5zZXJ2ZXIubGlzdGVuKGNvbmYucG9ydCk7XG5cblxubGV0IEFlZGVzID0gYWVkZXMoKVxubGV0IEFzZXJ2ZXIgPSBuZXQuY3JlYXRlU2VydmVyKEFlZGVzLmhhbmRsZSlcblxuQXNlcnZlci5saXN0ZW4oMTg4MywgZnVuY3Rpb24gKCkge1xuICBjb25zb2xlLmxvZygnTVFUVCBzZXJ2ZXIgbGlzdGVuaW5nIG9uIHBvcnQnLCAxODgzKVxufSk7XG5cblxuQWVkZXMuYXV0aGVudGljYXRlID0gZnVuY3Rpb24gKGNsaWVudCwgdXNlcm5hbWUsIHBhc3N3b3JkLCBjYWxsYmFjaykge1xuICAgIFxuICAgIGNvbnNvbGUubG9nKGNsaWVudClcbiAgICAgICAgY29uc29sZS5sb2coXCJhdXRoXCIpXG4gICAgICAgIFxuICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKHVzZXJuYW1lKVxuICAvLyBjYWxsYmFjayhudWxsLCB1c2VybmFtZSA9PT0gJ21hdHRlbycpXG59XG5cbkFlZGVzLm9uKCdjbGllbnQnLCBmdW5jdGlvbihjbGllbnQpIHtcbiAgICBcbiAgICAgY29uc29sZS5sb2coY2xpZW50LnVzZXJuYW1lKVxuICAgICAgICAgY29uc29sZS5sb2coY2xpZW50LnBhc3N3b3JkKVxuIGNvbnNvbGUubG9nKFwibmV3IGNsaWVudFwiK2NsaWVudC5pZClcbn0pO1xuXG5BZWRlcy5vbignY2xpZW50RGlzY29ubmVjdCcsIGZ1bmN0aW9uKGNsaWVudCkge1xuY29uc29sZS5sb2coXCJjbGllbnREaXNjb25uZWN0XCIpXG59KTtcblxuQWVkZXMub24oJ3N1YnNjcmliZScsIGZ1bmN0aW9uKHRvcGljLCBjbGllbnQpIHtcbmNvbnNvbGUubG9nKFwic3Vic2NyaWJlXCIpXG59KTtcblxuQWVkZXMub24oJ3Vuc3Vic2NyaWJlJywgZnVuY3Rpb24odG9waWMsIGNsaWVudCkge1xuY29uc29sZS5sb2coXCJ1bnN1YnNjcmliZVwiKVxufSk7XG5cbkFlZGVzLm9uKCdwdWJsaXNoJywgZnVuY3Rpb24ocGFja2V0LCBjbGllbnQpIHtcblxuICBpZighIGNsaWVudCkgcmV0dXJuO1xuICBcbiAgcGFja2V0LnBheWxvYWRTdHJpbmcgPSBwYWNrZXQucGF5bG9hZC50b1N0cmluZygpO1xuICBwYWNrZXQucGF5bG9hZExlbmd0aCA9IHBhY2tldC5wYXlsb2FkLmxlbmd0aDtcbiAgcGFja2V0LnBheWxvYWQgPSBKU09OLnN0cmluZ2lmeShwYWNrZXQucGF5bG9hZCk7XG4gIHBhY2tldC50aW1lc3RhbXAgPSBuZXcgRGF0ZSgpO1xuXG5jb25zb2xlLmxvZyhcInB1Ymxpc2hcIilcblxufSk7XG5cblxuaW50ZXJmYWNlIElTb2NrZXQge1xuXG4gICAgICAgIGlkOiBzdHJpbmc7XG4gICAgICAgIGVtaXQ6RnVuY3Rpb247XG4gICAgICAgICAgICAgICAgb246RnVuY3Rpb247XG4gICAgZGVjb2RlZF90b2tlbjp7XG4gICAgICAgIGRiOnN0cmluZztcbiAgICAgICAgdXNlcjpzdHJpbmc7XG4gICAgICAgIHBhc3N3b3JkOnN0cmluZztcbiAgICAgICAgc2VyaWFsOnN0cmluZztcbiAgICAgICAgc2VyaWFsczpzdHJpbmdbXVxuICAgIH1cbn1cblxuXG5cblxuYXBwLmdldCgnLycsIGZ1bmN0aW9uIChyZXEsIHJlcykge1xuICByZXMuanNvbih7b25saW5lOnRydWV9KVxufSk7XG5cblxuXG5cbmZ1bmN0aW9uIGF1dGhjb3VjaCh1c2VyOnN0cmluZyxwYXNzd29yZDpzdHJpbmcsZGI6c3RyaW5nKXtcbiAgcmV0dXJuIG5ldyBQcm9taXNlKGZ1bmN0aW9uKHJlc29sdmUscmVqZWN0KXtcbiAgICBycGouZ2V0KENPVUNIREIuZm9yKHVzZXIscGFzc3dvcmQsZGIpKS50aGVuKGZ1bmN0aW9uKCl7XG4gICAgICByZXNvbHZlKHtzdWNjZXNzOnRydWV9KVxuICAgIH0pLmNhdGNoKGZ1bmN0aW9uKGVycil7XG4gICAgICByZWplY3Qoe2Vycm9yOid3cm9uZyBjcmVkZW50aWFscyd9KVxuICAgIH0pXG4gIH0pXG59XG5cbmZ1bmN0aW9uIGF1dGhvcml6ZXNvY2tldChwcm9maWxlKTp7fXtcbnJldHVybiBqd3Quc2lnbihwcm9maWxlLCBjb25mLnNlY3JldCwgeyBleHBpcmVzSW5NaW51dGVzOiA2MCo1IH0pO1xufVxuXG5hcHAucG9zdCgnL2xvZ2luJywgZnVuY3Rpb24gKHJlcSwgcmVzKSB7XG4gIGF1dGhjb3VjaChyZXEuYm9keS51c2VyLHJlcS5ib2R5LnBhc3N3b3JkLHJlcS5ib2R5LmRiKS50aGVuKGZ1bmN0aW9uKCl7XG5cbiAgbGV0IHRva2VuPWF1dGhvcml6ZXNvY2tldCh7IHVzZXI6cmVxLmJvZHkudXNlcixwYXNzd29yZDpyZXEuYm9keS5wYXNzd29yZCxkYjpyZXEuYm9keS5kYixzZXJpYWw6cmVxLmJvZHkuc2VyaWFsIH0pXG5cbiAgICByZXMuanNvbih7c3VjY2Vzczp0cnVlLHRva2VuOnRva2VufSlcbiAgfSkuY2F0Y2goZnVuY3Rpb24oZXJyKXtcbiAgICByZXMuanNvbihlcnIpXG4gIH0pXG59KTtcblxuYXBwLmdldCgnL2lwJywgZnVuY3Rpb24gKHJlcSwgcmVzKSB7XG4gIHJlcy5qc29uKHtpcDpyZXEuaGVhZGVyc1sneC1mb3J3YXJkZWQtZm9yJ119KVxufSk7XG5cbmFwcC5nZXQoJy9zb2NrZXRzJywgZnVuY3Rpb24gKHJlcSwgcmVzKSB7XG4gIHJlcy5qc29uKE1hY2hpbmVzLnNvY2tldHMoKSlcbn0pO1xuYXBwLmdldCgnL21hY2hpbmVzLzpzZXJpYWwvc29ja2V0cycsIGZ1bmN0aW9uIChyZXEsIHJlcykge1xuICByZXMuanNvbihNYWNoaW5lcy5zb2NrZXRzKHJlcS5wYXJhbXMuc2VyaWFsKSlcbn0pO1xuYXBwLmdldCgnL21hY2hpbmVzJywgZnVuY3Rpb24gKHJlcSwgcmVzKSB7XG4gIHJlcy5qc29uKE1hY2hpbmVzLmxpc3QoKSlcbn0pO1xuYXBwLmdldCgnL2FwcC86YXBwL21hY2hpbmVzJywgZnVuY3Rpb24gKHJlcSwgcmVzKSB7XG4gLy8gcmVzLmpzb24oTWFjaGluZXMuc2VyaWFscygpKVxufSk7XG5cbmFwcC5nZXQoJy9tYWNoaW5lcy86c2VyaWFsL21lc3NhZ2UvOm1lc3NhZ2UnLCBmdW5jdGlvbiAocmVxLCByZXMpIHtcbiAgXy5tYXAoTWFjaGluZXMuaW9zKHJlcS5wYXJhbXMuc2VyaWFsKSxmdW5jdGlvbihzb2NrZXQpe1xuICAgIHNvY2tldC5lbWl0KCdtZXNzYWdlJywgcmVxLnBhcmFtcy5tZXNzYWdlKTtcblxuICB9KVxuICByZXMuanNvbih7fSlcblxufSk7XG5cbmFwcC5wb3N0KCcvbWFjaGluZXMvOnNlcmlhbC9tZXNzYWdlJywgZnVuY3Rpb24gKHJlcSwgcmVzKSB7XG4gIF8ubWFwKE1hY2hpbmVzLmxpc3QocmVxLnBhcmFtcy5zZXJpYWwpLGZ1bmN0aW9uKHNvY2tldGlkKXtcbiAgICBpby50byhzb2NrZXRpZCkuZW1pdCgnbWVzc2FnZScsIHJlcS5ib2R5LmRhdGEpO1xuICB9KVxuXG59KTtcbmFwcC5wb3N0KCcvbWFjaGluZXMvOnNlcmlhbC9kYXRhJywgZnVuY3Rpb24gKHJlcSwgcmVzKSB7XG4gIF8ubWFwKE1hY2hpbmVzLmxpc3QocmVxLnBhcmFtcy5zZXJpYWwpLGZ1bmN0aW9uKHNvY2tldGlkKXtcbiAgICBpby50byhzb2NrZXRpZCkuZW1pdCgnZGF0YScsIHJlcS5ib2R5LmRhdGEpO1xuICB9KVxufSk7XG5hcHAucG9zdCgnL21hY2hpbmVzLzpzZXJpYWwvZXhlYycsIGZ1bmN0aW9uIChyZXEsIHJlcykge1xuICBfLm1hcChNYWNoaW5lcy5saXN0KHJlcS5wYXJhbXMuc2VyaWFsKSxmdW5jdGlvbihzb2NrZXRpZCl7XG4gICAgaW8udG8oc29ja2V0aWQpLmVtaXQoJ2V4ZWMnLCByZXEuYm9keS5kYXRhKTtcbiAgfSlcbn0pO1xuYXBwLnBvc3QoJy9tYWNoaW5lcy86c2VyaWFsL25wbScsIGZ1bmN0aW9uIChyZXEsIHJlcykge1xuICBfLm1hcChNYWNoaW5lcy5saXN0KHJlcS5wYXJhbXMuc2VyaWFsKSxmdW5jdGlvbihzb2NrZXRpZCl7XG4gICAgaW8udG8oc29ja2V0aWQpLmVtaXQoJ25wbScsIHJlcS5ib2R5LmRhdGEpO1xuICB9KVxufSk7XG5hcHAucG9zdCgnL21hY2hpbmVzLzpzZXJpYWwvdGFzaycsIGZ1bmN0aW9uIChyZXEsIHJlcykge1xuICBfLm1hcChNYWNoaW5lcy5saXN0KHJlcS5wYXJhbXMuc2VyaWFsKSxmdW5jdGlvbihzb2NrZXRpZCl7XG4gICAgaW8udG8oc29ja2V0aWQpLmVtaXQoJ3Rhc2snLCByZXEuYm9keS5kYXRhKTtcbiAgfSlcbn0pO1xuXG5pby5vbignY29ubmVjdGlvbicsIGZ1bmN0aW9uIChzb2NrZXQ6SVNvY2tldCkge1xuICBsZXQgYyA9IHNvY2tldC5kZWNvZGVkX3Rva2VuO1xuXG4gIGlmKGMuZGIpe1xuICAgIGNvbnNvbGUubG9nKGMuZGIpXG5cbiAgICBNYWNoaW5lcy5hZGQoYy51c2VyLGMucGFzc3dvcmQsYy5kYixjLnNlcmlhbCxzb2NrZXQpO1xuICAgIF8ubWFwKEF1ZGl0b3JzLmZvcnNlcmlhbChjLnNlcmlhbCksZnVuY3Rpb24oc29ja2V0aWQpe1xuICAgICAgaW8udG8oc29ja2V0aWQpLmVtaXQoJ21hY2hpbmUgY29ubmVjdGlvbicsIHtzZXJpYWw6Yy5zZXJpYWx9KTtcbiAgICB9KVxuXG4gICAgc29ja2V0Lm9uKCdkaXNjb25uZWN0JywgZnVuY3Rpb24gKCkge1xuXG4gICAgICBfLm1hcChBdWRpdG9ycy5mb3JzZXJpYWwoYy5zZXJpYWwpLGZ1bmN0aW9uKHNvY2tldGlkKXtcbiAgICAgICAgaW8udG8oc29ja2V0aWQpLmVtaXQoJ21hY2hpbmUgZGlzY29ubmVjdGlvbicsIHtzZXJpYWw6Yy5zZXJpYWx9KTtcbiAgICAgIH0pXG5cbiAgICAgIE1hY2hpbmVzLnJlbW92ZShjLnNlcmlhbCxzb2NrZXQuaWQpO1xuICAgIH0pO1xuICAgIHNvY2tldC5vbignbWVzc2FnZScsIGZ1bmN0aW9uIChtZXNzYWdlKSB7XG4gICAgICBNYWNoaW5lcy5wdXNoZGF0YShjLnNlcmlhbCwnbWVzc2FnZScsbWVzc2FnZSkudGhlbihmdW5jdGlvbihkb2NzKXtcblxuICAgICAgICBfLm1hcChBdWRpdG9ycy5mb3JzZXJpYWwoYy5zZXJpYWwpLGZ1bmN0aW9uKHNvY2tldGlkKXtcbiAgICAgICAgICBpby50byhzb2NrZXRpZCkuZW1pdCgnbWFjaGluZSBtZXNzYWdlJywge3NlcmlhbDpjLnNlcmlhbCxkYXRhOm1lc3NhZ2V9KTtcbiAgICAgICAgfSlcbiAgICAgIH0pXG4gICAgfSk7XG4gICAgc29ja2V0Lm9uKCdkYXRhJywgZnVuY3Rpb24gKGRhdGEpIHtcbiAgICAgIE1hY2hpbmVzLnB1c2hkYXRhKGMuc2VyaWFsLCdkYXRhJyxkYXRhKS50aGVuKGZ1bmN0aW9uKGRvY3Mpe1xuXG4gICAgICAgIF8ubWFwKEF1ZGl0b3JzLmZvcnNlcmlhbChjLnNlcmlhbCksZnVuY3Rpb24oc29ja2V0aWQpe1xuICAgICAgICAgIGlvLnRvKHNvY2tldGlkKS5lbWl0KCdtYWNoaW5lIGRhdGEnLCB7c2VyaWFsOmMuc2VyaWFsLGRhdGE6ZGF0YX0pO1xuICAgICAgICB9KVxuICAgICAgfSlcbiAgICB9KTtcbiAgICBzb2NrZXQub24oJ2RvY3MnLCBmdW5jdGlvbiAoZG9jcykge1xuICAgICAgTWFjaGluZXMucHVzaGRhdGEoYy5zZXJpYWwsJ2RvY3MnLGRvY3MpLnRoZW4oZnVuY3Rpb24oZG9jcyl7XG4gICAgICAgIF8ubWFwKEF1ZGl0b3JzLmZvcnNlcmlhbChjLnNlcmlhbCksZnVuY3Rpb24oc29ja2V0aWQpe1xuICAgICAgICAgIGlvLnRvKHNvY2tldGlkKS5lbWl0KCdtYWNoaW5lIGRvY3MnLCB7c2VyaWFsOmMuc2VyaWFsLGRhdGE6ZG9jc30pO1xuICAgICAgICB9KVxuXG4gICAgICB9KVxuICAgIH0pO1xuICAgIHNvY2tldC5vbigndXAnLCBmdW5jdGlvbiAoZGF0YXMpIHtcbiAgICAgIF8ubWFwKEF1ZGl0b3JzLmZvcnNlcmlhbChjLnNlcmlhbCksZnVuY3Rpb24oc29ja2V0aWQpe1xuICAgICAgICBpby50byhzb2NrZXRpZCkuZW1pdCgnbWFjaGluZSB1cCcsIHtzZXJpYWw6Yy5zZXJpYWx9KTtcbiAgICAgIH0pXG4gICAgfSlcblxufSBlbHNle1xuICBBdWRpdG9ycy5hZGQoYy5zZXJpYWxzLHNvY2tldC5pZClcbiAgc29ja2V0Lm9uKCdkaXNjb25uZWN0JywgZnVuY3Rpb24gKCkge1xuICAgIEF1ZGl0b3JzLnJlbW92ZShzb2NrZXQuaWQpXG4gIH0pO1xuXG59XG5cbmNvbnNvbGUubG9nKCdoZWxsbyEgJywgc29ja2V0LmlkKTtcbn0pO1xuIl0sInNvdXJjZVJvb3QiOiIvc291cmNlLyJ9
