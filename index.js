var net = require("net");
var _ = require("lodash");
var Promise = require("bluebird");
var bodyParser = require("body-parser");
var pathExists = require("path-exists");
var IO = require("socket.io");
var express = require("express");
var jwt = require("jsonwebtoken");
var moment = require("moment-timezone");
var couchjsonconf = require("couchjsonconf");
var machClients = require("./modules/machClients");
var audClients = require("./modules/audClients");
var socketioJwt = require("socketio-jwt");
var rpj = require("request-promise-json");
var aedes = require("aedes");
var app = express();
var server = require("http").Server(app);
var io = IO(server);
if (!pathExists.sync("./conf.json")) {
    throw Error("no configuration founded");
}
var conf = require("./conf.json");
var COUCHDB = new couchjsonconf(conf.couchdb);
var Machines = new machClients(COUCHDB);
var Auditors = new audClients();
app.use(bodyParser.urlencoded({ extended: false }));
app.use(bodyParser.json());
io.use(socketioJwt.authorize({
    secret: conf.secret,
    handshake: true
}));
server.listen(conf.port);
var Aedes = aedes();
var Aserver = net.createServer(Aedes.handle);
Aserver.listen(1883, function () {
    console.log("MQTT server listening on port", 1883);
});
Aedes.authenticate = function (client, username, token, callback) {
    if (conf.admin.username === username) {
        if (token === conf.admin.password) {
            callback(null, true);
        }
        else {
            console.log("unauthorized " + username);
            callback(null);
        }
    }
    else {
        try {
            var decoded = jwt.verify(JSON.parse(token + ""), conf.secret, { ignoreExpiration: true });
            var db = decoded.db;
            var password = decoded.password;
            console.log("auth");
            authcouch(username, password, db).then(function () {
                console.log("authorized " + username);
                client.serial = decoded.serial;
                client.couch = { username: username, password: password, db: db };
                callback(null, true);
            }).catch(function () {
                console.log("unauthorized " + username);
                callback(null);
            });
        }
        catch (err) {
            console.log("unauthorized " + username);
            callback(null);
        }
    }
};
Aedes.on("client", function (client) {
    console.log("new client" + client.id);
});
Aedes.on("clientDisconnect", function (client) {
    console.log("clientDisconnect");
});
Aedes.on("subscribe", function (topic, client) {
    console.log("subscribe");
});
Aedes.on("unsubscribe", function (topic, client) {
    console.log("unsubscribe");
});
Aedes.on("publish", function (packet, client) {
    if (!client)
        return;
    var obj = JSON.parse(packet.payload.toString());
    console.log("publish");
    if (packet.topic.split("/").length > 1 && packet.topic.split("/")[0] === "data" && client.couch && client.couch && client.couch.username) {
        if (client.couch.db === "mach_pctt3v_energytrack" || client.couch.db === "mach_sxcm0q_energytrack") {
            obj.updatedAt = obj.updatedAt + 3600000;
            obj.date = moment.tz(obj.updatedAt, "Europe/Rome").format("YYYYMMDD-HH:mm:ss");
        }
        console.log("save");
        rpj.get("http://" + client.couch.username + ":" + client.couch.password + "@192.168.122.44:5984/" + client.couch.db + "/" + obj._id).then(function (d) {
            obj._rev = d._rev;
            rpj.put("http://" + client.couch.username + ":" + client.couch.password + "@192.168.122.44:5984/" + client.couch.db + "/" + obj._id, obj).then(function () {
                console.log("backup");
                rpj.get("http://" + client.couch.username + ":" + client.couch.password + "@192.168.122.44:5984/" + client.couch.db + "/hooks").then(function (data) {
                    try {
                        var hookurl = data[packet.topic.split("/")[0]];
                        console.log(hookurl);
                        if (data[packet.topic.split("/")[0]]) {
                            rpj.post(hookurl + "/" + client.serial + "/" + client.couch.db + "/" + client.couch.username + "/" + client.couch.password, { data: obj }).then(function (bro) {
                                console.log("send to applicantion manager");
                            }).catch(function (err) {
                                console.log(err);
                            });
                        }
                    }
                    catch (err) {
                        console.log(err);
                    }
                }).catch(function (err) {
                    console.log(err);
                });
            }).catch(function (err) {
                console.log("save error " + err);
            });
        }).catch(function (err) {
            if (err.statusCode === 404) {
                rpj.put("http://" + client.couch.username + ":" + client.couch.password + "@192.168.122.44:5984/" + client.couch.db + "/" + obj._id, obj).then(function () {
                    console.log("backup");
                    rpj.get("http://" + client.couch.username + ":" + client.couch.password + "@192.168.122.44:5984/" + client.couch.db + "/hooks").then(function (data) {
                        try {
                            var hookurl = data[packet.topic.split("/")[0]];
                            console.log(hookurl);
                            if (data[packet.topic.split("/")[0]]) {
                                rpj.post(hookurl + "/" + client.serial + "/" + client.couch.db + "/" + client.couch.username + "/" + client.couch.password, { data: obj }).then(function (bro) {
                                    console.log("send to applicantion manager");
                                }).catch(function (err) {
                                    console.log(err);
                                });
                            }
                        }
                        catch (err) {
                            console.log(err);
                        }
                    }).catch(function (err) {
                        console.log(err);
                    });
                }).catch(function (err) {
                    console.log("save error " + err);
                });
            }
            else {
                console.log(err);
            }
        });
    }
});
app.get("/", function (req, res) {
    res.json({ online: true });
});
function authcouch(user, password, db) {
    return new Promise(function (resolve, reject) {
        rpj.get(COUCHDB.for(user, password, db)).then(function () {
            resolve({ success: true });
        }).catch(function (err) {
            reject({ error: "wrong credentials" });
        });
    });
}
function authorizesocket(profile) {
    return jwt.sign(profile, conf.secret, { expiresInMinutes: 60 * 5 });
}
app.post("/login", function (req, res) {
    authcouch(req.body.user, req.body.password, req.body.db).then(function () {
        var token = authorizesocket({ user: req.body.user, password: req.body.password, db: req.body.db, serial: req.body.serial });
        res.json({ success: true, token: token });
    }).catch(function (err) {
        res.json(err);
    });
});
app.get("/ip", function (req, res) {
    res.json({ ip: req.headers["x-forwarded-for"] });
});
app.get("/sockets", function (req, res) {
    res.json(Machines.sockets());
});
app.get("/machines/:serial/sockets", function (req, res) {
    res.json(Machines.sockets(req.params.serial));
});
app.get("/machines", function (req, res) {
    res.json(Machines.list());
});
app.get("/app/:app/machines", function (req, res) {
});
app.get("/machines/:serial/message/:message", function (req, res) {
    _.map(Machines.ios(req.params.serial), function (socket) {
        socket.emit("message", req.params.message);
    });
    res.json({});
});
app.post("/machines/:serial/message", function (req, res) {
    _.map(Machines.list(req.params.serial), function (socketid) {
        io.to(socketid).emit("message", req.body.data);
    });
});
app.post("/machines/:serial/data", function (req, res) {
    _.map(Machines.list(req.params.serial), function (socketid) {
        io.to(socketid).emit("data", req.body.data);
    });
});
app.post("/machines/:serial/exec", function (req, res) {
    _.map(Machines.list(req.params.serial), function (socketid) {
        io.to(socketid).emit("exec", req.body.data);
    });
});
app.post("/machines/:serial/npm", function (req, res) {
    _.map(Machines.list(req.params.serial), function (socketid) {
        io.to(socketid).emit("npm", req.body.data);
    });
});
app.post("/machines/:serial/task", function (req, res) {
    _.map(Machines.list(req.params.serial), function (socketid) {
        io.to(socketid).emit("task", req.body.data);
    });
});
io.on("connection", function (socket) {
    var c = socket.decoded_token;
    if (c.db) {
        console.log(c.db);
        Machines.add(c.user, c.password, c.db, c.serial, socket);
        _.map(Auditors.forserial(c.serial), function (socketid) {
            io.to(socketid).emit("machine connection", { serial: c.serial });
        });
        socket.on("disconnect", function () {
            _.map(Auditors.forserial(c.serial), function (socketid) {
                io.to(socketid).emit("machine disconnection", { serial: c.serial });
            });
            Machines.remove(c.serial, socket.id);
        });
        socket.on("message", function (message) {
            Machines.pushdata(c.serial, "message", message).then(function (docs) {
                _.map(Auditors.forserial(c.serial), function (socketid) {
                    io.to(socketid).emit("machine message", { serial: c.serial, data: message });
                });
            });
        });
        socket.on("data", function (data) {
            Machines.pushdata(c.serial, "data", data).then(function (docs) {
                _.map(Auditors.forserial(c.serial), function (socketid) {
                    io.to(socketid).emit("machine data", { serial: c.serial, data: data });
                });
            });
        });
        socket.on("docs", function (docs) {
            Machines.pushdata(c.serial, "docs", docs).then(function (docs) {
                _.map(Auditors.forserial(c.serial), function (socketid) {
                    io.to(socketid).emit("machine docs", { serial: c.serial, data: docs });
                });
            });
        });
        socket.on("up", function (datas) {
            _.map(Auditors.forserial(c.serial), function (socketid) {
                io.to(socketid).emit("machine up", { serial: c.serial });
            });
        });
    }
    else {
        Auditors.add(c.serials, socket.id);
        socket.on("disconnect", function () {
            Auditors.remove(socket.id);
        });
    }
    console.log("hello! ", socket.id);
});

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImluZGV4LnRzIl0sIm5hbWVzIjpbImF1dGhjb3VjaCIsImF1dGhvcml6ZXNvY2tldCJdLCJtYXBwaW5ncyI6IkFBQUEsSUFBWSxHQUFHLFdBQU0sS0FBSyxDQUFDLENBQUE7QUFDM0IsSUFBWSxDQUFDLFdBQU0sUUFBUSxDQUFDLENBQUE7QUFDNUIsSUFBWSxPQUFPLFdBQU0sVUFBVSxDQUFDLENBQUE7QUFDcEMsSUFBWSxVQUFVLFdBQU0sYUFBYSxDQUFDLENBQUE7QUFDMUMsSUFBWSxVQUFVLFdBQU0sYUFBYSxDQUFDLENBQUE7QUFDMUMsSUFBWSxFQUFFLFdBQU0sV0FBVyxDQUFDLENBQUE7QUFDaEMsSUFBWSxPQUFPLFdBQU0sU0FBUyxDQUFDLENBQUE7QUFDbkMsSUFBWSxHQUFHLFdBQU0sY0FBYyxDQUFDLENBQUE7QUFHcEMsSUFBSSxNQUFNLEdBQUcsT0FBTyxDQUFDLGlCQUFpQixDQUFDLENBQUM7QUFHeEMsSUFBTyxhQUFhLFdBQVcsZUFBZSxDQUFDLENBQUM7QUFFaEQsSUFBTyxXQUFXLFdBQVcsdUJBQXVCLENBQUMsQ0FBQztBQUN0RCxJQUFPLFVBQVUsV0FBVyxzQkFBc0IsQ0FBQyxDQUFDO0FBRXBELElBQUksV0FBVyxHQUFHLE9BQU8sQ0FBQyxjQUFjLENBQUMsQ0FBQztBQUMxQyxJQUFJLEdBQUcsR0FBRyxPQUFPLENBQUMsc0JBQXNCLENBQUMsQ0FBQztBQUMxQyxJQUFJLEtBQUssR0FBRyxPQUFPLENBQUMsT0FBTyxDQUFDLENBQUM7QUFHN0IsSUFBSSxHQUFHLEdBQUcsT0FBTyxFQUFFLENBQUM7QUFDcEIsSUFBSSxNQUFNLEdBQUcsT0FBTyxDQUFDLE1BQU0sQ0FBQyxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsQ0FBQztBQUN6QyxJQUFJLEVBQUUsR0FBRyxFQUFFLENBQUMsTUFBTSxDQUFDLENBQUM7QUFNcEIsRUFBRSxDQUFDLENBQUMsQ0FBQyxVQUFVLENBQUMsSUFBSSxDQUFDLGFBQWEsQ0FBQyxDQUFDLENBQUMsQ0FBQztJ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QUFDLE1BQU0sQ0FBQyxNQUFNLENBQUMsRUFBRSxVQUFTLFFBQVE7UUFDckQsRUFBRSxDQUFDLEVBQUUsQ0FBQyxRQUFRLENBQUMsQ0FBQyxJQUFJLENBQUMsU0FBUyxFQUFFLEdBQUcsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUM7SUFDbkQsQ0FBQyxDQUFDLENBQUM7QUFFUCxDQUFDLENBQUMsQ0FBQztBQUNILEdBQUcsQ0FBQyxJQUFJLENBQUMsd0JBQXdCLEVBQUUsVUFBUyxHQUFHLEVBQUUsR0FBRztJQUNoRCxDQUFDLENBQUMsR0FBRyxDQUFDLFFBQVEsQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLE1BQU0sQ0FBQyxNQUFNLENBQUMsRUFBRSxVQUFTLFFBQVE7UUFDckQsRUFBRSxDQUFDLEVBQUUsQ0FBQyxRQUFRLENBQUMsQ0FBQyxJQUFJLENBQUMsTUFBTSxFQUFFLEdBQUcsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUM7SUFDaEQsQ0FBQyxDQUFDLENBQUM7QUFDUCxDQUFDLENBQUMsQ0FBQztBQUNILEdBQUcsQ0FBQyxJQUFJLENBQUMsd0JBQXdCLEVBQUUsVUFBUyxHQUFHLEVBQUUsR0FBRztJQUNoRCxDQUFDLENBQUMsR0FBRyxDQUFDLFFBQVEsQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLE1BQU0sQ0FBQyxNQUFNLENBQUMsRUFBRSxVQUFTLFFBQVE7UUFDckQsRUFBRSxDQUFDLEVBQUUsQ0FBQyxRQUFRLENBQUMsQ0FBQyxJQUFJLENBQUMsTUFBTSxFQUFFLEdBQUcsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUM7SUFDaEQsQ0FBQyxDQUFDLENBQUM7QUFDUCxDQUFDLENBQUMsQ0FBQztBQUNILEdBQUcsQ0FBQyxJQUFJLENBQUMsdUJBQXVCLEVBQUUsVUFBUyxHQUFHLEVBQUUsR0FBRztJQUMvQyxDQUFDLENBQUMsR0FBRyxDQUFDLFFBQVEsQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLE1BQU0sQ0FBQyxNQUFNLENBQUMsRUFBRSxVQUFTLFFBQVE7UUFDckQs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QyxDQUFDLE1BQU0sRUFBRSxDQUFDLENBQUM7WUFDN0QsQ0FBQyxDQUFDLENBQUM7UUFDUCxDQUFDLENBQUMsQ0FBQztJQUVQLENBQUM7SUFBQyxJQUFJLENBQUMsQ0FBQztRQUNKLFFBQVEsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLE9BQU8sRUFBRSxNQUFNLENBQUMsRUFBRSxDQUFDLENBQUM7UUFDbkMsTUFBTSxDQUFDLEVBQUUsQ0FBQyxZQUFZLEVBQUU7WUFDcEIsUUFBUSxDQUFDLE1BQU0sQ0FBQyxNQUFNLENBQUMsRUFBRSxDQUFDLENBQUM7UUFDL0IsQ0FBQyxDQUFDLENBQUM7SUFFUCxDQUFDO0lBRUQsT0FBTyxDQUFDLEdBQUcsQ0FBQyxTQUFTLEVBQUUsTUFBTSxDQUFDLEVBQUUsQ0FBQyxDQUFDO0FBQ3RDLENBQUMsQ0FBQyxDQUFDIiwiZmlsZSI6ImluZGV4LmpzIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0ICogYXMgbmV0IGZyb20gXCJuZXRcIjtcbmltcG9ydCAqIGFzIF8gZnJvbSBcImxvZGFzaFwiO1xuaW1wb3J0ICogYXMgUHJvbWlzZSBmcm9tIFwiYmx1ZWJpcmRcIjtcbmltcG9ydCAqIGFzIGJvZHlQYXJzZXIgZnJvbSBcImJvZHktcGFyc2VyXCI7XG5pbXBvcnQgKiBhcyBwYXRoRXhpc3RzIGZyb20gXCJwYXRoLWV4aXN0c1wiO1xuaW1wb3J0ICogYXMgSU8gZnJvbSBcInNvY2tldC5pb1wiO1xuaW1wb3J0ICogYXMgZXhwcmVzcyBmcm9tIFwiZXhwcmVzc1wiO1xuaW1wb3J0ICogYXMgand0IGZyb20gXCJqc29ud2VidG9rZW5cIjtcbmltcG9ydCAqIGFzIHJlZGlzIGZyb20gXCJyZWRpc1wiO1xuXG5sZXQgbW9tZW50ID0gcmVxdWlyZShcIm1vbWVudC10aW1lem9uZVwiKTtcblxuXG5pbXBvcnQgY291Y2hqc29uY29uZiA9IHJlcXVpcmUoXCJjb3VjaGpzb25jb25mXCIpO1xuXG5pbXBvcnQgbWFjaENsaWVudHMgPSByZXF1aXJlKFwiLi9tb2R1bGVzL21hY2hDbGllbnRzXCIpO1xuaW1wb3J0IGF1ZENsaWVudHMgPSByZXF1aXJlKFwiLi9tb2R1bGVzL2F1ZENsaWVudHNcIik7XG5cbmxldCBzb2NrZXRpb0p3dCA9IHJlcXVpcmUoXCJzb2NrZXRpby1qd3RcIik7XG5sZXQgcnBqID0gcmVxdWlyZShcInJlcXVlc3QtcHJvbWlzZS1qc29uXCIpO1xubGV0IGFlZGVzID0gcmVxdWlyZShcImFlZGVzXCIpO1xuXG5cbmxldCBhcHAgPSBleHByZXNzKCk7XG5sZXQgc2VydmVyID0gcmVxdWlyZShcImh0dHBcIikuU2VydmVyKGFwcCk7XG5sZXQgaW8gPSBJTyhzZXJ2ZXIpO1xuXG5cblxuXG5cbmlmICghcGF0aEV4aXN0cy5zeW5jKFwiLi9jb25mLmpzb25cIikpIHtcbiAgICB0aHJvdyBFcnJvcihcIm5vIGNvbmZpZ3VyYXRpb24gZm91bmRlZFwiKTtcbn1cbmxldCBjb25mID0gcmVxdWlyZShcIi4vY29uZi5qc29uXCIpO1xuXG5sZXQgQ09VQ0hEQiA9IG5ldyBjb3VjaGpzb25jb25mKGNvbmYuY291Y2hkYik7XG5cbmxldCBNYWNoaW5lcyA9IG5ldyBtYWNoQ2xpZW50cyhDT1VDSERCKTtcbmxldCBBdWRpdG9ycyA9IG5ldyBhdWRDbGllbnRzKCk7XG5cbi8vIHBhcnNlIGFwcGxpY2F0aW9uL3gtd3d3LWZvcm0tdXJsZW5jb2RlZFxuYXBwLnVzZShib2R5UGFyc2VyLnVybGVuY29kZWQoeyBleHRlbmRlZDogZmFsc2UgfSkpO1xuXG4vLyBwYXJzZSBhcHBsaWNhdGlvbi9qc29uXG5hcHAudXNlKGJvZHlQYXJzZXIuanNvbigpKTtcblxuXG5cbmlvLnVzZShzb2NrZXRpb0p3dC5hdXRob3JpemUoe1xuICAgIHNlY3JldDogY29uZi5zZWNyZXQsXG4gICAgaGFuZHNoYWtlOiB0cnVlXG59KSk7XG5cbnNlcnZlci5saXN0ZW4oY29uZi5wb3J0KTtcblxuXG5sZXQgQWVkZXMgPSBhZWRlcygpO1xubGV0IEFzZXJ2ZXIgPSBuZXQuY3JlYXRlU2VydmVyKEFlZGVzLmhhbmRsZSk7XG5cbkFzZXJ2ZXIubGlzdGVuKDE4ODMsIGZ1bmN0aW9uKCkge1xuICAgIGNvbnNvbGUubG9nKFwiTVFUVCBzZXJ2ZXIgbGlzdGVuaW5nIG9uIHBvcnRcIiwgMTg4Myk7XG59KTtcblxuXG5BZWRlcy5hdXRoZW50aWNhdGUgPSBmdW5jdGlvbihjbGllbnQsIHVzZXJuYW1lLCB0b2tlbiwgY2FsbGJhY2spIHtcblxuXG4gICAgaWYgKGNvbmYuYWRtaW4udXNlcm5hbWUgPT09IHVzZXJuYW1lKSB7XG5cbiAgICAgICAgaWYgKHRva2VuID09PSBjb25mLmFkbWluLnBhc3N3b3JkKSB7XG4gICAgICAgICAgICBjYWxsYmFjayhudWxsLCB0cnVlKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKFwidW5hdXRob3JpemVkIFwiICsgdXNlcm5hbWUpO1xuICAgICAgICAgICAgY2FsbGJhY2sobnVsbCk7XG4gICAgICAgIH1cblxuXG4gICAgfSBlbHNlIHtcblxuICAgICAgICB0cnkge1xuXG5cblxuICAgICAgICAgICAgbGV0IGRlY29kZWQ6IGFueSA9IGp3dC52ZXJpZnkoSlNPTi5wYXJzZSh0b2tlbiArIFwiXCIpLCBjb25mLnNlY3JldCwgeyBpZ25vcmVFeHBpcmF0aW9uOiB0cnVlIH0pOyAvLyB0byBiZSBjaGFuZ2VkIGluIHZlcmlmeVxuICAgICAgICAgICAgbGV0IGRiID0gZGVjb2RlZC5kYjtcbiAgICAgICAgICAgIGxldCBwYXNzd29yZCA9IGRlY29kZWQucGFzc3dvcmQ7XG4gICAgICAgICAgICBjb25zb2xlLmxvZyhcImF1dGhcIik7XG5cblxuICAgICAgICAgICAgLy8gXG4gICAgICAgICAgICBhdXRoY291Y2godXNlcm5hbWUsIHBhc3N3b3JkLCBkYikudGhlbihmdW5jdGlvbigpIHtcbiAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhcImF1dGhvcml6ZWQgXCIgKyB1c2VybmFtZSk7XG4gICAgICAgICAgICAgICAgY2xpZW50LnNlcmlhbCA9IGRlY29kZWQuc2VyaWFsO1xuICAgICAgICAgICAgICAgIGNsaWVudC5jb3VjaCA9IHsgdXNlcm5hbWU6IHVzZXJuYW1lLCBwYXNzd29yZDogcGFzc3dvcmQsIGRiOiBkYiB9O1xuICAgICAgICAgICAgICAgIGNhbGxiYWNrKG51bGwsIHRydWUpO1xuICAgICAgICAgICAgfSkuY2F0Y2goZnVuY3Rpb24oKSB7XG4gICAgICAgICAgICAgICAgY29uc29sZS5sb2coXCJ1bmF1dGhvcml6ZWQgXCIgKyB1c2VybmFtZSk7XG4gICAgICAgICAgICAgICAgY2FsbGJhY2sobnVsbCk7XG4gICAgICAgICAgICB9KTtcblxuXG4gICAgICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgICAgICAgY29uc29sZS5sb2coXCJ1bmF1dGhvcml6ZWQgXCIgKyB1c2VybmFtZSk7XG4gICAgICAgICAgICBjYWxsYmFjayhudWxsKTtcbiAgICAgICAgfVxuXG4gICAgfVxuXG59O1xuXG5BZWRlcy5vbihcImNsaWVudFwiLCBmdW5jdGlvbihjbGllbnQpIHtcblxuXG4gICAgY29uc29sZS5sb2coXCJuZXcgY2xpZW50XCIgKyBjbGllbnQuaWQpO1xuXG5cblxufSk7XG5cbkFlZGVzLm9uKFwiY2xpZW50RGlzY29ubmVjdFwiLCBmdW5jdGlvbihjbGllbnQpIHtcbiAgICBjb25zb2xlLmxvZyhcImNsaWVudERpc2Nvbm5lY3RcIik7XG59KTtcblxuQWVkZXMub24oXCJzdWJzY3JpYmVcIiwgZnVuY3Rpb24odG9waWMsIGNsaWVudCkge1xuICAgIGNvbnNvbGUubG9nKFwic3Vic2NyaWJlXCIpO1xufSk7XG5cbkFlZGVzLm9uKFwidW5zdWJzY3JpYmVcIiwgZnVuY3Rpb24odG9waWMsIGNsaWVudCkge1xuICAgIGNvbnNvbGUubG9nKFwidW5zdWJzY3JpYmVcIik7XG59KTtcblxuQWVkZXMub24oXCJwdWJsaXNoXCIsIGZ1bmN0aW9uKHBhY2tldCwgY2xpZW50KSB7XG5cbiAgICBpZiAoIWNsaWVudCkgcmV0dXJuO1xuXG4gICAgbGV0IG9iaiA9IEpTT04ucGFyc2UocGFja2V0LnBheWxvYWQudG9TdHJpbmcoKSk7XG4gICAgY29uc29sZS5sb2coXCJwdWJsaXNoXCIpO1xuXG5cblxuICAgIGlmIChwYWNrZXQudG9waWMuc3BsaXQoXCIvXCIpLmxlbmd0aCA+IDEgJiYgcGFja2V0LnRvcGljLnNwbGl0KFwiL1wiKVswXSA9PT0gXCJkYXRhXCIgJiYgY2xpZW50LmNvdWNoICYmIGNsaWVudC5jb3VjaCAmJiBjbGllbnQuY291Y2gudXNlcm5hbWUpIHtcbiAgICAgICAgLy8gICAgcnBqLnBvc3QoKVxuXG5cbiAgICAgICAgLy8gUEFUQ0ggVE8gQkUgUkVNT1ZFRERERFxuICAgICAgICBpZiAoY2xpZW50LmNvdWNoLmRiID09PSBcIm1hY2hfcGN0dDN2X2VuZXJneXRyYWNrXCIgfHwgY2xpZW50LmNvdWNoLmRiID09PSBcIm1hY2hfc3hjbTBxX2VuZXJneXRyYWNrXCIpIHsgLy8gUEFUQ0ggVE8gQkUgUkVNT1ZFRERERFxuICAgICAgICAgICAgb2JqLnVwZGF0ZWRBdCA9IG9iai51cGRhdGVkQXQgKyAzNjAwMDAwO1xuICAgICAgICAgICAgb2JqLmRhdGUgPSBtb21lbnQudHoob2JqLnVwZGF0ZWRBdCwgXCJFdXJvcGUvUm9tZVwiKS5mb3JtYXQoXCJZWVlZTU1ERC1ISDptbTpzc1wiKTtcbiAgICAgICAgfVxuICAgICAgICBjb25zb2xlLmxvZyhcInNhdmVcIik7XG4gICAgICAgIHJwai5nZXQoXCJodHRwOi8vXCIgKyBjbGllbnQuY291Y2gudXNlcm5hbWUgKyBcIjpcIiArIGNsaWVudC5jb3VjaC5wYXNzd29yZCArIFwiQDE5Mi4xNjguMTIyLjQ0OjU5ODQvXCIgKyBjbGllbnQuY291Y2guZGIgKyBcIi9cIiArIG9iai5faWQpLnRoZW4oZnVuY3Rpb24oZCkge1xuICAgICAgICAgICAgb2JqLl9yZXYgPSBkLl9yZXY7XG4gICAgICAgICAgICBycGoucHV0KFwiaHR0cDovL1wiICsgY2xpZW50LmNvdWNoLnVzZXJuYW1lICsgXCI6XCIgKyBjbGllbnQuY291Y2gucGFzc3dvcmQgKyBcIkAxOTIuMTY4LjEyMi40NDo1OTg0L1wiICsgY2xpZW50LmNvdWNoLmRiICsgXCIvXCIgKyBvYmouX2lkLCBvYmopLnRoZW4oZnVuY3Rpb24oKSB7XG4gICAgICAgICAgICAgICAgY29uc29sZS5sb2coXCJiYWNrdXBcIik7XG5cblxuICAgICAgICAgICAgICAgIHJwai5nZXQoXCJodHRwOi8vXCIgKyBjbGllbnQuY291Y2gudXNlcm5hbWUgKyBcIjpcIiArIGNsaWVudC5jb3VjaC5wYXNzd29yZCArIFwiQDE5Mi4xNjguMTIyLjQ0OjU5ODQvXCIgKyBjbGllbnQuY291Y2guZGIgKyBcIi9ob29rc1wiKS50aGVuKGZ1bmN0aW9uKGRhdGEpIHtcblxuXG4gICAgICAgICAgICAgICAgICAgIHRyeSB7XG5cbiAgICAgICAgICAgICAgICAgICAgICAgIGxldCBob29rdXJsID0gZGF0YVtwYWNrZXQudG9waWMuc3BsaXQoXCIvXCIpWzBdXTtcblxuICAgICAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coaG9va3VybCk7XG5cbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChkYXRhW3BhY2tldC50b3BpYy5zcGxpdChcIi9cIilbMF1dKSB7XG5cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBycGoucG9zdChob29rdXJsICsgXCIvXCIgKyBjbGllbnQuc2VyaWFsICsgXCIvXCIgKyBjbGllbnQuY291Y2guZGIgKyBcIi9cIiArIGNsaWVudC5jb3VjaC51c2VybmFtZSArIFwiL1wiICsgY2xpZW50LmNvdWNoLnBhc3N3b3JkLCB7IGRhdGE6IG9iaiB9KS50aGVuKGZ1bmN0aW9uKGJybykge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhcInNlbmQgdG8gYXBwbGljYW50aW9uIG1hbmFnZXJcIik7XG5cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KS5jYXRjaChmdW5jdGlvbihlcnIpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coZXJyKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KTtcblxuXG5cbiAgICAgICAgICAgICAgICAgICAgICAgIH1cblxuXG4gICAgICAgICAgICAgICAgICAgIH0gY2F0Y2ggKGVycikge1xuXG4gICAgICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhlcnIpO1xuXG4gICAgICAgICAgICAgICAgICAgIH1cblxuXG4gICAgICAgICAgICAgICAgfSkuY2F0Y2goZnVuY3Rpb24oZXJyKSB7XG4gICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKGVycik7XG4gICAgICAgICAgICAgICAgfSk7XG5cblxuXG5cbiAgICAgICAgICAgIH0pLmNhdGNoKGZ1bmN0aW9uKGVycikge1xuICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKFwic2F2ZSBlcnJvciBcIiArIGVycik7XG4gICAgICAgICAgICB9KTtcblxuICAgICAgICB9KS5jYXRjaChmdW5jdGlvbihlcnIpIHtcbiAgICAgICAgICAgIGlmIChlcnIuc3RhdHVzQ29kZSA9PT0gNDA0KSB7XG4gICAgICAgICAgICAgICAgcnBqLnB1dChcImh0dHA6Ly9cIiArIGNsaWVudC5jb3VjaC51c2VybmFtZSArIFwiOlwiICsgY2xpZW50LmNvdWNoLnBhc3N3b3JkICsgXCJAMTkyLjE2OC4xMjIuNDQ6NTk4NC9cIiArIGNsaWVudC5jb3VjaC5kYiArIFwiL1wiICsgb2JqLl9pZCwgb2JqKS50aGVuKGZ1bmN0aW9uKCkge1xuICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhcImJhY2t1cFwiKTtcblxuXG4gICAgICAgICAgICAgICAgICAgIHJwai5nZXQoXCJodHRwOi8vXCIgKyBjbGllbnQuY291Y2gudXNlcm5hbWUgKyBcIjpcIiArIGNsaWVudC5jb3VjaC5wYXNzd29yZCArIFwiQDE5Mi4xNjguMTIyLjQ0OjU5ODQvXCIgKyBjbGllbnQuY291Y2guZGIgKyBcIi9ob29rc1wiKS50aGVuKGZ1bmN0aW9uKGRhdGEpIHtcblxuXG4gICAgICAgICAgICAgICAgICAgICAgICB0cnkge1xuXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgbGV0IGhvb2t1cmwgPSBkYXRhW3BhY2tldC50b3BpYy5zcGxpdChcIi9cIilbMF1dO1xuXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coaG9va3VybCk7XG5cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoZGF0YVtwYWNrZXQudG9waWMuc3BsaXQoXCIvXCIpWzBdXSkge1xuXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJwai5wb3N0KGhvb2t1cmwgKyBcIi9cIiArIGNsaWVudC5zZXJpYWwgKyBcIi9cIiArIGNsaWVudC5jb3VjaC5kYiArIFwiL1wiICsgY2xpZW50LmNvdWNoLnVzZXJuYW1lICsgXCIvXCIgKyBjbGllbnQuY291Y2gucGFzc3dvcmQsIHsgZGF0YTogb2JqIH0pLnRoZW4oZnVuY3Rpb24oYnJvKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhcInNlbmQgdG8gYXBwbGljYW50aW9uIG1hbmFnZXJcIik7XG5cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSkuY2F0Y2goZnVuY3Rpb24oZXJyKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhlcnIpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KTtcblxuXG5cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG5cblxuICAgICAgICAgICAgICAgICAgICAgICAgfSBjYXRjaCAoZXJyKSB7XG5cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhlcnIpO1xuXG4gICAgICAgICAgICAgICAgICAgICAgICB9XG5cblxuICAgICAgICAgICAgICAgICAgICB9KS5jYXRjaChmdW5jdGlvbihlcnIpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKGVycik7XG4gICAgICAgICAgICAgICAgICAgIH0pO1xuXG5cblxuICAgICAgICAgICAgICAgIH0pLmNhdGNoKGZ1bmN0aW9uKGVycikge1xuICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhcInNhdmUgZXJyb3IgXCIgKyBlcnIpO1xuICAgICAgICAgICAgICAgIH0pO1xuXG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKGVycik7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgfSk7XG5cblxuICAgIH1cblxuXG5cblxufSk7XG5cblxuaW50ZXJmYWNlIElTb2NrZXQge1xuXG4gICAgaWQ6IHN0cmluZztcbiAgICBlbWl0OiBGdW5jdGlvbjtcbiAgICBvbjogRnVuY3Rpb247XG4gICAgZGVjb2RlZF90b2tlbjoge1xuICAgICAgICBkYjogc3RyaW5nO1xuICAgICAgICB1c2VyOiBzdHJpbmc7XG4gICAgICAgIHBhc3N3b3JkOiBzdHJpbmc7XG4gICAgICAgIHNlcmlhbDogc3RyaW5nO1xuICAgICAgICBzZXJpYWxzOiBzdHJpbmdbXVxuICAgIH07XG59XG5cblxuXG5cbmFwcC5nZXQoXCIvXCIsIGZ1bmN0aW9uKHJlcSwgcmVzKSB7XG4gICAgcmVzLmpzb24oeyBvbmxpbmU6IHRydWUgfSk7XG59KTtcblxuXG5cblxuZnVuY3Rpb24gYXV0aGNvdWNoKHVzZXI6IHN0cmluZywgcGFzc3dvcmQ6IHN0cmluZywgZGI6IHN0cmluZykge1xuICAgIHJldHVybiBuZXcgUHJvbWlzZShmdW5jdGlvbihyZXNvbHZlLCByZWplY3QpIHtcbiAgICAgICAgcnBqLmdldChDT1VDSERCLmZvcih1c2VyLCBwYXNzd29yZCwgZGIpKS50aGVuKGZ1bmN0aW9uKCkge1xuICAgICAgICAgICAgcmVzb2x2ZSh7IHN1Y2Nlc3M6IHRydWUgfSk7XG4gICAgICAgIH0pLmNhdGNoKGZ1bmN0aW9uKGVycikge1xuICAgICAgICAgICAgcmVqZWN0KHsgZXJyb3I6IFwid3JvbmcgY3JlZGVudGlhbHNcIiB9KTtcbiAgICAgICAgfSk7XG4gICAgfSk7XG59XG5cbmZ1bmN0aW9uIGF1dGhvcml6ZXNvY2tldChwcm9maWxlKToge30ge1xuICAgIHJldHVybiBqd3Quc2lnbihwcm9maWxlLCBjb25mLnNlY3JldCwgeyBleHBpcmVzSW5NaW51dGVzOiA2MCAqIDUgfSk7XG59XG5cbmFwcC5wb3N0KFwiL2xvZ2luXCIsIGZ1bmN0aW9uKHJlcSwgcmVzKSB7XG4gICAgYXV0aGNvdWNoKHJlcS5ib2R5LnVzZXIsIHJlcS5ib2R5LnBhc3N3b3JkLCByZXEuYm9keS5kYikudGhlbihmdW5jdGlvbigpIHtcblxuICAgICAgICBsZXQgdG9rZW4gPSBhdXRob3JpemVzb2NrZXQoeyB1c2VyOiByZXEuYm9keS51c2VyLCBwYXNzd29yZDogcmVxLmJvZHkucGFzc3dvcmQsIGRiOiByZXEuYm9keS5kYiwgc2VyaWFsOiByZXEuYm9keS5zZXJpYWwgfSk7XG5cbiAgICAgICAgcmVzLmpzb24oeyBzdWNjZXNzOiB0cnVlLCB0b2tlbjogdG9rZW4gfSk7XG4gICAgfSkuY2F0Y2goZnVuY3Rpb24oZXJyKSB7XG4gICAgICAgIHJlcy5qc29uKGVycik7XG4gICAgfSk7XG59KTtcblxuYXBwLmdldChcIi9pcFwiLCBmdW5jdGlvbihyZXEsIHJlcykge1xuICAgIHJlcy5qc29uKHsgaXA6IHJlcS5oZWFkZXJzW1wieC1mb3J3YXJkZWQtZm9yXCJdIH0pO1xufSk7XG5cbmFwcC5nZXQoXCIvc29ja2V0c1wiLCBmdW5jdGlvbihyZXEsIHJlcykge1xuICAgIHJlcy5qc29uKE1hY2hpbmVzLnNvY2tldHMoKSk7XG59KTtcbmFwcC5nZXQoXCIvbWFjaGluZXMvOnNlcmlhbC9zb2NrZXRzXCIsIGZ1bmN0aW9uKHJlcSwgcmVzKSB7XG4gICAgcmVzLmpzb24oTWFjaGluZXMuc29ja2V0cyhyZXEucGFyYW1zLnNlcmlhbCkpO1xufSk7XG5hcHAuZ2V0KFwiL21hY2hpbmVzXCIsIGZ1bmN0aW9uKHJlcSwgcmVzKSB7XG4gICAgcmVzLmpzb24oTWFjaGluZXMubGlzdCgpKTtcbn0pO1xuYXBwLmdldChcIi9hcHAvOmFwcC9tYWNoaW5lc1wiLCBmdW5jdGlvbihyZXEsIHJlcykge1xuICAgIC8vIHJlcy5qc29uKE1hY2hpbmVzLnNlcmlhbHMoKSlcbn0pO1xuXG5hcHAuZ2V0KFwiL21hY2hpbmVzLzpzZXJpYWwvbWVzc2FnZS86bWVzc2FnZVwiLCBmdW5jdGlvbihyZXEsIHJlcykge1xuICAgIF8ubWFwKE1hY2hpbmVzLmlvcyhyZXEucGFyYW1zLnNlcmlhbCksIGZ1bmN0aW9uKHNvY2tldCkge1xuICAgICAgICBzb2NrZXQuZW1pdChcIm1lc3NhZ2VcIiwgcmVxLnBhcmFtcy5tZXNzYWdlKTtcblxuICAgIH0pO1xuICAgIHJlcy5qc29uKHt9KTtcblxufSk7XG5cbmFwcC5wb3N0KFwiL21hY2hpbmVzLzpzZXJpYWwvbWVzc2FnZVwiLCBmdW5jdGlvbihyZXEsIHJlcykge1xuICAgIF8ubWFwKE1hY2hpbmVzLmxpc3QocmVxLnBhcmFtcy5zZXJpYWwpLCBmdW5jdGlvbihzb2NrZXRpZCkge1xuICAgICAgICBpby50byhzb2NrZXRpZCkuZW1pdChcIm1lc3NhZ2VcIiwgcmVxLmJvZHkuZGF0YSk7XG4gICAgfSk7XG5cbn0pO1xuYXBwLnBvc3QoXCIvbWFjaGluZXMvOnNlcmlhbC9kYXRhXCIsIGZ1bmN0aW9uKHJlcSwgcmVzKSB7XG4gICAgXy5tYXAoTWFjaGluZXMubGlzdChyZXEucGFyYW1zLnNlcmlhbCksIGZ1bmN0aW9uKHNvY2tldGlkKSB7XG4gICAgICAgIGlvLnRvKHNvY2tldGlkKS5lbWl0KFwiZGF0YVwiLCByZXEuYm9keS5kYXRhKTtcbiAgICB9KTtcbn0pO1xuYXBwLnBvc3QoXCIvbWFjaGluZXMvOnNlcmlhbC9leGVjXCIsIGZ1bmN0aW9uKHJlcSwgcmVzKSB7XG4gICAgXy5tYXAoTWFjaGluZXMubGlzdChyZXEucGFyYW1zLnNlcmlhbCksIGZ1bmN0aW9uKHNvY2tldGlkKSB7XG4gICAgICAgIGlvLnRvKHNvY2tldGlkKS5lbWl0KFwiZXhlY1wiLCByZXEuYm9keS5kYXRhKTtcbiAgICB9KTtcbn0pO1xuYXBwLnBvc3QoXCIvbWFjaGluZXMvOnNlcmlhbC9ucG1cIiwgZnVuY3Rpb24ocmVxLCByZXMpIHtcbiAgICBfLm1hcChNYWNoaW5lcy5saXN0KHJlcS5wYXJhbXMuc2VyaWFsKSwgZnVuY3Rpb24oc29ja2V0aWQpIHtcbiAgICAgICAgaW8udG8oc29ja2V0aWQpLmVtaXQoXCJucG1cIiwgcmVxLmJvZHkuZGF0YSk7XG4gICAgfSk7XG59KTtcbmFwcC5wb3N0KFwiL21hY2hpbmVzLzpzZXJpYWwvdGFza1wiLCBmdW5jdGlvbihyZXEsIHJlcykge1xuICAgIF8ubWFwKE1hY2hpbmVzLmxpc3QocmVxLnBhcmFtcy5zZXJpYWwpLCBmdW5jdGlvbihzb2NrZXRpZCkge1xuICAgICAgICBpby50byhzb2NrZXRpZCkuZW1pdChcInRhc2tcIiwgcmVxLmJvZHkuZGF0YSk7XG4gICAgfSk7XG59KTtcblxuaW8ub24oXCJjb25uZWN0aW9uXCIsIGZ1bmN0aW9uKHNvY2tldDogSVNvY2tldCkge1xuICAgIGxldCBjID0gc29ja2V0LmRlY29kZWRfdG9rZW47XG5cbiAgICBpZiAoYy5kYikge1xuICAgICAgICBjb25zb2xlLmxvZyhjLmRiKTtcblxuICAgICAgICBNYWNoaW5lcy5hZGQoYy51c2VyLCBjLnBhc3N3b3JkLCBjLmRiLCBjLnNlcmlhbCwgc29ja2V0KTtcbiAgICAgICAgXy5tYXAoQXVkaXRvcnMuZm9yc2VyaWFsKGMuc2VyaWFsKSwgZnVuY3Rpb24oc29ja2V0aWQpIHtcbiAgICAgICAgICAgIGlvLnRvKHNvY2tldGlkKS5lbWl0KFwibWFjaGluZSBjb25uZWN0aW9uXCIsIHsgc2VyaWFsOiBjLnNlcmlhbCB9KTtcbiAgICAgICAgfSk7XG5cbiAgICAgICAgc29ja2V0Lm9uKFwiZGlzY29ubmVjdFwiLCBmdW5jdGlvbigpIHtcblxuICAgICAgICAgICAgXy5tYXAoQXVkaXRvcnMuZm9yc2VyaWFsKGMuc2VyaWFsKSwgZnVuY3Rpb24oc29ja2V0aWQpIHtcbiAgICAgICAgICAgICAgICBpby50byhzb2NrZXRpZCkuZW1pdChcIm1hY2hpbmUgZGlzY29ubmVjdGlvblwiLCB7IHNlcmlhbDogYy5zZXJpYWwgfSk7XG4gICAgICAgICAgICB9KTtcblxuICAgICAgICAgICAgTWFjaGluZXMucmVtb3ZlKGMuc2VyaWFsLCBzb2NrZXQuaWQpO1xuICAgICAgICB9KTtcbiAgICAgICAgc29ja2V0Lm9uKFwibWVzc2FnZVwiLCBmdW5jdGlvbihtZXNzYWdlKSB7XG4gICAgICAgICAgICBNYWNoaW5lcy5wdXNoZGF0YShjLnNlcmlhbCwgXCJtZXNzYWdlXCIsIG1lc3NhZ2UpLnRoZW4oZnVuY3Rpb24oZG9jcykge1xuXG4gICAgICAgICAgICAgICAgXy5tYXAoQXVkaXRvcnMuZm9yc2VyaWFsKGMuc2VyaWFsKSwgZnVuY3Rpb24oc29ja2V0aWQpIHtcbiAgICAgICAgICAgICAgICAgICAgaW8udG8oc29ja2V0aWQpLmVtaXQoXCJtYWNoaW5lIG1lc3NhZ2VcIiwgeyBzZXJpYWw6IGMuc2VyaWFsLCBkYXRhOiBtZXNzYWdlIH0pO1xuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgfSk7XG4gICAgICAgIH0pO1xuICAgICAgICBzb2NrZXQub24oXCJkYXRhXCIsIGZ1bmN0aW9uKGRhdGEpIHtcbiAgICAgICAgICAgIE1hY2hpbmVzLnB1c2hkYXRhKGMuc2VyaWFsLCBcImRhdGFcIiwgZGF0YSkudGhlbihmdW5jdGlvbihkb2NzKSB7XG5cbiAgICAgICAgICAgICAgICBfLm1hcChBdWRpdG9ycy5mb3JzZXJpYWwoYy5zZXJpYWwpLCBmdW5jdGlvbihzb2NrZXRpZCkge1xuICAgICAgICAgICAgICAgICAgICBpby50byhzb2NrZXRpZCkuZW1pdChcIm1hY2hpbmUgZGF0YVwiLCB7IHNlcmlhbDogYy5zZXJpYWwsIGRhdGE6IGRhdGEgfSk7XG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfSk7XG4gICAgICAgIHNvY2tldC5vbihcImRvY3NcIiwgZnVuY3Rpb24oZG9jcykge1xuICAgICAgICAgICAgTWFjaGluZXMucHVzaGRhdGEoYy5zZXJpYWwsIFwiZG9jc1wiLCBkb2NzKS50aGVuKGZ1bmN0aW9uKGRvY3MpIHtcbiAgICAgICAgICAgICAgICBfLm1hcChBdWRpdG9ycy5mb3JzZXJpYWwoYy5zZXJpYWwpLCBmdW5jdGlvbihzb2NrZXRpZCkge1xuICAgICAgICAgICAgICAgICAgICBpby50byhzb2NrZXRpZCkuZW1pdChcIm1hY2hpbmUgZG9jc1wiLCB7IHNlcmlhbDogYy5zZXJpYWwsIGRhdGE6IGRvY3MgfSk7XG4gICAgICAgICAgICAgICAgfSk7XG5cbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9KTtcbiAgICAgICAgc29ja2V0Lm9uKFwidXBcIiwgZnVuY3Rpb24oZGF0YXMpIHtcbiAgICAgICAgICAgIF8ubWFwKEF1ZGl0b3JzLmZvcnNlcmlhbChjLnNlcmlhbCksIGZ1bmN0aW9uKHNvY2tldGlkKSB7XG4gICAgICAgICAgICAgICAgaW8udG8oc29ja2V0aWQpLmVtaXQoXCJtYWNoaW5lIHVwXCIsIHsgc2VyaWFsOiBjLnNlcmlhbCB9KTtcbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9KTtcblxuICAgIH0gZWxzZSB7XG4gICAgICAgIEF1ZGl0b3JzLmFkZChjLnNlcmlhbHMsIHNvY2tldC5pZCk7XG4gICAgICAgIHNvY2tldC5vbihcImRpc2Nvbm5lY3RcIiwgZnVuY3Rpb24oKSB7XG4gICAgICAgICAgICBBdWRpdG9ycy5yZW1vdmUoc29ja2V0LmlkKTtcbiAgICAgICAgfSk7XG5cbiAgICB9XG5cbiAgICBjb25zb2xlLmxvZyhcImhlbGxvISBcIiwgc29ja2V0LmlkKTtcbn0pO1xuIl0sInNvdXJjZVJvb3QiOiIvc291cmNlLyJ9
