var net = require("net");
var _ = require("lodash");
var Promise = require("bluebird");
var bodyParser = require("body-parser");
var pathExists = require("path-exists");
var IO = require("socket.io");
var express = require("express");
var jwt = require("jsonwebtoken");
var couchjsonconf = require("couchjsonconf");
var machClients = require("./modules/machClients");
var audClients = require("./modules/audClients");
var socketioJwt = require("socketio-jwt");
var rpj = require('request-promise-json');
var aedes = require("aedes");
var app = express();
var server = require('http').Server(app);
var io = IO(server);
if (!pathExists.sync('./conf.json')) {
    throw Error('no configuration founded');
}
var conf = require('./conf.json');
var COUCHDB = new couchjsonconf(conf.couchdb);
var Machines = new machClients(COUCHDB);
var Auditors = new audClients();
app.use(bodyParser.urlencoded({ extended: false }));
app.use(bodyParser.json());
io.use(socketioJwt.authorize({
    secret: conf.secret,
    handshake: true
}));
server.listen(conf.port);
var Aedes = aedes();
var Aserver = net.createServer(Aedes.handle);
Aserver.listen(1883, function () {
    console.log('MQTT server listening on port', 1883);
});
Aedes.authenticate = function (client, username, token, callback) {
    var db = jwt.verify(JSON.parse(token + ""), conf.secret).db;
    var password = jwt.verify(JSON.parse(token + ""), conf.secret).password;
    console.log("auth");
    console.log(username);
    console.log(password);
    console.log(db);
    authcouch(username, password, db).then(function () {
        console.log("authorized " + username);
        client.couch = { username: username, password: password, db: db };
        callback(null, true);
    }).catch(function () {
        console.log("unauthorized " + username);
        callback(null);
    });
};
Aedes.on('client', function (client) {
    console.log("new client" + client.id);
    console.log(client.couch);
});
Aedes.on('clientDisconnect', function (client) {
    console.log("clientDisconnect");
});
Aedes.on('subscribe', function (topic, client) {
    console.log("subscribe");
});
Aedes.on('unsubscribe', function (topic, client) {
    console.log("unsubscribe");
});
Aedes.on('publish', function (packet, client) {
    if (!client)
        return;
    var obj = JSON.parse(packet.payload.toString());
    console.log("publish");
    if (packet.topic.split("/").length > 1 && packet.topic.split("/")[0] == "data" && client.couch && client.couch && client.couch.username) {
        console.log("save");
        rpj.get("http://" + client.couch.username + ":" + client.couch.password + "@192.168.122.44:5984/" + client.couch.db + '/' + obj._id).then(function (d) {
            obj._rev = d._rev;
            rpj.put("http://" + client.couch.username + ":" + client.couch.password + "@192.168.122.44:5984/" + client.couch.db + '/' + obj._id, obj).then(function () {
                console.log("backup");
            }).catch(function (err) {
                console.log("save error " + err);
            });
        }).catch(function (err) {
            if (err.error == "not_found") {
                rpj.post("http://" + client.couch.username + ":" + client.couch.password + "@192.168.122.44:5984/" + client.couch.db + '/' + obj._id, obj).then(function () {
                    console.log("backup");
                }).catch(function (err) {
                    console.log("save error " + err);
                });
            }
            else {
                console.log(err);
            }
        });
    }
});
app.get('/', function (req, res) {
    res.json({ online: true });
});
function authcouch(user, password, db) {
    return new Promise(function (resolve, reject) {
        rpj.get(COUCHDB.for(user, password, db)).then(function () {
            resolve({ success: true });
        }).catch(function (err) {
            reject({ error: 'wrong credentials' });
        });
    });
}
function authorizesocket(profile) {
    return jwt.sign(profile, conf.secret, { expiresInMinutes: 60 * 5 });
}
app.post('/login', function (req, res) {
    authcouch(req.body.user, req.body.password, req.body.db).then(function () {
        var token = authorizesocket({ user: req.body.user, password: req.body.password, db: req.body.db, serial: req.body.serial });
        res.json({ success: true, token: token });
    }).catch(function (err) {
        res.json(err);
    });
});
app.get('/ip', function (req, res) {
    res.json({ ip: req.headers['x-forwarded-for'] });
});
app.get('/sockets', function (req, res) {
    res.json(Machines.sockets());
});
app.get('/machines/:serial/sockets', function (req, res) {
    res.json(Machines.sockets(req.params.serial));
});
app.get('/machines', function (req, res) {
    res.json(Machines.list());
});
app.get('/app/:app/machines', function (req, res) {
});
app.get('/machines/:serial/message/:message', function (req, res) {
    _.map(Machines.ios(req.params.serial), function (socket) {
        socket.emit('message', req.params.message);
    });
    res.json({});
});
app.post('/machines/:serial/message', function (req, res) {
    _.map(Machines.list(req.params.serial), function (socketid) {
        io.to(socketid).emit('message', req.body.data);
    });
});
app.post('/machines/:serial/data', function (req, res) {
    _.map(Machines.list(req.params.serial), function (socketid) {
        io.to(socketid).emit('data', req.body.data);
    });
});
app.post('/machines/:serial/exec', function (req, res) {
    _.map(Machines.list(req.params.serial), function (socketid) {
        io.to(socketid).emit('exec', req.body.data);
    });
});
app.post('/machines/:serial/npm', function (req, res) {
    _.map(Machines.list(req.params.serial), function (socketid) {
        io.to(socketid).emit('npm', req.body.data);
    });
});
app.post('/machines/:serial/task', function (req, res) {
    _.map(Machines.list(req.params.serial), function (socketid) {
        io.to(socketid).emit('task', req.body.data);
    });
});
io.on('connection', function (socket) {
    var c = socket.decoded_token;
    if (c.db) {
        console.log(c.db);
        Machines.add(c.user, c.password, c.db, c.serial, socket);
        _.map(Auditors.forserial(c.serial), function (socketid) {
            io.to(socketid).emit('machine connection', { serial: c.serial });
        });
        socket.on('disconnect', function () {
            _.map(Auditors.forserial(c.serial), function (socketid) {
                io.to(socketid).emit('machine disconnection', { serial: c.serial });
            });
            Machines.remove(c.serial, socket.id);
        });
        socket.on('message', function (message) {
            Machines.pushdata(c.serial, 'message', message).then(function (docs) {
                _.map(Auditors.forserial(c.serial), function (socketid) {
                    io.to(socketid).emit('machine message', { serial: c.serial, data: message });
                });
            });
        });
        socket.on('data', function (data) {
            Machines.pushdata(c.serial, 'data', data).then(function (docs) {
                _.map(Auditors.forserial(c.serial), function (socketid) {
                    io.to(socketid).emit('machine data', { serial: c.serial, data: data });
                });
            });
        });
        socket.on('docs', function (docs) {
            Machines.pushdata(c.serial, 'docs', docs).then(function (docs) {
                _.map(Auditors.forserial(c.serial), function (socketid) {
                    io.to(socketid).emit('machine docs', { serial: c.serial, data: docs });
                });
            });
        });
        socket.on('up', function (datas) {
            _.map(Auditors.forserial(c.serial), function (socketid) {
                io.to(socketid).emit('machine up', { serial: c.serial });
            });
        });
    }
    else {
        Auditors.add(c.serials, socket.id);
        socket.on('disconnect', function () {
            Auditors.remove(socket.id);
        });
    }
    console.log('hello! ', socket.id);
});

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImluZGV4LnRzIl0sIm5hbWVzIjpbImF1dGhjb3VjaCIsImF1dGhvcml6ZXNvY2tldCJdLCJtYXBwaW5ncyI6IkFBQUEsSUFBWSxHQUFHLFdBQU0sS0FBSyxDQUFDLENBQUE7QUFDM0IsSUFBWSxDQUFDLFdBQU0sUUFBUSxDQUFDLENBQUE7QUFDNUIsSUFBWSxPQUFPLFdBQU0sVUFBVSxDQUFDLENBQUE7QUFDcEMsSUFBWSxVQUFVLFdBQU0sYUFBYSxDQUFDLENBQUE7QUFDMUMsSUFBWSxVQUFVLFdBQU0sYUFBYSxDQUFDLENBQUE7QUFDMUMsSUFBWSxFQUFFLFdBQU0sV0FBVyxDQUFDLENBQUE7QUFDaEMsSUFBWSxPQUFPLFdBQU0sU0FBUyxDQUFDLENBQUE7QUFDbkMsSUFBWSxHQUFHLFdBQU0sY0FBYyxDQUFDLENBQUE7QUFHcEMsSUFBTyxhQUFhLFdBQVcsZUFBZSxDQUFDLENBQUM7QUFFaEQsSUFBTyxXQUFXLFdBQVcsdUJBQXVCLENBQUMsQ0FBQztBQUN0RCxJQUFPLFVBQVUsV0FBVyxzQkFBc0IsQ0FBQyxDQUFDO0FBRXBELElBQUksV0FBVyxHQUFHLE9BQU8sQ0FBQyxjQUFjLENBQUMsQ0FBQztBQUMxQyxJQUFJLEdBQUcsR0FBRyxPQUFPLENBQUMsc0JBQXNCLENBQUMsQ0FBQztBQUMxQyxJQUFJLEtBQUssR0FBRyxPQUFPLENBQUMsT0FBTyxDQUFDLENBQUM7QUFHN0IsSUFBSSxHQUFHLEdBQUcsT0FBTyxFQUFFLENBQUM7QUFDcEIsSUFBSSxNQUFNLEdBQUcsT0FBTyxDQUFDLE1BQU0sQ0FBQyxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsQ0FBQztBQUN6QyxJQUFJLEVBQUUsR0FBRyxFQUFFLENBQUMsTUFBTSxDQUFDLENBQUM7QUFNcEIsRUFBRSxDQUFDLENBQUMsQ0FBQyxVQUFVLENBQUMsSUFBSSxDQUFDLGFBQWEsQ0FBQyxDQUFDLENBQUMsQ0FBQztJQUNsQyxNQUFNLEtBQUssQ0FBQywwQkFBMEIsQ0FBQyxDQUFBO0FBQzNDLENBQUM7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QUMsSUFBSSxDQUFDLENBQUM7SUFDbkQsQ0FBQyxDQUFDLENBQUE7QUFFTixDQUFDLENBQUMsQ0FBQztBQUNILEdBQUcsQ0FBQyxJQUFJLENBQUMsd0JBQXdCLEVBQUUsVUFBUyxHQUFHLEVBQUUsR0FBRztJQUNoRCxDQUFDLENBQUMsR0FBRyxDQUFDLFFBQVEsQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLE1BQU0sQ0FBQyxNQUFNLENBQUMsRUFBRSxVQUFTLFFBQVE7UUFDckQsRUFBRSxDQUFDLEVBQUUsQ0FBQyxRQUFRLENBQUMsQ0FBQyxJQUFJLENBQUMsTUFBTSxFQUFFLEdBQUcsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUM7SUFDaEQsQ0FBQyxDQUFDLENBQUE7QUFDTixDQUFDLENBQUMsQ0FBQztBQUNILEdBQUcsQ0FBQyxJQUFJLENBQUMsd0JBQXdCLEVBQUUsVUFBUyxHQUFHLEVBQUUsR0FBRztJQUNoRCxDQUFDLENBQUMsR0FBRyxDQUFDLFFBQVEsQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLE1BQU0sQ0FBQyxNQUFNLENBQUMsRUFBRSxVQUFTLFFBQVE7UUFDckQsRUFBRSxDQUFDLEVBQUUsQ0FBQyxRQUFRLENBQUMsQ0FBQyxJQUFJLENBQUMsTUFBTSxFQUFFLEdBQUcsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUM7SUFDaEQsQ0FBQyxDQUFDLENBQUE7QUFDTixDQUFDLENBQUMsQ0FBQztBQUNILEdBQUcsQ0FBQyxJQUFJLENBQUMsdUJBQXVCLEVBQUUsVUFBUyxHQUFHLEVBQUUsR0FBRztJQUMvQyxDQUFDLENBQUMsR0FBRyxDQUFDLFFBQVEsQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLE1BQU0sQ0FBQyxNQUFNLENBQUMsRUFBRSxVQUFTLFFBQVE7UUFDckQsRUFBRSxDQUFDLEVBQUUsQ0FBQyxRQUFRLENBQUMsQ0FBQyxJQUFJLENBQUMsS0FBSyxFQUFFLEdBQUcsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUM7SUFDL0MsQ0FBQyxDQUFDLENBQUE7QUFDTixD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LENBQUMsQ0FBQyxDQUFDLE9BQU8sRUFBRSxNQUFNLENBQUMsRUFBRSxDQUFDLENBQUE7UUFDbEMsTUFBTSxDQUFDLEVBQUUsQ0FBQyxZQUFZLEVBQUU7WUFDcEIsUUFBUSxDQUFDLE1BQU0sQ0FBQyxNQUFNLENBQUMsRUFBRSxDQUFDLENBQUE7UUFDOUIsQ0FBQyxDQUFDLENBQUM7SUFFUCxDQUFDO0lBRUQsT0FBTyxDQUFDLEdBQUcsQ0FBQyxTQUFTLEVBQUUsTUFBTSxDQUFDLEVBQUUsQ0FBQyxDQUFDO0FBQ3RDLENBQUMsQ0FBQyxDQUFDIiwiZmlsZSI6ImluZGV4LmpzIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0ICogYXMgbmV0IGZyb20gXCJuZXRcIjtcbmltcG9ydCAqIGFzIF8gZnJvbSBcImxvZGFzaFwiO1xuaW1wb3J0ICogYXMgUHJvbWlzZSBmcm9tIFwiYmx1ZWJpcmRcIjtcbmltcG9ydCAqIGFzIGJvZHlQYXJzZXIgZnJvbSBcImJvZHktcGFyc2VyXCI7XG5pbXBvcnQgKiBhcyBwYXRoRXhpc3RzIGZyb20gXCJwYXRoLWV4aXN0c1wiO1xuaW1wb3J0ICogYXMgSU8gZnJvbSBcInNvY2tldC5pb1wiO1xuaW1wb3J0ICogYXMgZXhwcmVzcyBmcm9tIFwiZXhwcmVzc1wiO1xuaW1wb3J0ICogYXMgand0IGZyb20gXCJqc29ud2VidG9rZW5cIjtcbmltcG9ydCAqIGFzIHJlZGlzIGZyb20gXCJyZWRpc1wiO1xuXG5pbXBvcnQgY291Y2hqc29uY29uZiA9IHJlcXVpcmUoXCJjb3VjaGpzb25jb25mXCIpO1xuXG5pbXBvcnQgbWFjaENsaWVudHMgPSByZXF1aXJlKFwiLi9tb2R1bGVzL21hY2hDbGllbnRzXCIpO1xuaW1wb3J0IGF1ZENsaWVudHMgPSByZXF1aXJlKFwiLi9tb2R1bGVzL2F1ZENsaWVudHNcIik7XG5cbmxldCBzb2NrZXRpb0p3dCA9IHJlcXVpcmUoXCJzb2NrZXRpby1qd3RcIik7XG5sZXQgcnBqID0gcmVxdWlyZSgncmVxdWVzdC1wcm9taXNlLWpzb24nKTtcbmxldCBhZWRlcyA9IHJlcXVpcmUoXCJhZWRlc1wiKTtcblxuXG5sZXQgYXBwID0gZXhwcmVzcygpO1xubGV0IHNlcnZlciA9IHJlcXVpcmUoJ2h0dHAnKS5TZXJ2ZXIoYXBwKTtcbmxldCBpbyA9IElPKHNlcnZlcik7XG5cblxuXG5cblxuaWYgKCFwYXRoRXhpc3RzLnN5bmMoJy4vY29uZi5qc29uJykpIHtcbiAgICB0aHJvdyBFcnJvcignbm8gY29uZmlndXJhdGlvbiBmb3VuZGVkJylcbn1cbmxldCBjb25mID0gcmVxdWlyZSgnLi9jb25mLmpzb24nKVxuXG5sZXQgQ09VQ0hEQiA9IG5ldyBjb3VjaGpzb25jb25mKGNvbmYuY291Y2hkYilcblxubGV0IE1hY2hpbmVzID0gbmV3IG1hY2hDbGllbnRzKENPVUNIREIpO1xubGV0IEF1ZGl0b3JzID0gbmV3IGF1ZENsaWVudHMoKTtcblxuLy8gcGFyc2UgYXBwbGljYXRpb24veC13d3ctZm9ybS11cmxlbmNvZGVkXG5hcHAudXNlKGJvZHlQYXJzZXIudXJsZW5jb2RlZCh7IGV4dGVuZGVkOiBmYWxzZSB9KSlcblxuLy8gcGFyc2UgYXBwbGljYXRpb24vanNvblxuYXBwLnVzZShib2R5UGFyc2VyLmpzb24oKSlcblxuXG5cbmlvLnVzZShzb2NrZXRpb0p3dC5hdXRob3JpemUoe1xuICAgIHNlY3JldDogY29uZi5zZWNyZXQsXG4gICAgaGFuZHNoYWtlOiB0cnVlXG59KSk7XG5cbnNlcnZlci5saXN0ZW4oY29uZi5wb3J0KTtcblxuXG5sZXQgQWVkZXMgPSBhZWRlcygpXG5sZXQgQXNlcnZlciA9IG5ldC5jcmVhdGVTZXJ2ZXIoQWVkZXMuaGFuZGxlKVxuXG5Bc2VydmVyLmxpc3RlbigxODgzLCBmdW5jdGlvbigpIHtcbiAgICBjb25zb2xlLmxvZygnTVFUVCBzZXJ2ZXIgbGlzdGVuaW5nIG9uIHBvcnQnLCAxODgzKVxufSk7XG5cblxuQWVkZXMuYXV0aGVudGljYXRlID0gZnVuY3Rpb24oY2xpZW50LCB1c2VybmFtZSwgdG9rZW4sIGNhbGxiYWNrKSB7XG5cbiAgICBsZXQgZGIgPSBqd3QudmVyaWZ5KEpTT04ucGFyc2UodG9rZW4gKyBcIlwiKSwgY29uZi5zZWNyZXQpLmRiXG4gICAgbGV0IHBhc3N3b3JkID0gand0LnZlcmlmeShKU09OLnBhcnNlKHRva2VuICsgXCJcIiksIGNvbmYuc2VjcmV0KS5wYXNzd29yZFxuICAgIGNvbnNvbGUubG9nKFwiYXV0aFwiKVxuICAgIGNvbnNvbGUubG9nKHVzZXJuYW1lKVxuICAgIGNvbnNvbGUubG9nKHBhc3N3b3JkKVxuICAgIGNvbnNvbGUubG9nKGRiKVxuICAgIC8vIFxuICAgIGF1dGhjb3VjaCh1c2VybmFtZSwgcGFzc3dvcmQsIGRiKS50aGVuKGZ1bmN0aW9uKCkge1xuICAgICAgICBjb25zb2xlLmxvZyhcImF1dGhvcml6ZWQgXCIgKyB1c2VybmFtZSlcbiAgICAgICAgY2xpZW50LmNvdWNoID0geyB1c2VybmFtZTogdXNlcm5hbWUsIHBhc3N3b3JkOiBwYXNzd29yZCwgZGI6IGRiIH1cbiAgICAgICAgY2FsbGJhY2sobnVsbCwgdHJ1ZSlcbiAgICB9KS5jYXRjaChmdW5jdGlvbigpIHtcbiAgICAgICAgY29uc29sZS5sb2coXCJ1bmF1dGhvcml6ZWQgXCIgKyB1c2VybmFtZSlcbiAgICAgICAgY2FsbGJhY2sobnVsbClcbiAgICB9KVxuXG5cblxuXG59XG5cbkFlZGVzLm9uKCdjbGllbnQnLCBmdW5jdGlvbihjbGllbnQpIHtcblxuXG4gICAgY29uc29sZS5sb2coXCJuZXcgY2xpZW50XCIgKyBjbGllbnQuaWQpXG5cbiAgICBjb25zb2xlLmxvZyhjbGllbnQuY291Y2gpXG5cbn0pO1xuXG5BZWRlcy5vbignY2xpZW50RGlzY29ubmVjdCcsIGZ1bmN0aW9uKGNsaWVudCkge1xuICAgIGNvbnNvbGUubG9nKFwiY2xpZW50RGlzY29ubmVjdFwiKVxufSk7XG5cbkFlZGVzLm9uKCdzdWJzY3JpYmUnLCBmdW5jdGlvbih0b3BpYywgY2xpZW50KSB7XG4gICAgY29uc29sZS5sb2coXCJzdWJzY3JpYmVcIilcbn0pO1xuXG5BZWRlcy5vbigndW5zdWJzY3JpYmUnLCBmdW5jdGlvbih0b3BpYywgY2xpZW50KSB7XG4gICAgY29uc29sZS5sb2coXCJ1bnN1YnNjcmliZVwiKVxufSk7XG5cbkFlZGVzLm9uKCdwdWJsaXNoJywgZnVuY3Rpb24ocGFja2V0LCBjbGllbnQpIHtcblxuICAgIGlmICghY2xpZW50KSByZXR1cm47XG5cbiAgICBsZXQgb2JqID0gSlNPTi5wYXJzZShwYWNrZXQucGF5bG9hZC50b1N0cmluZygpKTtcbiAgICBjb25zb2xlLmxvZyhcInB1Ymxpc2hcIik7XG5cbiAgICBpZiAocGFja2V0LnRvcGljLnNwbGl0KFwiL1wiKS5sZW5ndGggPiAxICYmIHBhY2tldC50b3BpYy5zcGxpdChcIi9cIilbMF0gPT0gXCJkYXRhXCIgJiYgY2xpZW50LmNvdWNoICYmIGNsaWVudC5jb3VjaCAmJiBjbGllbnQuY291Y2gudXNlcm5hbWUpIHtcbiAgICAgICAgLy8gICAgcnBqLnBvc3QoKVxuICAgICAgICBjb25zb2xlLmxvZyhcInNhdmVcIik7XG4gICAgICAgIHJwai5nZXQoXCJodHRwOi8vXCIgKyBjbGllbnQuY291Y2gudXNlcm5hbWUgKyBcIjpcIiArIGNsaWVudC5jb3VjaC5wYXNzd29yZCArIFwiQDE5Mi4xNjguMTIyLjQ0OjU5ODQvXCIgKyBjbGllbnQuY291Y2guZGIgKyAnLycgKyBvYmouX2lkKS50aGVuKGZ1bmN0aW9uKGQpIHtcbiAgICAgICAgICAgIG9iai5fcmV2ID0gZC5fcmV2O1xuICAgICAgICAgICAgcnBqLnB1dChcImh0dHA6Ly9cIiArIGNsaWVudC5jb3VjaC51c2VybmFtZSArIFwiOlwiICsgY2xpZW50LmNvdWNoLnBhc3N3b3JkICsgXCJAMTkyLjE2OC4xMjIuNDQ6NTk4NC9cIiArIGNsaWVudC5jb3VjaC5kYiArICcvJyArIG9iai5faWQsIG9iaikudGhlbihmdW5jdGlvbigpIHtcbiAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhcImJhY2t1cFwiKTtcbiAgICAgICAgICAgIH0pLmNhdGNoKGZ1bmN0aW9uKGVycikge1xuICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKFwic2F2ZSBlcnJvciBcIiArIGVycik7XG4gICAgICAgICAgICB9KTtcblxuICAgICAgICB9KS5jYXRjaChmdW5jdGlvbihlcnIpIHtcbiAgICAgICAgICAgIGlmIChlcnIuZXJyb3IgPT0gXCJub3RfZm91bmRcIikge1xuICAgICAgICAgICAgICAgIHJwai5wb3N0KFwiaHR0cDovL1wiICsgY2xpZW50LmNvdWNoLnVzZXJuYW1lICsgXCI6XCIgKyBjbGllbnQuY291Y2gucGFzc3dvcmQgKyBcIkAxOTIuMTY4LjEyMi40NDo1OTg0L1wiICsgY2xpZW50LmNvdWNoLmRiICsgJy8nICsgb2JqLl9pZCwgb2JqKS50aGVuKGZ1bmN0aW9uKCkge1xuICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhcImJhY2t1cFwiKTtcbiAgICAgICAgICAgICAgICB9KS5jYXRjaChmdW5jdGlvbihlcnIpIHtcbiAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coXCJzYXZlIGVycm9yIFwiICsgZXJyKTtcbiAgICAgICAgICAgICAgICB9KTtcblxuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhlcnIpXG4gICAgICAgICAgICB9XG5cbiAgICAgICAgfSlcblxuXG4gICAgfVxuXG5cblxuXG59KTtcblxuXG5pbnRlcmZhY2UgSVNvY2tldCB7XG5cbiAgICBpZDogc3RyaW5nO1xuICAgIGVtaXQ6IEZ1bmN0aW9uO1xuICAgIG9uOiBGdW5jdGlvbjtcbiAgICBkZWNvZGVkX3Rva2VuOiB7XG4gICAgICAgIGRiOiBzdHJpbmc7XG4gICAgICAgIHVzZXI6IHN0cmluZztcbiAgICAgICAgcGFzc3dvcmQ6IHN0cmluZztcbiAgICAgICAgc2VyaWFsOiBzdHJpbmc7XG4gICAgICAgIHNlcmlhbHM6IHN0cmluZ1tdXG4gICAgfVxufVxuXG5cblxuXG5hcHAuZ2V0KCcvJywgZnVuY3Rpb24ocmVxLCByZXMpIHtcbiAgICByZXMuanNvbih7IG9ubGluZTogdHJ1ZSB9KVxufSk7XG5cblxuXG5cbmZ1bmN0aW9uIGF1dGhjb3VjaCh1c2VyOiBzdHJpbmcsIHBhc3N3b3JkOiBzdHJpbmcsIGRiOiBzdHJpbmcpIHtcbiAgICByZXR1cm4gbmV3IFByb21pc2UoZnVuY3Rpb24ocmVzb2x2ZSwgcmVqZWN0KSB7XG4gICAgICAgIHJwai5nZXQoQ09VQ0hEQi5mb3IodXNlciwgcGFzc3dvcmQsIGRiKSkudGhlbihmdW5jdGlvbigpIHtcbiAgICAgICAgICAgIHJlc29sdmUoeyBzdWNjZXNzOiB0cnVlIH0pXG4gICAgICAgIH0pLmNhdGNoKGZ1bmN0aW9uKGVycikge1xuICAgICAgICAgICAgcmVqZWN0KHsgZXJyb3I6ICd3cm9uZyBjcmVkZW50aWFscycgfSlcbiAgICAgICAgfSlcbiAgICB9KVxufVxuXG5mdW5jdGlvbiBhdXRob3JpemVzb2NrZXQocHJvZmlsZSk6IHt9IHtcbiAgICByZXR1cm4gand0LnNpZ24ocHJvZmlsZSwgY29uZi5zZWNyZXQsIHsgZXhwaXJlc0luTWludXRlczogNjAgKiA1IH0pO1xufVxuXG5hcHAucG9zdCgnL2xvZ2luJywgZnVuY3Rpb24ocmVxLCByZXMpIHtcbiAgICBhdXRoY291Y2gocmVxLmJvZHkudXNlciwgcmVxLmJvZHkucGFzc3dvcmQsIHJlcS5ib2R5LmRiKS50aGVuKGZ1bmN0aW9uKCkge1xuXG4gICAgICAgIGxldCB0b2tlbiA9IGF1dGhvcml6ZXNvY2tldCh7IHVzZXI6IHJlcS5ib2R5LnVzZXIsIHBhc3N3b3JkOiByZXEuYm9keS5wYXNzd29yZCwgZGI6IHJlcS5ib2R5LmRiLCBzZXJpYWw6IHJlcS5ib2R5LnNlcmlhbCB9KVxuXG4gICAgICAgIHJlcy5qc29uKHsgc3VjY2VzczogdHJ1ZSwgdG9rZW46IHRva2VuIH0pXG4gICAgfSkuY2F0Y2goZnVuY3Rpb24oZXJyKSB7XG4gICAgICAgIHJlcy5qc29uKGVycilcbiAgICB9KVxufSk7XG5cbmFwcC5nZXQoJy9pcCcsIGZ1bmN0aW9uKHJlcSwgcmVzKSB7XG4gICAgcmVzLmpzb24oeyBpcDogcmVxLmhlYWRlcnNbJ3gtZm9yd2FyZGVkLWZvciddIH0pXG59KTtcblxuYXBwLmdldCgnL3NvY2tldHMnLCBmdW5jdGlvbihyZXEsIHJlcykge1xuICAgIHJlcy5qc29uKE1hY2hpbmVzLnNvY2tldHMoKSlcbn0pO1xuYXBwLmdldCgnL21hY2hpbmVzLzpzZXJpYWwvc29ja2V0cycsIGZ1bmN0aW9uKHJlcSwgcmVzKSB7XG4gICAgcmVzLmpzb24oTWFjaGluZXMuc29ja2V0cyhyZXEucGFyYW1zLnNlcmlhbCkpXG59KTtcbmFwcC5nZXQoJy9tYWNoaW5lcycsIGZ1bmN0aW9uKHJlcSwgcmVzKSB7XG4gICAgcmVzLmpzb24oTWFjaGluZXMubGlzdCgpKVxufSk7XG5hcHAuZ2V0KCcvYXBwLzphcHAvbWFjaGluZXMnLCBmdW5jdGlvbihyZXEsIHJlcykge1xuICAgIC8vIHJlcy5qc29uKE1hY2hpbmVzLnNlcmlhbHMoKSlcbn0pO1xuXG5hcHAuZ2V0KCcvbWFjaGluZXMvOnNlcmlhbC9tZXNzYWdlLzptZXNzYWdlJywgZnVuY3Rpb24ocmVxLCByZXMpIHtcbiAgICBfLm1hcChNYWNoaW5lcy5pb3MocmVxLnBhcmFtcy5zZXJpYWwpLCBmdW5jdGlvbihzb2NrZXQpIHtcbiAgICAgICAgc29ja2V0LmVtaXQoJ21lc3NhZ2UnLCByZXEucGFyYW1zLm1lc3NhZ2UpO1xuXG4gICAgfSlcbiAgICByZXMuanNvbih7fSlcblxufSk7XG5cbmFwcC5wb3N0KCcvbWFjaGluZXMvOnNlcmlhbC9tZXNzYWdlJywgZnVuY3Rpb24ocmVxLCByZXMpIHtcbiAgICBfLm1hcChNYWNoaW5lcy5saXN0KHJlcS5wYXJhbXMuc2VyaWFsKSwgZnVuY3Rpb24oc29ja2V0aWQpIHtcbiAgICAgICAgaW8udG8oc29ja2V0aWQpLmVtaXQoJ21lc3NhZ2UnLCByZXEuYm9keS5kYXRhKTtcbiAgICB9KVxuXG59KTtcbmFwcC5wb3N0KCcvbWFjaGluZXMvOnNlcmlhbC9kYXRhJywgZnVuY3Rpb24ocmVxLCByZXMpIHtcbiAgICBfLm1hcChNYWNoaW5lcy5saXN0KHJlcS5wYXJhbXMuc2VyaWFsKSwgZnVuY3Rpb24oc29ja2V0aWQpIHtcbiAgICAgICAgaW8udG8oc29ja2V0aWQpLmVtaXQoJ2RhdGEnLCByZXEuYm9keS5kYXRhKTtcbiAgICB9KVxufSk7XG5hcHAucG9zdCgnL21hY2hpbmVzLzpzZXJpYWwvZXhlYycsIGZ1bmN0aW9uKHJlcSwgcmVzKSB7XG4gICAgXy5tYXAoTWFjaGluZXMubGlzdChyZXEucGFyYW1zLnNlcmlhbCksIGZ1bmN0aW9uKHNvY2tldGlkKSB7XG4gICAgICAgIGlvLnRvKHNvY2tldGlkKS5lbWl0KCdleGVjJywgcmVxLmJvZHkuZGF0YSk7XG4gICAgfSlcbn0pO1xuYXBwLnBvc3QoJy9tYWNoaW5lcy86c2VyaWFsL25wbScsIGZ1bmN0aW9uKHJlcSwgcmVzKSB7XG4gICAgXy5tYXAoTWFjaGluZXMubGlzdChyZXEucGFyYW1zLnNlcmlhbCksIGZ1bmN0aW9uKHNvY2tldGlkKSB7XG4gICAgICAgIGlvLnRvKHNvY2tldGlkKS5lbWl0KCducG0nLCByZXEuYm9keS5kYXRhKTtcbiAgICB9KVxufSk7XG5hcHAucG9zdCgnL21hY2hpbmVzLzpzZXJpYWwvdGFzaycsIGZ1bmN0aW9uKHJlcSwgcmVzKSB7XG4gICAgXy5tYXAoTWFjaGluZXMubGlzdChyZXEucGFyYW1zLnNlcmlhbCksIGZ1bmN0aW9uKHNvY2tldGlkKSB7XG4gICAgICAgIGlvLnRvKHNvY2tldGlkKS5lbWl0KCd0YXNrJywgcmVxLmJvZHkuZGF0YSk7XG4gICAgfSlcbn0pO1xuXG5pby5vbignY29ubmVjdGlvbicsIGZ1bmN0aW9uKHNvY2tldDogSVNvY2tldCkge1xuICAgIGxldCBjID0gc29ja2V0LmRlY29kZWRfdG9rZW47XG5cbiAgICBpZiAoYy5kYikge1xuICAgICAgICBjb25zb2xlLmxvZyhjLmRiKVxuXG4gICAgICAgIE1hY2hpbmVzLmFkZChjLnVzZXIsIGMucGFzc3dvcmQsIGMuZGIsIGMuc2VyaWFsLCBzb2NrZXQpO1xuICAgICAgICBfLm1hcChBdWRpdG9ycy5mb3JzZXJpYWwoYy5zZXJpYWwpLCBmdW5jdGlvbihzb2NrZXRpZCkge1xuICAgICAgICAgICAgaW8udG8oc29ja2V0aWQpLmVtaXQoJ21hY2hpbmUgY29ubmVjdGlvbicsIHsgc2VyaWFsOiBjLnNlcmlhbCB9KTtcbiAgICAgICAgfSlcblxuICAgICAgICBzb2NrZXQub24oJ2Rpc2Nvbm5lY3QnLCBmdW5jdGlvbigpIHtcblxuICAgICAgICAgICAgXy5tYXAoQXVkaXRvcnMuZm9yc2VyaWFsKGMuc2VyaWFsKSwgZnVuY3Rpb24oc29ja2V0aWQpIHtcbiAgICAgICAgICAgICAgICBpby50byhzb2NrZXRpZCkuZW1pdCgnbWFjaGluZSBkaXNjb25uZWN0aW9uJywgeyBzZXJpYWw6IGMuc2VyaWFsIH0pO1xuICAgICAgICAgICAgfSlcblxuICAgICAgICAgICAgTWFjaGluZXMucmVtb3ZlKGMuc2VyaWFsLCBzb2NrZXQuaWQpO1xuICAgICAgICB9KTtcbiAgICAgICAgc29ja2V0Lm9uKCdtZXNzYWdlJywgZnVuY3Rpb24obWVzc2FnZSkge1xuICAgICAgICAgICAgTWFjaGluZXMucHVzaGRhdGEoYy5zZXJpYWwsICdtZXNzYWdlJywgbWVzc2FnZSkudGhlbihmdW5jdGlvbihkb2NzKSB7XG5cbiAgICAgICAgICAgICAgICBfLm1hcChBdWRpdG9ycy5mb3JzZXJpYWwoYy5zZXJpYWwpLCBmdW5jdGlvbihzb2NrZXRpZCkge1xuICAgICAgICAgICAgICAgICAgICBpby50byhzb2NrZXRpZCkuZW1pdCgnbWFjaGluZSBtZXNzYWdlJywgeyBzZXJpYWw6IGMuc2VyaWFsLCBkYXRhOiBtZXNzYWdlIH0pO1xuICAgICAgICAgICAgICAgIH0pXG4gICAgICAgICAgICB9KVxuICAgICAgICB9KTtcbiAgICAgICAgc29ja2V0Lm9uKCdkYXRhJywgZnVuY3Rpb24oZGF0YSkge1xuICAgICAgICAgICAgTWFjaGluZXMucHVzaGRhdGEoYy5zZXJpYWwsICdkYXRhJywgZGF0YSkudGhlbihmdW5jdGlvbihkb2NzKSB7XG5cbiAgICAgICAgICAgICAgICBfLm1hcChBdWRpdG9ycy5mb3JzZXJpYWwoYy5zZXJpYWwpLCBmdW5jdGlvbihzb2NrZXRpZCkge1xuICAgICAgICAgICAgICAgICAgICBpby50byhzb2NrZXRpZCkuZW1pdCgnbWFjaGluZSBkYXRhJywgeyBzZXJpYWw6IGMuc2VyaWFsLCBkYXRhOiBkYXRhIH0pO1xuICAgICAgICAgICAgICAgIH0pXG4gICAgICAgICAgICB9KVxuICAgICAgICB9KTtcbiAgICAgICAgc29ja2V0Lm9uKCdkb2NzJywgZnVuY3Rpb24oZG9jcykge1xuICAgICAgICAgICAgTWFjaGluZXMucHVzaGRhdGEoYy5zZXJpYWwsICdkb2NzJywgZG9jcykudGhlbihmdW5jdGlvbihkb2NzKSB7XG4gICAgICAgICAgICAgICAgXy5tYXAoQXVkaXRvcnMuZm9yc2VyaWFsKGMuc2VyaWFsKSwgZnVuY3Rpb24oc29ja2V0aWQpIHtcbiAgICAgICAgICAgICAgICAgICAgaW8udG8oc29ja2V0aWQpLmVtaXQoJ21hY2hpbmUgZG9jcycsIHsgc2VyaWFsOiBjLnNlcmlhbCwgZGF0YTogZG9jcyB9KTtcbiAgICAgICAgICAgICAgICB9KVxuXG4gICAgICAgICAgICB9KVxuICAgICAgICB9KTtcbiAgICAgICAgc29ja2V0Lm9uKCd1cCcsIGZ1bmN0aW9uKGRhdGFzKSB7XG4gICAgICAgICAgICBfLm1hcChBdWRpdG9ycy5mb3JzZXJpYWwoYy5zZXJpYWwpLCBmdW5jdGlvbihzb2NrZXRpZCkge1xuICAgICAgICAgICAgICAgIGlvLnRvKHNvY2tldGlkKS5lbWl0KCdtYWNoaW5lIHVwJywgeyBzZXJpYWw6IGMuc2VyaWFsIH0pO1xuICAgICAgICAgICAgfSlcbiAgICAgICAgfSlcblxuICAgIH0gZWxzZSB7XG4gICAgICAgIEF1ZGl0b3JzLmFkZChjLnNlcmlhbHMsIHNvY2tldC5pZClcbiAgICAgICAgc29ja2V0Lm9uKCdkaXNjb25uZWN0JywgZnVuY3Rpb24oKSB7XG4gICAgICAgICAgICBBdWRpdG9ycy5yZW1vdmUoc29ja2V0LmlkKVxuICAgICAgICB9KTtcblxuICAgIH1cblxuICAgIGNvbnNvbGUubG9nKCdoZWxsbyEgJywgc29ja2V0LmlkKTtcbn0pO1xuIl0sInNvdXJjZVJvb3QiOiIvc291cmNlLyJ9
