var _ = require("lodash");
var Promise = require("bluebird");
var rpj = require("request-promise-json");
function mconnection(user, password, db, serial, bool) {
    return new Promise(function (resolve, reject) {
        rpj.get(db + "/connection_" + serial).then(function (doc) {
            doc.connected = bool;
            doc.updatedAt = new Date().getTime();
            rpj.put(db + "/connection_" + serial, doc).then(function (d) {
                resolve(true);
            }).catch(function (err) {
                console.log(err);
                reject(err);
            });
        }).catch(function (err) {
            console.log(err);
            if (bool === true && err.statusCode === 404) {
                var doc = {
                    _id: "connection_" + serial,
                    connected: true,
                    updatedAt: new Date().getTime()
                };
                rpj.post(db, doc).then(function (doc) {
                    resolve(true);
                }).catch(function (err) {
                    reject({ error: "wrong credentials" });
                });
            }
            else {
                console.log(err);
                reject(err);
            }
        });
    });
}
function pushtodb(user, password, db, serial, doc) {
    return new Promise(function (resolve, reject) {
        rpj.get(db + "/" + doc._id).then(function (d) {
            doc._rev = d._rev;
            rpj.put(db + "/" + doc._id, doc).then(function () {
                resolve(doc);
            }).catch(function (err) {
                reject(err);
            });
        }).catch(function (err) {
            if (err.statusCode === 404) {
                rpj.post(db + "/", doc).then(function () {
                    resolve(doc);
                }).catch(function (err) {
                    reject(err);
                });
            }
            else {
                console.log(err);
                reject(err);
            }
        });
    });
}
function exists(all, serial, sid) {
    var serialexists = false;
    var socketexists = false;
    _.map(all, function (client) {
        if (client.serial) {
            serialexists = true;
            _.map(client.sockets, function (s) {
                if (s.id === sid) {
                    socketexists = true;
                }
            });
        }
    });
    return { serial: serialexists, socket: socketexists };
}
module.exports = (function () {
    function MaClients(db) {
        this.couchdb = db;
        this.all = [];
    }
    MaClients.prototype.add = function (user, password, db, serial, socket) {
        var exist = exists(this.all, serial, socket.id);
        if (!exist.serial) {
            this.all.push({
                serial: serial,
                user: user,
                password: password,
                db: this.couchdb.protocol + "://" + user + ":" + password + "@" + this.couchdb.host + "/" + db,
                sockets: [{ id: socket.id, socket: socket }]
            });
            return mconnection(user, password, this.couchdb.protocol + "://" + user + ":" + password + "@" + this.couchdb.host + "/" + db, serial, true);
        }
        else if (!exist.socket) {
            _.map(this.all, function (client) {
                if (client.serial) {
                    client.sockets.push({ id: socket.id, socket: socket });
                }
            });
            console.log("new socket for " + serial);
        }
    };
    ;
    MaClients.prototype.pushdata = function (serial, type, data) {
        return new Promise(function (resolve, reject) {
            reject("todo");
        });
    };
    ;
    MaClients.prototype.remove = function (serial, sid) {
        var remaning = [];
        for (var soc = 0; soc < this.all.length; soc++) {
            var client = this.all[soc];
            if (client.serial === serial) {
                if (client.sockets.length === 1 && client.sockets[0].id === sid) {
                    mconnection(client.user, client.password, client.db, client.serial, false).then(function () {
                        console.log("switched offline");
                    }).catch(function (err) {
                        console.log("switched offline error");
                        console.log(err);
                    });
                    _.map(this.all, function (el) {
                        if (el.serial !== client.serial) {
                            remaning.push(el);
                        }
                    });
                    this.all = remaning;
                }
                else {
                    console.log("todo");
                }
            }
        }
    };
    ;
    MaClients.prototype.list = function (serial) {
        var serials = [];
        if (serial) {
            _.map(this.all, function (client) {
                if (client.serial === serial) {
                    serials.push(client.serial);
                }
            });
        }
        else {
            _.map(this.all, function (client) {
                serials.push(client.serial);
            });
        }
        return serials;
    };
    ;
    MaClients.prototype.ios = function (serial) {
        var sockets = [];
        if (serial) {
            _.map(this.all, function (client) {
                if (client.serial === serial) {
                    _.map(client.sockets, function (s) {
                        sockets.push(s.socket);
                    });
                }
            });
        }
        else {
            _.map(this.all, function (client) {
                _.map(client.sockets, function (s) {
                    sockets.push(s.socket);
                });
            });
        }
        return sockets;
    };
    ;
    MaClients.prototype.sockets = function (serial) {
        var ids;
        if (serial) {
            _.map(this.all, function (client) {
                if (client.serial === serial) {
                    ids = _.pluck(client.sockets, "id");
                }
            });
            return ids;
        }
        else {
            ids = [];
            _.map(this.all, function (client) {
                _.map(client.sockets, function (s) {
                    ids.push(s.id);
                });
            });
            return ids;
        }
    };
    ;
    return MaClients;
})();

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIm1vZHVsZXMvbWFjaENsaWVudHMudHMiXSwibmFtZXMiOlsibWNvbm5lY3Rpb24iLCJwdXNodG9kYiIsImV4aXN0cyIsImNvbnN0cnVjdG9yIiwiYWRkIiwicHVzaGRhdGEiLCJyZW1vdmUiLCJsaXN0IiwiaW9zIiwic29ja2V0cyJdLCJtYXBwaW5ncyI6IkFBQUEsSUFBWSxDQUFDLFdBQU0sUUFBUSxDQUFDLENBQUE7QUFDNUIsSUFBWSxPQUFPLFdBQU0sVUFBVSxDQUFDLENBQUE7QUFDcEMsSUFBSSxHQUFHLEdBQUcsT0FBTyxDQUFDLHNCQUFzQixDQUFDLENBQUM7QUFFMUMscUJBQXFCLElBQVksRUFBRSxRQUFnQixFQUFFLEVBQVUsRUFBRSxNQUFjLEVBQUUsSUFBYztJQUMzRkEsTUFBTUEsQ0FBQ0EsSUFBSUEsT0FBT0EsQ0FBQ0EsVUFBU0EsT0FBT0EsRUFBRUEsTUFBTUE7UUFDdkMsR0FBRyxDQUFDLEdBQUcsQ0FBQyxFQUFFLEdBQUcsY0FBYyxHQUFHLE1BQU0sQ0FBQyxDQUFDLElBQUksQ0FBQyxVQUFTLEdBQUc7WUFDbkQsR0FBRyxDQUFDLFNBQVMsR0FBRyxJQUFJLENBQUM7WUFDckIsR0FBRyxDQUFDLFNBQVMsR0FBRyxJQUFJLElBQUksRUFBRSxDQUFDLE9BQU8sRUFBRSxDQUFDO1lBQ3JDLEdBQUcsQ0FBQyxHQUFHLENBQUMsRUFBRSxHQUFHLGNBQWMsR0FBRyxNQUFNLEVBQUUsR0FBRyxDQUFDLENBQUMsSUFBSSxDQUFDLFVBQVMsQ0FBQztnQkFDdEQsT0FBTyxDQUFDLElBQUksQ0FBQyxDQUFDO1lBQ2xCLENBQUMsQ0FBQyxDQUFDLEtBQUssQ0FBQyxVQUFTLEdBQUc7Z0JBQ2pCLE9BQU8sQ0FBQyxHQUFHLENBQUMsR0FBRyxDQUFDLENBQUM7Z0JBQ2pCLE1BQU0sQ0FBQyxHQUFHLENBQUMsQ0FBQztZQUNoQixDQUFDLENBQUMsQ0FBQztRQUNQLENBQUMsQ0FBQyxDQUFDLEtBQUssQ0FBQyxVQUFTLEdBQUc7WUFDakIsT0FBTyxDQUFDLEdBQUcsQ0FBQyxHQUFHLENBQUMsQ0FBQztZQUVqQixFQUFFLENBQUMsQ0FBQyxJQUFJLEtBQUssSUFBSSxJQUFJLEdBQUcsQ0FBQyxVQUFVLEtBQUssR0FBRyxDQUFDLENBQUMsQ0FBQztnQkFFMUMsSUFBSSxHQUFHLEdBQUc7b0JBQ04sR0FBRyxFQUFFLGFBQWEsR0FBRyxNQUFNO29CQUMzQixTQUFTLEVBQUUsSUFBSTtvQkFDZixTQUFTLEVBQUUsSUFBSSxJQUFJLEVBQUUsQ0FBQyxPQUFPLEVBQUU7aUJBQ2xDLENBQUM7Z0JBRUYsR0FBRyxDQUFDLElBQUksQ0FBQyxFQUFFLEVBQUUsR0FBRyxDQUFDLENBQUMsSUFBSSxDQUFDLFVBQVMsR0FBRztvQkFDL0IsT0FBTyxDQUFDLElBQUksQ0FBQyxDQUFDO2dCQUNsQixDQUFDLENBQUMsQ0FBQyxLQUFLLENBQUMsVUFBUyxHQUFHO29CQUNqQixNQUFNLENBQUMsRUFBRSxLQUFLLEVBQUUsbUJBQW1CLEVBQUUsQ0FBQyxDQUFDO2dCQUMzQyxDQUFDLENBQUMsQ0FBQztZQUNQLENBQUM7WUFBQyxJQUFJLENBQUMsQ0FBQztnQkFDSixPQUFPLENBQUMsR0FBRyxDQUFDLEdBQUcsQ0FBQyxDQUFDO2dCQUNqQixNQUFNLENBQUMsR0FBRyxDQUFDLENBQUM7WUFDaEIsQ0FBQztRQUNMLENBQUMsQ0FBQyxDQUFDO0lBQ1AsQ0FBQyxDQUFDQSxDQUFDQTtBQUNQQSxDQUFDQTtBQUdELGtCQUFrQixJQUFZLEVBQUUsUUFBZ0IsRUFBRSxFQUFVLEVBQUUsTUFBYyxFQUFFLEdBQW1DO0lBQzdHQyxNQUFNQSxDQUFDQSxJQUFJQSxPQUFPQSxDQUFDQSxVQUFTQSxPQUFPQSxFQUFFQSxNQUFNQTtRQUN2QyxHQUFHLENBQUMsR0FBRyxDQUFDLEVBQUUsR0FBRyxHQUFHLEdBQUcsR0FBRyxDQUFDLEdBQUcsQ0FBQyxDQUFDLElBQUksQ0FBQyxVQUFTLENBQUM7WUFDdkMsR0FBRyxDQUFDLElBQUksR0FBRyxDQUFDLENBQUMsSUFBSSxDQUFDO1lBQ2xCLEdBQUcsQ0FBQyxHQUFHLENBQUMsRUFBRSxHQUFHLEdBQUcsR0FBRyxHQUFHLENBQUMsR0FBRyxFQUFFLEdBQUcsQ0FBQyxDQUFDLElBQUksQ0FBQztnQkFDbEMsT0FBTyxDQUFDLEdBQUcsQ0FBQyxDQUFDO1lBQ2pCLENBQUMsQ0FBQyxDQUFDLEtBQUssQ0FBQyxVQUFTLEdBQUc7Z0JBQ2pCLE1BQU0sQ0FBQyxHQUFHLENBQUMsQ0FBQztZQUNoQixDQUFDLENBQUMsQ0FBQztRQUNQLENBQUMsQ0FBQyxDQUFDLEtBQUssQ0FBQyxVQUFTLEdBQUc7WUFDakIsRUFBRSxDQUFDLENBQUMsR0FBRyxDQUFDLFVBQVUsS0FBSyxHQUFHLENBQUMsQ0FBQyxDQUFDO2dCQUN6QixHQUFHLENBQUMsSUFBSSxDQUFDLEVBQUUsR0FBRyxHQUFHLEVBQUUsR0FBRyxDQUFDLENBQUMsSUFBSSxDQUFDO29CQUN6QixPQUFPLENBQUMsR0FBRyxDQUFDLENBQUM7Z0JBQ2pCLENBQUMsQ0FBQyxDQUFDLEtBQUssQ0FBQyxVQUFTLEdBQUc7b0JBQ2pCLE1BQU0sQ0FBQyxHQUFHLENBQUMsQ0FBQztnQkFDaEIsQ0FBQyxDQUFDLENBQUM7WUFDUCxDQUFDO1lBQUMsSUFBSSxDQUFDLENBQUM7Z0JBQ0osT0FBTyxDQUFDLEdBQUcsQ0FBQyxHQUFHLENBQUMsQ0FBQztnQkFDakIsTUFBTSxDQUFDLEdBQUcsQ0FBQyxDQUFDO1lBQ2hCLENBQUM7UUFDTCxDQUFDLENBQUMsQ0FBQztJQUNQLENBQUMsQ0FBQ0EsQ0FBQ0E7QUFFUEEsQ0FBQ0E7QUFFRCxnQkFBZ0IsR0FBYyxFQUFFLE1BQU0sRUFBRSxHQUFHO0lBQ3ZDQyxJQUFJQSxZQUFZQSxHQUFHQSxLQUFLQSxDQUFDQTtJQUN6QkEsSUFBSUEsWUFBWUEsR0FBR0EsS0FBS0EsQ0FBQ0E7SUFFekJBLENBQUNBLENBQUNBLEdBQUdBLENBQUNBLEdBQUdBLEVBQUVBLFVBQVNBLE1BQU1BO1FBQ3RCLEVBQUUsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDO1lBQ2hCLFlBQVksR0FBRyxJQUFJLENBQUM7WUFFcEIsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxNQUFNLENBQUMsT0FBTyxFQUFFLFVBQVMsQ0FBQztnQkFDNUIsRUFBRSxDQUFDLENBQUMsQ0FBQyxDQUFDLEVBQUUsS0FBSyxHQUFHLENBQUMsQ0FBQyxDQUFDO29CQUNmLFlBQVksR0FBRyxJQUFJLENBQUM7Z0JBQ3hCLENBQUM7WUFDTCxDQUFDLENBQUMsQ0FBQztRQUNQLENBQUM7SUFDTCxDQUFDLENBQUNBLENBQUNBO0lBQ0hBLE1BQU1BLENBQUNBLEVBQUVBLE1BQU1BLEVBQUVBLFlBQVlBLEVBQUVBLE1BQU1BLEVBQUVBLFlBQVlBLEVBQUVBLENBQUNBO0FBQzFEQSxDQUFDQTtBQXFDRCxpQkFBUztJQUlMLG1CQUFZLEVBQVk7UUFDcEJDLElBQUlBLENBQUNBLE9BQU9BLEdBQUdBLEVBQUVBLENBQUNBO1FBQ2xCQSxJQUFJQSxDQUFDQSxHQUFHQSxHQUFHQSxFQUFFQSxDQUFDQTtJQUNsQkEsQ0FBQ0E7SUFFRCx1QkFBRyxHQUFILFVBQUksSUFBWSxFQUFFLFFBQWdCLEVBQUUsRUFBVSxFQUFFLE1BQWMsRUFBRSxNQUFlO1FBRTNFQyxJQUFJQSxLQUFLQSxHQUFHQSxNQUFNQSxDQUFDQSxJQUFJQSxDQUFDQSxHQUFHQSxFQUFFQSxNQUFNQSxFQUFFQSxNQUFNQSxDQUFDQSxFQUFFQSxDQUFDQSxDQUFDQTtRQUNoREEsRUFBRUEsQ0FBQ0EsQ0FBQ0EsQ0FBQ0EsS0FBS0EsQ0FBQ0EsTUFBTUEsQ0FBQ0EsQ0FBQ0EsQ0FBQ0E7WUFFaEJBLElBQUlBLENBQUNBLEdBQUdBLENBQUNBLElBQUlBLENBQUNBO2dCQUNWQSxNQUFNQSxFQUFFQSxNQUFNQTtnQkFDZEEsSUFBSUEsRUFBRUEsSUFBSUE7Z0JBQ1ZBLFFBQVFBLEVBQUVBLFFBQVFBO2dCQUNsQkEsRUFBRUEsRUFBRUEsSUFBSUEsQ0FBQ0EsT0FBT0EsQ0FBQ0EsUUFBUUEsR0FBR0EsS0FBS0EsR0FBR0EsSUFBSUEsR0FBR0EsR0FBR0EsR0FBR0EsUUFBUUEsR0FBR0EsR0FBR0EsR0FBR0EsSUFBSUEsQ0FBQ0EsT0FBT0EsQ0FBQ0EsSUFBSUEsR0FBR0EsR0FBR0EsR0FBR0EsRUFBRUE7Z0JBQzlGQSxPQUFPQSxFQUFFQSxDQUFDQSxFQUFFQSxFQUFFQSxFQUFFQSxNQUFNQSxDQUFDQSxFQUFFQSxFQUFFQSxNQUFNQSxFQUFFQSxNQUFNQSxFQUFFQSxDQUFDQTthQUMvQ0EsQ0FBQ0EsQ0FBQ0E7WUFFSEEsTUFBTUEsQ0FBQ0EsV0FBV0EsQ0FBQ0EsSUFBSUEsRUFBRUEsUUFBUUEsRUFBRUEsSUFBSUEsQ0FBQ0EsT0FBT0EsQ0FBQ0EsUUFBUUEsR0FBR0EsS0FBS0EsR0FBR0EsSUFBSUEsR0FBR0EsR0FBR0EsR0FBR0EsUUFBUUEsR0FBR0EsR0FBR0EsR0FBR0EsSUFBSUEsQ0FBQ0EsT0FBT0EsQ0FBQ0EsSUFBSUEsR0FBR0EsR0FBR0EsR0FBR0EsRUFBRUEsRUFBRUEsTUFBTUEsRUFBRUEsSUFBSUEsQ0FBQ0EsQ0FBQ0E7UUFFakpBLENBQUNBO1FBQUNBLElBQUlBLENBQUNBLEVBQUVBLENBQUNBLENBQUNBLENBQUNBLEtBQUtBLENBQUNBLE1BQU1BLENBQUNBLENBQUNBLENBQUNBO1lBQ3ZCQSxDQUFDQSxDQUFDQSxHQUFHQSxDQUFDQSxJQUFJQSxDQUFDQSxHQUFHQSxFQUFFQSxVQUFTQSxNQUFNQTtnQkFDM0IsRUFBRSxDQUFDLENBQUMsTUFBTSxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUM7b0JBQ2hCLE1BQU0sQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLEVBQUUsRUFBRSxFQUFFLE1BQU0sQ0FBQyxFQUFFLEVBQUUsTUFBTSxFQUFFLE1BQU0sRUFBRSxDQUFDLENBQUM7Z0JBQzNELENBQUM7WUFDTCxDQUFDLENBQUNBLENBQUNBO1lBQ0hBLE9BQU9BLENBQUNBLEdBQUdBLENBQUNBLGlCQUFpQkEsR0FBR0EsTUFBTUEsQ0FBQ0EsQ0FBQ0E7UUFDNUNBLENBQUNBO0lBR0xBLENBQUNBOztJQUNELDRCQUFRLEdBQVIsVUFBUyxNQUFjLEVBQUUsSUFBWSxFQUFFLElBQVM7UUFFNUNDLE1BQU1BLENBQUNBLElBQUlBLE9BQU9BLENBQUNBLFVBQVNBLE9BQU9BLEVBQUVBLE1BQU1BO1lBRXZDLE1BQU0sQ0FBQyxNQUFNLENBQUMsQ0FBQztRQUVuQixDQUFDLENBQUNBLENBQUNBO0lBR1BBLENBQUNBOztJQUNELDBCQUFNLEdBQU4sVUFBTyxNQUFjLEVBQUUsR0FBVztRQUU5QkMsSUFBSUEsUUFBUUEsR0FBY0EsRUFBRUEsQ0FBQ0E7UUFFN0JBLEdBQUdBLENBQUNBLENBQUNBLEdBQUdBLENBQUNBLEdBQUdBLEdBQUdBLENBQUNBLEVBQUVBLEdBQUdBLEdBQUdBLElBQUlBLENBQUNBLEdBQUdBLENBQUNBLE1BQU1BLEVBQUVBLEdBQUdBLEVBQUVBLEVBQUVBLENBQUNBO1lBRTdDQSxJQUFJQSxNQUFNQSxHQUFHQSxJQUFJQSxDQUFDQSxHQUFHQSxDQUFDQSxHQUFHQSxDQUFDQSxDQUFDQTtZQUkzQkEsRUFBRUEsQ0FBQ0EsQ0FBQ0EsTUFBTUEsQ0FBQ0EsTUFBTUEsS0FBS0EsTUFBTUEsQ0FBQ0EsQ0FBQ0EsQ0FBQ0E7Z0JBRTNCQSxFQUFFQSxDQUFDQSxDQUFDQSxNQUFNQSxDQUFDQSxPQUFPQSxDQUFDQSxNQUFNQSxLQUFLQSxDQUFDQSxJQUFJQSxNQUFNQSxDQUFDQSxPQUFPQSxDQUFDQSxDQUFDQSxDQUFDQSxDQUFDQSxFQUFFQSxLQUFLQSxHQUFHQSxDQUFDQSxDQUFDQSxDQUFDQTtvQkFDOURBLFdBQVdBLENBQUNBLE1BQU1BLENBQUNBLElBQUlBLEVBQUVBLE1BQU1BLENBQUNBLFFBQVFBLEVBQUVBLE1BQU1BLENBQUNBLEVBQUVBLEVBQUVBLE1BQU1BLENBQUNBLE1BQU1BLEVBQUVBLEtBQUtBLENBQUNBLENBQUNBLElBQUlBLENBQUNBO3dCQUM1RSxPQUFPLENBQUMsR0FBRyxDQUFDLGtCQUFrQixDQUFDLENBQUM7b0JBQ3BDLENBQUMsQ0FBQ0EsQ0FBQ0EsS0FBS0EsQ0FBQ0EsVUFBU0EsR0FBR0E7d0JBQ2pCLE9BQU8sQ0FBQyxHQUFHLENBQUMsd0JBQXdCLENBQUMsQ0FBQzt3QkFDdEMsT0FBTyxDQUFDLEdBQUcsQ0FBQyxHQUFHLENBQUMsQ0FBQztvQkFDckIsQ0FBQyxDQUFDQSxDQUFDQTtvQkFFSEEsQ0FBQ0EsQ0FBQ0EsR0FBR0EsQ0FBQ0EsSUFBSUEsQ0FBQ0EsR0FBR0EsRUFBRUEsVUFBU0EsRUFBRUE7d0JBQ3ZCLEVBQUUsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxNQUFNLEtBQUssTUFBTSxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUM7NEJBQzlCLFFBQVEsQ0FBQyxJQUFJLENBQUMsRUFBRSxDQUFDLENBQUM7d0JBQ3RCLENBQUM7b0JBRUwsQ0FBQyxDQUFDQSxDQUFDQTtvQkFDSEEsSUFBSUEsQ0FBQ0EsR0FBR0EsR0FBR0EsUUFBUUEsQ0FBQ0E7Z0JBRXhCQSxDQUFDQTtnQkFBQ0EsSUFBSUEsQ0FBQ0EsQ0FBQ0E7b0JBQ0pBLE9BQU9BLENBQUNBLEdBQUdBLENBQUNBLE1BQU1BLENBQUNBLENBQUNBO2dCQUt4QkEsQ0FBQ0E7WUFDTEEsQ0FBQ0E7UUFDTEEsQ0FBQ0E7SUFDTEEsQ0FBQ0E7O0lBRUQsd0JBQUksR0FBSixVQUFLLE1BQWU7UUFDaEJDLElBQUlBLE9BQU9BLEdBQWFBLEVBQUVBLENBQUNBO1FBQzNCQSxFQUFFQSxDQUFDQSxDQUFDQSxNQUFNQSxDQUFDQSxDQUFDQSxDQUFDQTtZQUVUQSxDQUFDQSxDQUFDQSxHQUFHQSxDQUFDQSxJQUFJQSxDQUFDQSxHQUFHQSxFQUFFQSxVQUFTQSxNQUFNQTtnQkFDM0IsRUFBRSxDQUFDLENBQUMsTUFBTSxDQUFDLE1BQU0sS0FBSyxNQUFNLENBQUMsQ0FBQyxDQUFDO29CQUMzQixPQUFPLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxNQUFNLENBQUMsQ0FBQztnQkFDaEMsQ0FBQztZQUNMLENBQUMsQ0FBQ0EsQ0FBQ0E7UUFFUEEsQ0FBQ0E7UUFBQ0EsSUFBSUEsQ0FBQ0EsQ0FBQ0E7WUFFSkEsQ0FBQ0EsQ0FBQ0EsR0FBR0EsQ0FBQ0EsSUFBSUEsQ0FBQ0EsR0FBR0EsRUFBRUEsVUFBU0EsTUFBTUE7Z0JBQzNCLE9BQU8sQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLE1BQU0sQ0FBQyxDQUFDO1lBQ2hDLENBQUMsQ0FBQ0EsQ0FBQ0E7UUFFUEEsQ0FBQ0E7UUFFREEsTUFBTUEsQ0FBQ0EsT0FBT0EsQ0FBQ0E7SUFFbkJBLENBQUNBOztJQUNELHVCQUFHLEdBQUgsVUFBSSxNQUFlO1FBQ2ZDLElBQUlBLE9BQU9BLEdBQWNBLEVBQUVBLENBQUNBO1FBRTVCQSxFQUFFQSxDQUFDQSxDQUFDQSxNQUFNQSxDQUFDQSxDQUFDQSxDQUFDQTtZQUNUQSxDQUFDQSxDQUFDQSxHQUFHQSxDQUFDQSxJQUFJQSxDQUFDQSxHQUFHQSxFQUFFQSxVQUFTQSxNQUFNQTtnQkFDM0IsRUFBRSxDQUFDLENBQUMsTUFBTSxDQUFDLE1BQU0sS0FBSyxNQUFNLENBQUMsQ0FBQyxDQUFDO29CQUUzQixDQUFDLENBQUMsR0FBRyxDQUFDLE1BQU0sQ0FBQyxPQUFPLEVBQUUsVUFBUyxDQUFDO3dCQUM1QixPQUFPLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxNQUFNLENBQUMsQ0FBQztvQkFDM0IsQ0FBQyxDQUFDLENBQUM7Z0JBQ1AsQ0FBQztZQUNMLENBQUMsQ0FBQ0EsQ0FBQ0E7UUFFUEEsQ0FBQ0E7UUFBQ0EsSUFBSUEsQ0FBQ0EsQ0FBQ0E7WUFHSkEsQ0FBQ0EsQ0FBQ0EsR0FBR0EsQ0FBQ0EsSUFBSUEsQ0FBQ0EsR0FBR0EsRUFBRUEsVUFBU0EsTUFBTUE7Z0JBQzNCLENBQUMsQ0FBQyxHQUFHLENBQUMsTUFBTSxDQUFDLE9BQU8sRUFBRSxVQUFTLENBQUM7b0JBRTVCLE9BQU8sQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxDQUFDO2dCQUczQixDQUFDLENBQUMsQ0FBQztZQUNQLENBQUMsQ0FBQ0EsQ0FBQ0E7UUFHUEEsQ0FBQ0E7UUFDREEsTUFBTUEsQ0FBQ0EsT0FBT0EsQ0FBQ0E7SUFDbkJBLENBQUNBOztJQUNELDJCQUFPLEdBQVAsVUFBUSxNQUFlO1FBQ25CQyxJQUFJQSxHQUFHQSxDQUFDQTtRQUNSQSxFQUFFQSxDQUFDQSxDQUFDQSxNQUFNQSxDQUFDQSxDQUFDQSxDQUFDQTtZQUNUQSxDQUFDQSxDQUFDQSxHQUFHQSxDQUFDQSxJQUFJQSxDQUFDQSxHQUFHQSxFQUFFQSxVQUFTQSxNQUFNQTtnQkFDM0IsRUFBRSxDQUFDLENBQUMsTUFBTSxDQUFDLE1BQU0sS0FBSyxNQUFNLENBQUMsQ0FBQyxDQUFDO29CQUMzQixHQUFHLEdBQUcsQ0FBQyxDQUFDLEtBQUssQ0FBQyxNQUFNLENBQUMsT0FBTyxFQUFFLElBQUksQ0FBQyxDQUFDO2dCQUN4QyxDQUFDO1lBQ0wsQ0FBQyxDQUFDQSxDQUFDQTtZQUNIQSxNQUFNQSxDQUFDQSxHQUFHQSxDQUFDQTtRQUNmQSxDQUFDQTtRQUFDQSxJQUFJQSxDQUFDQSxDQUFDQTtZQUNKQSxHQUFHQSxHQUFHQSxFQUFFQSxDQUFDQTtZQUVUQSxDQUFDQSxDQUFDQSxHQUFHQSxDQUFDQSxJQUFJQSxDQUFDQSxHQUFHQSxFQUFFQSxVQUFTQSxNQUFNQTtnQkFDM0IsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxNQUFNLENBQUMsT0FBTyxFQUFFLFVBQVMsQ0FBQztvQkFDNUIsR0FBRyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUM7Z0JBQ25CLENBQUMsQ0FBQyxDQUFDO1lBQ1AsQ0FBQyxDQUFDQSxDQUFDQTtZQUVIQSxNQUFNQSxDQUFDQSxHQUFHQSxDQUFDQTtRQUNmQSxDQUFDQTtJQUVMQSxDQUFDQTs7SUFLTCxnQkFBQztBQUFELENBaEtTLEFBZ0tSLEdBQUEsQ0FBQyIsImZpbGUiOiJtb2R1bGVzL21hY2hDbGllbnRzLmpzIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0ICogYXMgXyBmcm9tIFwibG9kYXNoXCI7XG5pbXBvcnQgKiBhcyBQcm9taXNlIGZyb20gXCJibHVlYmlyZFwiO1xubGV0IHJwaiA9IHJlcXVpcmUoXCJyZXF1ZXN0LXByb21pc2UtanNvblwiKTtcblxuZnVuY3Rpb24gbWNvbm5lY3Rpb24odXNlcjogc3RyaW5nLCBwYXNzd29yZDogc3RyaW5nLCBkYjogc3RyaW5nLCBzZXJpYWw6IHN0cmluZywgYm9vbD86IGJvb2xlYW4pIHtcbiAgICByZXR1cm4gbmV3IFByb21pc2UoZnVuY3Rpb24ocmVzb2x2ZSwgcmVqZWN0KSB7XG4gICAgICAgIHJwai5nZXQoZGIgKyBcIi9jb25uZWN0aW9uX1wiICsgc2VyaWFsKS50aGVuKGZ1bmN0aW9uKGRvYykge1xuICAgICAgICAgICAgZG9jLmNvbm5lY3RlZCA9IGJvb2w7XG4gICAgICAgICAgICBkb2MudXBkYXRlZEF0ID0gbmV3IERhdGUoKS5nZXRUaW1lKCk7XG4gICAgICAgICAgICBycGoucHV0KGRiICsgXCIvY29ubmVjdGlvbl9cIiArIHNlcmlhbCwgZG9jKS50aGVuKGZ1bmN0aW9uKGQpIHtcbiAgICAgICAgICAgICAgICByZXNvbHZlKHRydWUpO1xuICAgICAgICAgICAgfSkuY2F0Y2goZnVuY3Rpb24oZXJyKSB7XG4gICAgICAgICAgICAgICAgY29uc29sZS5sb2coZXJyKTtcbiAgICAgICAgICAgICAgICByZWplY3QoZXJyKTtcbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9KS5jYXRjaChmdW5jdGlvbihlcnIpIHtcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKGVycik7XG5cbiAgICAgICAgICAgIGlmIChib29sID09PSB0cnVlICYmIGVyci5zdGF0dXNDb2RlID09PSA0MDQpIHsgIC8vIGlmIGRvY25vdCBleGl0IGUgYm9vbCB0cnVlIGJsYSBibGEgYmxhXG5cbiAgICAgICAgICAgICAgICBsZXQgZG9jID0ge1xuICAgICAgICAgICAgICAgICAgICBfaWQ6IFwiY29ubmVjdGlvbl9cIiArIHNlcmlhbCxcbiAgICAgICAgICAgICAgICAgICAgY29ubmVjdGVkOiB0cnVlLFxuICAgICAgICAgICAgICAgICAgICB1cGRhdGVkQXQ6IG5ldyBEYXRlKCkuZ2V0VGltZSgpXG4gICAgICAgICAgICAgICAgfTtcblxuICAgICAgICAgICAgICAgIHJwai5wb3N0KGRiLCBkb2MpLnRoZW4oZnVuY3Rpb24oZG9jKSB7XG4gICAgICAgICAgICAgICAgICAgIHJlc29sdmUodHJ1ZSk7XG4gICAgICAgICAgICAgICAgfSkuY2F0Y2goZnVuY3Rpb24oZXJyKSB7XG4gICAgICAgICAgICAgICAgICAgIHJlamVjdCh7IGVycm9yOiBcIndyb25nIGNyZWRlbnRpYWxzXCIgfSk7XG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKGVycik7XG4gICAgICAgICAgICAgICAgcmVqZWN0KGVycik7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0pO1xuICAgIH0pO1xufVxuXG5cbmZ1bmN0aW9uIHB1c2h0b2RiKHVzZXI6IHN0cmluZywgcGFzc3dvcmQ6IHN0cmluZywgZGI6IHN0cmluZywgc2VyaWFsOiBzdHJpbmcsIGRvYzogeyBfaWQ6IHN0cmluZywgX3Jldj86IHN0cmluZyB9KSB7XG4gICAgcmV0dXJuIG5ldyBQcm9taXNlKGZ1bmN0aW9uKHJlc29sdmUsIHJlamVjdCkge1xuICAgICAgICBycGouZ2V0KGRiICsgXCIvXCIgKyBkb2MuX2lkKS50aGVuKGZ1bmN0aW9uKGQpIHtcbiAgICAgICAgICAgIGRvYy5fcmV2ID0gZC5fcmV2O1xuICAgICAgICAgICAgcnBqLnB1dChkYiArIFwiL1wiICsgZG9jLl9pZCwgZG9jKS50aGVuKGZ1bmN0aW9uKCkge1xuICAgICAgICAgICAgICAgIHJlc29sdmUoZG9jKTtcbiAgICAgICAgICAgIH0pLmNhdGNoKGZ1bmN0aW9uKGVycikge1xuICAgICAgICAgICAgICAgIHJlamVjdChlcnIpO1xuICAgICAgICAgICAgfSk7XG4gICAgICAgIH0pLmNhdGNoKGZ1bmN0aW9uKGVycikge1xuICAgICAgICAgICAgaWYgKGVyci5zdGF0dXNDb2RlID09PSA0MDQpIHtcbiAgICAgICAgICAgICAgICBycGoucG9zdChkYiArIFwiL1wiLCBkb2MpLnRoZW4oZnVuY3Rpb24oKSB7XG4gICAgICAgICAgICAgICAgICAgIHJlc29sdmUoZG9jKTtcbiAgICAgICAgICAgICAgICB9KS5jYXRjaChmdW5jdGlvbihlcnIpIHtcbiAgICAgICAgICAgICAgICAgICAgcmVqZWN0KGVycik7XG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKGVycik7XG4gICAgICAgICAgICAgICAgcmVqZWN0KGVycik7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0pO1xuICAgIH0pO1xuXG59XG5cbmZ1bmN0aW9uIGV4aXN0cyhhbGw6IElDbGllbnRbXSwgc2VyaWFsLCBzaWQpOiB7IHNlcmlhbDogYm9vbGVhbiwgc29ja2V0OiBib29sZWFuIH0ge1xuICAgIGxldCBzZXJpYWxleGlzdHMgPSBmYWxzZTtcbiAgICBsZXQgc29ja2V0ZXhpc3RzID0gZmFsc2U7XG5cbiAgICBfLm1hcChhbGwsIGZ1bmN0aW9uKGNsaWVudCkge1xuICAgICAgICBpZiAoY2xpZW50LnNlcmlhbCkge1xuICAgICAgICAgICAgc2VyaWFsZXhpc3RzID0gdHJ1ZTtcblxuICAgICAgICAgICAgXy5tYXAoY2xpZW50LnNvY2tldHMsIGZ1bmN0aW9uKHMpIHtcbiAgICAgICAgICAgICAgICBpZiAocy5pZCA9PT0gc2lkKSB7XG4gICAgICAgICAgICAgICAgICAgIHNvY2tldGV4aXN0cyA9IHRydWU7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSk7XG4gICAgICAgIH1cbiAgICB9KTtcbiAgICByZXR1cm4geyBzZXJpYWw6IHNlcmlhbGV4aXN0cywgc29ja2V0OiBzb2NrZXRleGlzdHMgfTtcbn1cblxuXG5pbnRlcmZhY2UgSVNvY2tldEFycmF5IHtcblxuICAgIGlkOiBzdHJpbmc7XG4gICAgc29ja2V0OiBJU29ja2V0O1xufVxuXG5pbnRlcmZhY2UgSVNvY2tldCB7XG4gICAgb246IEZ1bmN0aW9uO1xuICAgIGlkOiBzdHJpbmc7XG4gICAgZW1pdDogRnVuY3Rpb247XG4gICAgZGVjb2RlZF90b2tlbjoge1xuICAgICAgICBkYjogc3RyaW5nO1xuICAgICAgICB1c2VyOiBzdHJpbmc7XG4gICAgICAgIHBhc3N3b3JkOiBzdHJpbmc7XG4gICAgICAgIHNlcmlhbDogc3RyaW5nO1xuICAgIH07XG59XG5cbmludGVyZmFjZSBJQ2xpZW50IHtcbiAgICBzZXJpYWw6IHN0cmluZztcbiAgICBzb2NrZXRzOiBJU29ja2V0QXJyYXlbXTtcbiAgICB1c2VyOiBzdHJpbmc7XG4gICAgcGFzc3dvcmQ6IHN0cmluZztcbiAgICBkYjogc3RyaW5nO1xufVxuXG5cbmludGVyZmFjZSBJQ291Y2hkYiB7XG4gICAgcHJvdG9jb2w6IHN0cmluZztcbiAgICBwb3J0OiBudW1iZXI7XG4gICAgaG9zdDogc3RyaW5nO1xufVxuXG5cbmV4cG9ydCA9IGNsYXNzIE1hQ2xpZW50cyB7XG4gICAgYWxsOiBJQ2xpZW50W107XG4gICAgY291Y2hkYjogSUNvdWNoZGI7XG5cbiAgICBjb25zdHJ1Y3RvcihkYjogSUNvdWNoZGIpIHtcbiAgICAgICAgdGhpcy5jb3VjaGRiID0gZGI7XG4gICAgICAgIHRoaXMuYWxsID0gW107XG4gICAgfVxuXG4gICAgYWRkKHVzZXI6IHN0cmluZywgcGFzc3dvcmQ6IHN0cmluZywgZGI6IHN0cmluZywgc2VyaWFsOiBzdHJpbmcsIHNvY2tldDogSVNvY2tldCkge1xuXG4gICAgICAgIGxldCBleGlzdCA9IGV4aXN0cyh0aGlzLmFsbCwgc2VyaWFsLCBzb2NrZXQuaWQpO1xuICAgICAgICBpZiAoIWV4aXN0LnNlcmlhbCkge1xuXG4gICAgICAgICAgICB0aGlzLmFsbC5wdXNoKHtcbiAgICAgICAgICAgICAgICBzZXJpYWw6IHNlcmlhbCxcbiAgICAgICAgICAgICAgICB1c2VyOiB1c2VyLFxuICAgICAgICAgICAgICAgIHBhc3N3b3JkOiBwYXNzd29yZCxcbiAgICAgICAgICAgICAgICBkYjogdGhpcy5jb3VjaGRiLnByb3RvY29sICsgXCI6Ly9cIiArIHVzZXIgKyBcIjpcIiArIHBhc3N3b3JkICsgXCJAXCIgKyB0aGlzLmNvdWNoZGIuaG9zdCArIFwiL1wiICsgZGIsXG4gICAgICAgICAgICAgICAgc29ja2V0czogW3sgaWQ6IHNvY2tldC5pZCwgc29ja2V0OiBzb2NrZXQgfV1cbiAgICAgICAgICAgIH0pO1xuXG4gICAgICAgICAgICByZXR1cm4gbWNvbm5lY3Rpb24odXNlciwgcGFzc3dvcmQsIHRoaXMuY291Y2hkYi5wcm90b2NvbCArIFwiOi8vXCIgKyB1c2VyICsgXCI6XCIgKyBwYXNzd29yZCArIFwiQFwiICsgdGhpcy5jb3VjaGRiLmhvc3QgKyBcIi9cIiArIGRiLCBzZXJpYWwsIHRydWUpO1xuXG4gICAgICAgIH0gZWxzZSBpZiAoIWV4aXN0LnNvY2tldCkge1xuICAgICAgICAgICAgXy5tYXAodGhpcy5hbGwsIGZ1bmN0aW9uKGNsaWVudCkge1xuICAgICAgICAgICAgICAgIGlmIChjbGllbnQuc2VyaWFsKSB7XG4gICAgICAgICAgICAgICAgICAgIGNsaWVudC5zb2NrZXRzLnB1c2goeyBpZDogc29ja2V0LmlkLCBzb2NrZXQ6IHNvY2tldCB9KTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKFwibmV3IHNvY2tldCBmb3IgXCIgKyBzZXJpYWwpO1xuICAgICAgICB9XG5cblxuICAgIH07XG4gICAgcHVzaGRhdGEoc2VyaWFsOiBzdHJpbmcsIHR5cGU6IHN0cmluZywgZGF0YTogYW55KSB7XG5cbiAgICAgICAgcmV0dXJuIG5ldyBQcm9taXNlKGZ1bmN0aW9uKHJlc29sdmUsIHJlamVjdCkge1xuXG4gICAgICAgICAgICByZWplY3QoXCJ0b2RvXCIpO1xuXG4gICAgICAgIH0pO1xuXG5cbiAgICB9O1xuICAgIHJlbW92ZShzZXJpYWw6IHN0cmluZywgc2lkOiBzdHJpbmcpIHtcblxuICAgICAgICBsZXQgcmVtYW5pbmc6IElDbGllbnRbXSA9IFtdO1xuXG4gICAgICAgIGZvciAobGV0IHNvYyA9IDA7IHNvYyA8IHRoaXMuYWxsLmxlbmd0aDsgc29jKyspIHtcblxuICAgICAgICAgICAgdmFyIGNsaWVudCA9IHRoaXMuYWxsW3NvY107XG5cblxuXG4gICAgICAgICAgICBpZiAoY2xpZW50LnNlcmlhbCA9PT0gc2VyaWFsKSB7XG5cbiAgICAgICAgICAgICAgICBpZiAoY2xpZW50LnNvY2tldHMubGVuZ3RoID09PSAxICYmIGNsaWVudC5zb2NrZXRzWzBdLmlkID09PSBzaWQpIHtcbiAgICAgICAgICAgICAgICAgICAgbWNvbm5lY3Rpb24oY2xpZW50LnVzZXIsIGNsaWVudC5wYXNzd29yZCwgY2xpZW50LmRiLCBjbGllbnQuc2VyaWFsLCBmYWxzZSkudGhlbihmdW5jdGlvbigpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKFwic3dpdGNoZWQgb2ZmbGluZVwiKTtcbiAgICAgICAgICAgICAgICAgICAgfSkuY2F0Y2goZnVuY3Rpb24oZXJyKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhcInN3aXRjaGVkIG9mZmxpbmUgZXJyb3JcIik7XG4gICAgICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhlcnIpO1xuICAgICAgICAgICAgICAgICAgICB9KTtcblxuICAgICAgICAgICAgICAgICAgICBfLm1hcCh0aGlzLmFsbCwgZnVuY3Rpb24oZWwpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChlbC5zZXJpYWwgIT09IGNsaWVudC5zZXJpYWwpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZW1hbmluZy5wdXNoKGVsKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5hbGwgPSByZW1hbmluZztcblxuICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKFwidG9kb1wiKTtcbiAgICAgICAgICAgICAgICAgICAgLy8gdGhpcy5hbGw9Xy5yZWplY3QodGhpcy5hbGwsIGZ1bmN0aW9uKGVsKSB7XG4gICAgICAgICAgICAgICAgICAgIC8vICAgcmV0dXJuIGVsLnNlcmlhbCA9PT0gY2xpZW50LnNlcmlhbDtcbiAgICAgICAgICAgICAgICAgICAgLy8gfSlcblxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgIH07XG5cbiAgICBsaXN0KHNlcmlhbD86IHN0cmluZyk6IHN0cmluZ1tdIHtcbiAgICAgICAgbGV0IHNlcmlhbHM6IHN0cmluZ1tdID0gW107XG4gICAgICAgIGlmIChzZXJpYWwpIHtcblxuICAgICAgICAgICAgXy5tYXAodGhpcy5hbGwsIGZ1bmN0aW9uKGNsaWVudCkge1xuICAgICAgICAgICAgICAgIGlmIChjbGllbnQuc2VyaWFsID09PSBzZXJpYWwpIHtcbiAgICAgICAgICAgICAgICAgICAgc2VyaWFscy5wdXNoKGNsaWVudC5zZXJpYWwpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0pO1xuXG4gICAgICAgIH0gZWxzZSB7XG5cbiAgICAgICAgICAgIF8ubWFwKHRoaXMuYWxsLCBmdW5jdGlvbihjbGllbnQpIHtcbiAgICAgICAgICAgICAgICBzZXJpYWxzLnB1c2goY2xpZW50LnNlcmlhbCk7XG4gICAgICAgICAgICB9KTtcblxuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIHNlcmlhbHM7XG5cbiAgICB9O1xuICAgIGlvcyhzZXJpYWw/OiBzdHJpbmcpOiBJU29ja2V0W10ge1xuICAgICAgICBsZXQgc29ja2V0czogSVNvY2tldFtdID0gW107XG5cbiAgICAgICAgaWYgKHNlcmlhbCkge1xuICAgICAgICAgICAgXy5tYXAodGhpcy5hbGwsIGZ1bmN0aW9uKGNsaWVudCkge1xuICAgICAgICAgICAgICAgIGlmIChjbGllbnQuc2VyaWFsID09PSBzZXJpYWwpIHtcblxuICAgICAgICAgICAgICAgICAgICBfLm1hcChjbGllbnQuc29ja2V0cywgZnVuY3Rpb24ocykge1xuICAgICAgICAgICAgICAgICAgICAgICAgc29ja2V0cy5wdXNoKHMuc29ja2V0KTtcbiAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSk7XG5cbiAgICAgICAgfSBlbHNlIHtcblxuXG4gICAgICAgICAgICBfLm1hcCh0aGlzLmFsbCwgZnVuY3Rpb24oY2xpZW50KSB7XG4gICAgICAgICAgICAgICAgXy5tYXAoY2xpZW50LnNvY2tldHMsIGZ1bmN0aW9uKHMpIHtcblxuICAgICAgICAgICAgICAgICAgICBzb2NrZXRzLnB1c2gocy5zb2NrZXQpO1xuXG5cbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIH0pO1xuXG5cbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gc29ja2V0cztcbiAgICB9O1xuICAgIHNvY2tldHMoc2VyaWFsPzogc3RyaW5nKSB7XG4gICAgICAgIGxldCBpZHM7XG4gICAgICAgIGlmIChzZXJpYWwpIHtcbiAgICAgICAgICAgIF8ubWFwKHRoaXMuYWxsLCBmdW5jdGlvbihjbGllbnQpIHtcbiAgICAgICAgICAgICAgICBpZiAoY2xpZW50LnNlcmlhbCA9PT0gc2VyaWFsKSB7XG4gICAgICAgICAgICAgICAgICAgIGlkcyA9IF8ucGx1Y2soY2xpZW50LnNvY2tldHMsIFwiaWRcIik7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICByZXR1cm4gaWRzO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgaWRzID0gW107XG5cbiAgICAgICAgICAgIF8ubWFwKHRoaXMuYWxsLCBmdW5jdGlvbihjbGllbnQpIHtcbiAgICAgICAgICAgICAgICBfLm1hcChjbGllbnQuc29ja2V0cywgZnVuY3Rpb24ocykge1xuICAgICAgICAgICAgICAgICAgICBpZHMucHVzaChzLmlkKTtcbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIH0pO1xuXG4gICAgICAgICAgICByZXR1cm4gaWRzO1xuICAgICAgICB9XG5cbiAgICB9O1xuXG5cblxuXG59O1xuIl0sInNvdXJjZVJvb3QiOiIvc291cmNlLyJ9
