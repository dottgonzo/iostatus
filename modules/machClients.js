"use strict";
var _ = require("lodash");
var Promise = require("bluebird");
var rpj = require("request-promise-json");
function mconnection(user, password, db, serial, bool) {
    return new Promise(function (resolve, reject) {
        rpj.get(db + "/connection_" + serial).then(function (doc) {
            doc.connected = bool;
            doc.updatedAt = new Date().getTime();
            rpj.put(db + "/connection_" + serial, doc).then(function (d) {
                resolve(true);
            }).catch(function (err) {
                console.log(err);
                reject(err);
            });
        }).catch(function (err) {
            console.log(err);
            if (bool === true && err.statusCode === 404) {
                var doc = {
                    _id: "connection_" + serial,
                    connected: true,
                    updatedAt: new Date().getTime()
                };
                rpj.post(db, doc).then(function (doc) {
                    resolve(true);
                }).catch(function (err) {
                    reject({ error: "wrong credentials" });
                });
            }
            else {
                console.log(err);
                reject(err);
            }
        });
    });
}
function pushtodb(user, password, db, serial, doc) {
    return new Promise(function (resolve, reject) {
        rpj.get(db + "/" + doc._id).then(function (d) {
            doc._rev = d._rev;
            rpj.put(db + "/" + doc._id, doc).then(function () {
                resolve(doc);
            }).catch(function (err) {
                reject(err);
            });
        }).catch(function (err) {
            if (err.statusCode === 404) {
                rpj.post(db + "/", doc).then(function () {
                    resolve(doc);
                }).catch(function (err) {
                    reject(err);
                });
            }
            else {
                console.log(err);
                reject(err);
            }
        });
    });
}
function exists(all, serial, sid) {
    var serialexists = false;
    var socketexists = false;
    _.map(all, function (client) {
        if (client.serial) {
            serialexists = true;
            _.map(client.sockets, function (s) {
                if (s.id === sid) {
                    socketexists = true;
                }
            });
        }
    });
    return { serial: serialexists, socket: socketexists };
}
module.exports = (function () {
    function MaClients(db) {
        this.couchdb = db;
        this.all = [];
    }
    MaClients.prototype.add = function (user, password, db, serial, socket) {
        var exist = exists(this.all, serial, socket.id);
        if (!exist.serial) {
            this.all.push({
                serial: serial,
                user: user,
                password: password,
                db: this.couchdb.protocol + "://" + user + ":" + password + "@" + this.couchdb.host + "/" + db,
                sockets: [{ id: socket.id, socket: socket }]
            });
            return mconnection(user, password, this.couchdb.protocol + "://" + user + ":" + password + "@" + this.couchdb.host + "/" + db, serial, true);
        }
        else if (!exist.socket) {
            _.map(this.all, function (client) {
                if (client.serial) {
                    client.sockets.push({ id: socket.id, socket: socket });
                }
            });
            console.log("new socket for " + serial);
        }
    };
    ;
    MaClients.prototype.pushdata = function (serial, type, data) {
        return new Promise(function (resolve, reject) {
            reject("todo");
        });
    };
    ;
    MaClients.prototype.remove = function (serial, sid) {
        var remaning = [];
        for (var soc = 0; soc < this.all.length; soc++) {
            var client = this.all[soc];
            if (client.serial === serial) {
                if (client.sockets.length === 1 && client.sockets[0].id === sid) {
                    mconnection(client.user, client.password, client.db, client.serial, false).then(function () {
                        console.log("switched offline");
                    }).catch(function (err) {
                        console.log("switched offline error");
                        console.log(err);
                    });
                    _.map(this.all, function (el) {
                        if (el.serial !== client.serial) {
                            remaning.push(el);
                        }
                    });
                    this.all = remaning;
                }
                else {
                    console.log("todo");
                }
            }
        }
    };
    ;
    MaClients.prototype.list = function (serial) {
        var serials = [];
        if (serial) {
            _.map(this.all, function (client) {
                if (client.serial === serial) {
                    serials.push(client.serial);
                }
            });
        }
        else {
            _.map(this.all, function (client) {
                serials.push(client.serial);
            });
        }
        return serials;
    };
    ;
    MaClients.prototype.ios = function (serial) {
        var sockets = [];
        if (serial) {
            _.map(this.all, function (client) {
                if (client.serial === serial) {
                    _.map(client.sockets, function (s) {
                        sockets.push(s.socket);
                    });
                }
            });
        }
        else {
            _.map(this.all, function (client) {
                _.map(client.sockets, function (s) {
                    sockets.push(s.socket);
                });
            });
        }
        return sockets;
    };
    ;
    MaClients.prototype.sockets = function (serial) {
        var ids;
        if (serial) {
            _.map(this.all, function (client) {
                if (client.serial === serial) {
                    ids = _.pluck(client.sockets, "id");
                }
            });
            return ids;
        }
        else {
            ids = [];
            _.map(this.all, function (client) {
                _.map(client.sockets, function (s) {
                    ids.push(s.id);
                });
            });
            return ids;
        }
    };
    ;
    return MaClients;
}());

//# sourceMappingURL=data:application/json;base64,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IjoibW9kdWxlcy9tYWNoQ2xpZW50cy5qcyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCAqIGFzIF8gZnJvbSBcImxvZGFzaFwiO1xuaW1wb3J0ICogYXMgUHJvbWlzZSBmcm9tIFwiYmx1ZWJpcmRcIjtcbmxldCBycGogPSByZXF1aXJlKFwicmVxdWVzdC1wcm9taXNlLWpzb25cIik7XG5cbmZ1bmN0aW9uIG1jb25uZWN0aW9uKHVzZXI6IHN0cmluZywgcGFzc3dvcmQ6IHN0cmluZywgZGI6IHN0cmluZywgc2VyaWFsOiBzdHJpbmcsIGJvb2w/OiBib29sZWFuKSB7XG4gICAgcmV0dXJuIG5ldyBQcm9taXNlKGZ1bmN0aW9uKHJlc29sdmUsIHJlamVjdCkge1xuICAgICAgICBycGouZ2V0KGRiICsgXCIvY29ubmVjdGlvbl9cIiArIHNlcmlhbCkudGhlbihmdW5jdGlvbihkb2MpIHtcbiAgICAgICAgICAgIGRvYy5jb25uZWN0ZWQgPSBib29sO1xuICAgICAgICAgICAgZG9jLnVwZGF0ZWRBdCA9IG5ldyBEYXRlKCkuZ2V0VGltZSgpO1xuICAgICAgICAgICAgcnBqLnB1dChkYiArIFwiL2Nvbm5lY3Rpb25fXCIgKyBzZXJpYWwsIGRvYykudGhlbihmdW5jdGlvbihkKSB7XG4gICAgICAgICAgICAgICAgcmVzb2x2ZSh0cnVlKTtcbiAgICAgICAgICAgIH0pLmNhdGNoKGZ1bmN0aW9uKGVycikge1xuICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKGVycik7XG4gICAgICAgICAgICAgICAgcmVqZWN0KGVycik7XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfSkuY2F0Y2goZnVuY3Rpb24oZXJyKSB7XG4gICAgICAgICAgICBjb25zb2xlLmxvZyhlcnIpO1xuXG4gICAgICAgICAgICBpZiAoYm9vbCA9PT0gdHJ1ZSAmJiBlcnIuc3RhdHVzQ29kZSA9PT0gNDA0KSB7ICAvLyBpZiBkb2Nub3QgZXhpdCBlIGJvb2wgdHJ1ZSBibGEgYmxhIGJsYVxuXG4gICAgICAgICAgICAgICAgbGV0IGRvYyA9IHtcbiAgICAgICAgICAgICAgICAgICAgX2lkOiBcImNvbm5lY3Rpb25fXCIgKyBzZXJpYWwsXG4gICAgICAgICAgICAgICAgICAgIGNvbm5lY3RlZDogdHJ1ZSxcbiAgICAgICAgICAgICAgICAgICAgdXBkYXRlZEF0OiBuZXcgRGF0ZSgpLmdldFRpbWUoKVxuICAgICAgICAgICAgICAgIH07XG5cbiAgICAgICAgICAgICAgICBycGoucG9zdChkYiwgZG9jKS50aGVuKGZ1bmN0aW9uKGRvYykge1xuICAgICAgICAgICAgICAgICAgICByZXNvbHZlKHRydWUpO1xuICAgICAgICAgICAgICAgIH0pLmNhdGNoKGZ1bmN0aW9uKGVycikge1xuICAgICAgICAgICAgICAgICAgICByZWplY3QoeyBlcnJvcjogXCJ3cm9uZyBjcmVkZW50aWFsc1wiIH0pO1xuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhlcnIpO1xuICAgICAgICAgICAgICAgIHJlamVjdChlcnIpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9KTtcbiAgICB9KTtcbn1cblxuXG5mdW5jdGlvbiBwdXNodG9kYih1c2VyOiBzdHJpbmcsIHBhc3N3b3JkOiBzdHJpbmcsIGRiOiBzdHJpbmcsIHNlcmlhbDogc3RyaW5nLCBkb2M6IHsgX2lkOiBzdHJpbmcsIF9yZXY/OiBzdHJpbmcgfSkge1xuICAgIHJldHVybiBuZXcgUHJvbWlzZShmdW5jdGlvbihyZXNvbHZlLCByZWplY3QpIHtcbiAgICAgICAgcnBqLmdldChkYiArIFwiL1wiICsgZG9jLl9pZCkudGhlbihmdW5jdGlvbihkKSB7XG4gICAgICAgICAgICBkb2MuX3JldiA9IGQuX3JldjtcbiAgICAgICAgICAgIHJwai5wdXQoZGIgKyBcIi9cIiArIGRvYy5faWQsIGRvYykudGhlbihmdW5jdGlvbigpIHtcbiAgICAgICAgICAgICAgICByZXNvbHZlKGRvYyk7XG4gICAgICAgICAgICB9KS5jYXRjaChmdW5jdGlvbihlcnIpIHtcbiAgICAgICAgICAgICAgICByZWplY3QoZXJyKTtcbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9KS5jYXRjaChmdW5jdGlvbihlcnIpIHtcbiAgICAgICAgICAgIGlmIChlcnIuc3RhdHVzQ29kZSA9PT0gNDA0KSB7XG4gICAgICAgICAgICAgICAgcnBqLnBvc3QoZGIgKyBcIi9cIiwgZG9jKS50aGVuKGZ1bmN0aW9uKCkge1xuICAgICAgICAgICAgICAgICAgICByZXNvbHZlKGRvYyk7XG4gICAgICAgICAgICAgICAgfSkuY2F0Y2goZnVuY3Rpb24oZXJyKSB7XG4gICAgICAgICAgICAgICAgICAgIHJlamVjdChlcnIpO1xuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhlcnIpO1xuICAgICAgICAgICAgICAgIHJlamVjdChlcnIpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9KTtcbiAgICB9KTtcblxufVxuXG5mdW5jdGlvbiBleGlzdHMoYWxsOiBJQ2xpZW50W10sIHNlcmlhbCwgc2lkKTogeyBzZXJpYWw6IGJvb2xlYW4sIHNvY2tldDogYm9vbGVhbiB9IHtcbiAgICBsZXQgc2VyaWFsZXhpc3RzID0gZmFsc2U7XG4gICAgbGV0IHNvY2tldGV4aXN0cyA9IGZhbHNlO1xuXG4gICAgXy5tYXAoYWxsLCBmdW5jdGlvbihjbGllbnQpIHtcbiAgICAgICAgaWYgKGNsaWVudC5zZXJpYWwpIHtcbiAgICAgICAgICAgIHNlcmlhbGV4aXN0cyA9IHRydWU7XG5cbiAgICAgICAgICAgIF8ubWFwKGNsaWVudC5zb2NrZXRzLCBmdW5jdGlvbihzKSB7XG4gICAgICAgICAgICAgICAgaWYgKHMuaWQgPT09IHNpZCkge1xuICAgICAgICAgICAgICAgICAgICBzb2NrZXRleGlzdHMgPSB0cnVlO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9XG4gICAgfSk7XG4gICAgcmV0dXJuIHsgc2VyaWFsOiBzZXJpYWxleGlzdHMsIHNvY2tldDogc29ja2V0ZXhpc3RzIH07XG59XG5cblxuaW50ZXJmYWNlIElTb2NrZXRBcnJheSB7XG5cbiAgICBpZDogc3RyaW5nO1xuICAgIHNvY2tldDogSVNvY2tldDtcbn1cblxuaW50ZXJmYWNlIElTb2NrZXQge1xuICAgIG9uOiBGdW5jdGlvbjtcbiAgICBpZDogc3RyaW5nO1xuICAgIGVtaXQ6IEZ1bmN0aW9uO1xuICAgIGRlY29kZWRfdG9rZW46IHtcbiAgICAgICAgZGI6IHN0cmluZztcbiAgICAgICAgdXNlcjogc3RyaW5nO1xuICAgICAgICBwYXNzd29yZDogc3RyaW5nO1xuICAgICAgICBzZXJpYWw6IHN0cmluZztcbiAgICB9O1xufVxuXG5pbnRlcmZhY2UgSUNsaWVudCB7XG4gICAgc2VyaWFsOiBzdHJpbmc7XG4gICAgc29ja2V0czogSVNvY2tldEFycmF5W107XG4gICAgdXNlcjogc3RyaW5nO1xuICAgIHBhc3N3b3JkOiBzdHJpbmc7XG4gICAgZGI6IHN0cmluZztcbn1cblxuXG5pbnRlcmZhY2UgSUNvdWNoZGIge1xuICAgIHByb3RvY29sOiBzdHJpbmc7XG4gICAgcG9ydDogbnVtYmVyO1xuICAgIGhvc3Q6IHN0cmluZztcbn1cblxuXG5leHBvcnQgPSBjbGFzcyBNYUNsaWVudHMge1xuICAgIGFsbDogSUNsaWVudFtdO1xuICAgIGNvdWNoZGI6IElDb3VjaGRiO1xuXG4gICAgY29uc3RydWN0b3IoZGI6IElDb3VjaGRiKSB7XG4gICAgICAgIHRoaXMuY291Y2hkYiA9IGRiO1xuICAgICAgICB0aGlzLmFsbCA9IFtdO1xuICAgIH1cblxuICAgIGFkZCh1c2VyOiBzdHJpbmcsIHBhc3N3b3JkOiBzdHJpbmcsIGRiOiBzdHJpbmcsIHNlcmlhbDogc3RyaW5nLCBzb2NrZXQ6IElTb2NrZXQpIHtcblxuICAgICAgICBsZXQgZXhpc3QgPSBleGlzdHModGhpcy5hbGwsIHNlcmlhbCwgc29ja2V0LmlkKTtcbiAgICAgICAgaWYgKCFleGlzdC5zZXJpYWwpIHtcblxuICAgICAgICAgICAgdGhpcy5hbGwucHVzaCh7XG4gICAgICAgICAgICAgICAgc2VyaWFsOiBzZXJpYWwsXG4gICAgICAgICAgICAgICAgdXNlcjogdXNlcixcbiAgICAgICAgICAgICAgICBwYXNzd29yZDogcGFzc3dvcmQsXG4gICAgICAgICAgICAgICAgZGI6IHRoaXMuY291Y2hkYi5wcm90b2NvbCArIFwiOi8vXCIgKyB1c2VyICsgXCI6XCIgKyBwYXNzd29yZCArIFwiQFwiICsgdGhpcy5jb3VjaGRiLmhvc3QgKyBcIi9cIiArIGRiLFxuICAgICAgICAgICAgICAgIHNvY2tldHM6IFt7IGlkOiBzb2NrZXQuaWQsIHNvY2tldDogc29ja2V0IH1dXG4gICAgICAgICAgICB9KTtcblxuICAgICAgICAgICAgcmV0dXJuIG1jb25uZWN0aW9uKHVzZXIsIHBhc3N3b3JkLCB0aGlzLmNvdWNoZGIucHJvdG9jb2wgKyBcIjovL1wiICsgdXNlciArIFwiOlwiICsgcGFzc3dvcmQgKyBcIkBcIiArIHRoaXMuY291Y2hkYi5ob3N0ICsgXCIvXCIgKyBkYiwgc2VyaWFsLCB0cnVlKTtcblxuICAgICAgICB9IGVsc2UgaWYgKCFleGlzdC5zb2NrZXQpIHtcbiAgICAgICAgICAgIF8ubWFwKHRoaXMuYWxsLCBmdW5jdGlvbihjbGllbnQpIHtcbiAgICAgICAgICAgICAgICBpZiAoY2xpZW50LnNlcmlhbCkge1xuICAgICAgICAgICAgICAgICAgICBjbGllbnQuc29ja2V0cy5wdXNoKHsgaWQ6IHNvY2tldC5pZCwgc29ja2V0OiBzb2NrZXQgfSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICBjb25zb2xlLmxvZyhcIm5ldyBzb2NrZXQgZm9yIFwiICsgc2VyaWFsKTtcbiAgICAgICAgfVxuXG5cbiAgICB9O1xuICAgIHB1c2hkYXRhKHNlcmlhbDogc3RyaW5nLCB0eXBlOiBzdHJpbmcsIGRhdGE6IGFueSkge1xuXG4gICAgICAgIHJldHVybiBuZXcgUHJvbWlzZShmdW5jdGlvbihyZXNvbHZlLCByZWplY3QpIHtcblxuICAgICAgICAgICAgcmVqZWN0KFwidG9kb1wiKTtcblxuICAgICAgICB9KTtcblxuXG4gICAgfTtcbiAgICByZW1vdmUoc2VyaWFsOiBzdHJpbmcsIHNpZDogc3RyaW5nKSB7XG5cbiAgICAgICAgbGV0IHJlbWFuaW5nOiBJQ2xpZW50W10gPSBbXTtcblxuICAgICAgICBmb3IgKGxldCBzb2MgPSAwOyBzb2MgPCB0aGlzLmFsbC5sZW5ndGg7IHNvYysrKSB7XG5cbiAgICAgICAgICAgIHZhciBjbGllbnQgPSB0aGlzLmFsbFtzb2NdO1xuXG5cblxuICAgICAgICAgICAgaWYgKGNsaWVudC5zZXJpYWwgPT09IHNlcmlhbCkge1xuXG4gICAgICAgICAgICAgICAgaWYgKGNsaWVudC5zb2NrZXRzLmxlbmd0aCA9PT0gMSAmJiBjbGllbnQuc29ja2V0c1swXS5pZCA9PT0gc2lkKSB7XG4gICAgICAgICAgICAgICAgICAgIG1jb25uZWN0aW9uKGNsaWVudC51c2VyLCBjbGllbnQucGFzc3dvcmQsIGNsaWVudC5kYiwgY2xpZW50LnNlcmlhbCwgZmFsc2UpLnRoZW4oZnVuY3Rpb24oKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhcInN3aXRjaGVkIG9mZmxpbmVcIik7XG4gICAgICAgICAgICAgICAgICAgIH0pLmNhdGNoKGZ1bmN0aW9uKGVycikge1xuICAgICAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coXCJzd2l0Y2hlZCBvZmZsaW5lIGVycm9yXCIpO1xuICAgICAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coZXJyKTtcbiAgICAgICAgICAgICAgICAgICAgfSk7XG5cbiAgICAgICAgICAgICAgICAgICAgXy5tYXAodGhpcy5hbGwsIGZ1bmN0aW9uKGVsKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoZWwuc2VyaWFsICE9PSBjbGllbnQuc2VyaWFsKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVtYW5pbmcucHVzaChlbCk7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMuYWxsID0gcmVtYW5pbmc7XG5cbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhcInRvZG9cIik7XG4gICAgICAgICAgICAgICAgICAgIC8vIHRoaXMuYWxsPV8ucmVqZWN0KHRoaXMuYWxsLCBmdW5jdGlvbihlbCkge1xuICAgICAgICAgICAgICAgICAgICAvLyAgIHJldHVybiBlbC5zZXJpYWwgPT09IGNsaWVudC5zZXJpYWw7XG4gICAgICAgICAgICAgICAgICAgIC8vIH0pXG5cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICB9O1xuXG4gICAgbGlzdChzZXJpYWw/OiBzdHJpbmcpOiBzdHJpbmdbXSB7XG4gICAgICAgIGxldCBzZXJpYWxzOiBzdHJpbmdbXSA9IFtdO1xuICAgICAgICBpZiAoc2VyaWFsKSB7XG5cbiAgICAgICAgICAgIF8ubWFwKHRoaXMuYWxsLCBmdW5jdGlvbihjbGllbnQpIHtcbiAgICAgICAgICAgICAgICBpZiAoY2xpZW50LnNlcmlhbCA9PT0gc2VyaWFsKSB7XG4gICAgICAgICAgICAgICAgICAgIHNlcmlhbHMucHVzaChjbGllbnQuc2VyaWFsKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9KTtcblxuICAgICAgICB9IGVsc2Uge1xuXG4gICAgICAgICAgICBfLm1hcCh0aGlzLmFsbCwgZnVuY3Rpb24oY2xpZW50KSB7XG4gICAgICAgICAgICAgICAgc2VyaWFscy5wdXNoKGNsaWVudC5zZXJpYWwpO1xuICAgICAgICAgICAgfSk7XG5cbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiBzZXJpYWxzO1xuXG4gICAgfTtcbiAgICBpb3Moc2VyaWFsPzogc3RyaW5nKTogSVNvY2tldFtdIHtcbiAgICAgICAgbGV0IHNvY2tldHM6IElTb2NrZXRbXSA9IFtdO1xuXG4gICAgICAgIGlmIChzZXJpYWwpIHtcbiAgICAgICAgICAgIF8ubWFwKHRoaXMuYWxsLCBmdW5jdGlvbihjbGllbnQpIHtcbiAgICAgICAgICAgICAgICBpZiAoY2xpZW50LnNlcmlhbCA9PT0gc2VyaWFsKSB7XG5cbiAgICAgICAgICAgICAgICAgICAgXy5tYXAoY2xpZW50LnNvY2tldHMsIGZ1bmN0aW9uKHMpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHNvY2tldHMucHVzaChzLnNvY2tldCk7XG4gICAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0pO1xuXG4gICAgICAgIH0gZWxzZSB7XG5cblxuICAgICAgICAgICAgXy5tYXAodGhpcy5hbGwsIGZ1bmN0aW9uKGNsaWVudCkge1xuICAgICAgICAgICAgICAgIF8ubWFwKGNsaWVudC5zb2NrZXRzLCBmdW5jdGlvbihzKSB7XG5cbiAgICAgICAgICAgICAgICAgICAgc29ja2V0cy5wdXNoKHMuc29ja2V0KTtcblxuXG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICB9KTtcblxuXG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIHNvY2tldHM7XG4gICAgfTtcbiAgICBzb2NrZXRzKHNlcmlhbD86IHN0cmluZykge1xuICAgICAgICBsZXQgaWRzO1xuICAgICAgICBpZiAoc2VyaWFsKSB7XG4gICAgICAgICAgICBfLm1hcCh0aGlzLmFsbCwgZnVuY3Rpb24oY2xpZW50KSB7XG4gICAgICAgICAgICAgICAgaWYgKGNsaWVudC5zZXJpYWwgPT09IHNlcmlhbCkge1xuICAgICAgICAgICAgICAgICAgICBpZHMgPSBfLnBsdWNrKGNsaWVudC5zb2NrZXRzLCBcImlkXCIpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgcmV0dXJuIGlkcztcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIGlkcyA9IFtdO1xuXG4gICAgICAgICAgICBfLm1hcCh0aGlzLmFsbCwgZnVuY3Rpb24oY2xpZW50KSB7XG4gICAgICAgICAgICAgICAgXy5tYXAoY2xpZW50LnNvY2tldHMsIGZ1bmN0aW9uKHMpIHtcbiAgICAgICAgICAgICAgICAgICAgaWRzLnB1c2gocy5pZCk7XG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICB9KTtcblxuICAgICAgICAgICAgcmV0dXJuIGlkcztcbiAgICAgICAgfVxuXG4gICAgfTtcblxuXG5cblxufTtcbiJdLCJzb3VyY2VSb290IjoiL3NvdXJjZS8ifQ==
