var _ = require("lodash");
var Promise = require("bluebird");
var rpj = require('request-promise-json');
function mconnection(user, password, db, serial, bool) {
    return new Promise(function (resolve, reject) {
        rpj.get(db + '/connection_' + serial).then(function (doc) {
            doc.connected = bool;
            doc.updatedAt = new Date().getTime();
            rpj.put(db + '/connection_' + serial, doc).then(function (d) {
                resolve(true);
            }).catch(function (err) {
                console.log(err);
                reject(err);
            });
        }).catch(function (err) {
            console.log(err);
            if (bool == true && err.statusCode == 404) {
                var doc = {
                    _id: 'connection_' + serial,
                    connected: true,
                    updatedAt: new Date().getTime()
                };
                rpj.post(db, doc).then(function (doc) {
                    resolve(true);
                }).catch(function (err) {
                    reject({ error: 'wrong credentials' });
                });
            }
            else {
                console.log(err);
                reject(err);
            }
        });
    });
}
function pushtodb(user, password, db, serial, doc) {
    return new Promise(function (resolve, reject) {
        rpj.get(db + '/' + doc._id).then(function (d) {
            doc._rev = d._rev;
            rpj.put(db + '/' + doc._id, doc).then(function () {
                resolve(doc);
            }).catch(function (err) {
                reject(err);
            });
        }).catch(function (err) {
            if (err.statusCode == 404) {
                rpj.post(db + '/', doc).then(function () {
                    resolve(doc);
                }).catch(function (err) {
                    reject(err);
                });
            }
            else {
                console.log(err);
                reject(err);
            }
        });
    });
}
function exists(all, serial, sid) {
    var serialexists = false;
    var socketexists = false;
    _.map(all, function (client) {
        if (client.serial) {
            serialexists = true;
            _.map(client.sockets, function (s) {
                if (s.id == sid) {
                    socketexists = true;
                }
            });
        }
    });
    return { serial: serialexists, socket: socketexists };
}
module.exports = (function () {
    function MaClients(db) {
        this.couchdb = db;
    }
    MaClients.prototype.add = function (user, password, db, serial, socket) {
        var exist = exists(this.all, serial, socket.id);
        if (!exist.serial) {
            this.all.push({
                serial: serial,
                user: user,
                password: password,
                db: this.couchdb.protocol + '://' + user + ':' + password + '@' + this.couchdb.host + '/' + db,
                sockets: [{ id: socket.id, socket: socket }]
            });
            return mconnection(user, password, this.couchdb.protocol + '://' + user + ':' + password + '@' + this.couchdb.host + '/' + db, serial, true);
        }
        else if (!exist.socket) {
            _.map(this.all, function (client) {
                if (client.serial) {
                    client.sockets.push({ id: socket.id, socket: socket });
                }
            });
            console.log('new socket for ' + serial);
        }
    };
    ;
    MaClients.prototype.pushdata = function (serial, type, data) {
        return new Promise(function (resolve, reject) {
            reject('todo');
        });
    };
    ;
    MaClients.prototype.remove = function (serial, sid) {
        var remaning;
        for (var soc = 0; soc < this.all.length; soc++) {
            var client = this.all[soc];
            if (client.serial == serial) {
                if (client.sockets.length == 1 && client.sockets[0].id == sid) {
                    mconnection(client.user, client.password, client.db, client.serial, false).then(function () {
                        console.log('switched offline');
                    }).catch(function (err) {
                        console.log('switched offline error');
                        console.log(err);
                    });
                    _.map(this.all, function (el) {
                        if (el.serial != client.serial) {
                            remaning.push(el);
                        }
                    });
                    this.all = remaning;
                }
                else {
                    console.log('todo');
                }
            }
        }
    };
    ;
    MaClients.prototype.list = function (serial) {
        var serials;
        if (serial) {
            _.map(this.all, function (client) {
                if (client.serial == serial) {
                    serials.push(client.serial);
                }
            });
        }
        else {
            _.map(this.all, function (client) {
                serials.push(client.serial);
            });
        }
        return serials;
    };
    ;
    MaClients.prototype.ios = function (serial) {
        var sockets;
        if (serial) {
            _.map(this.all, function (client) {
                if (client.serial == serial) {
                    _.map(client.sockets, function (s) {
                        sockets.push(s.socket);
                    });
                }
            });
        }
        else {
            _.map(this.all, function (client) {
                _.map(client.sockets, function (s) {
                    sockets.push(s.socket);
                });
            });
        }
        return sockets;
    };
    ;
    MaClients.prototype.sockets = function (serial) {
        var ids;
        if (serial) {
            _.map(this.all, function (client) {
                if (client.serial == serial) {
                    ids = _.pluck(client.sockets, "id");
                }
            });
            return ids;
        }
        else {
            ids = [];
            _.map(this.all, function (client) {
                _.map(client.sockets, function (s) {
                    ids.push(s.id);
                });
            });
            return ids;
        }
    };
    ;
    return MaClients;
})();

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIm1vZHVsZXMvbWFjaENsaWVudHMudHMiXSwibmFtZXMiOlsibWNvbm5lY3Rpb24iLCJwdXNodG9kYiIsImV4aXN0cyIsImNvbnN0cnVjdG9yIiwiYWRkIiwicHVzaGRhdGEiLCJyZW1vdmUiLCJsaXN0IiwiaW9zIiwic29ja2V0cyJdLCJtYXBwaW5ncyI6IkFBQUEsSUFBWSxDQUFDLFdBQU0sUUFBUSxDQUFDLENBQUE7QUFDNUIsSUFBWSxPQUFPLFdBQU0sVUFBVSxDQUFDLENBQUE7QUFDcEMsSUFBSSxHQUFHLEdBQUcsT0FBTyxDQUFDLHNCQUFzQixDQUFDLENBQUM7QUFFMUMscUJBQXFCLElBQVksRUFBRSxRQUFnQixFQUFFLEVBQVUsRUFBRSxNQUFjLEVBQUUsSUFBYztJQUMzRkEsTUFBTUEsQ0FBQ0EsSUFBSUEsT0FBT0EsQ0FBQ0EsVUFBU0EsT0FBT0EsRUFBRUEsTUFBTUE7UUFDdkMsR0FBRyxDQUFDLEdBQUcsQ0FBQyxFQUFFLEdBQUcsY0FBYyxHQUFHLE1BQU0sQ0FBQyxDQUFDLElBQUksQ0FBQyxVQUFTLEdBQUc7WUFDbkQsR0FBRyxDQUFDLFNBQVMsR0FBRyxJQUFJLENBQUM7WUFDckIsR0FBRyxDQUFDLFNBQVMsR0FBRyxJQUFJLElBQUksRUFBRSxDQUFDLE9BQU8sRUFBRSxDQUFBO1lBQ3BDLEdBQUcsQ0FBQyxHQUFHLENBQUMsRUFBRSxHQUFHLGNBQWMsR0FBRyxNQUFNLEVBQUUsR0FBRyxDQUFDLENBQUMsSUFBSSxDQUFDLFVBQVMsQ0FBQztnQkFDdEQsT0FBTyxDQUFDLElBQUksQ0FBQyxDQUFBO1lBQ2pCLENBQUMsQ0FBQyxDQUFDLEtBQUssQ0FBQyxVQUFTLEdBQUc7Z0JBQ2pCLE9BQU8sQ0FBQyxHQUFHLENBQUMsR0FBRyxDQUFDLENBQUE7Z0JBQ2hCLE1BQU0sQ0FBQyxHQUFHLENBQUMsQ0FBQTtZQUNmLENBQUMsQ0FBQyxDQUFBO1FBQ04sQ0FBQyxDQUFDLENBQUMsS0FBSyxDQUFDLFVBQVMsR0FBRztZQUNqQixPQUFPLENBQUMs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QSxDQUFDQSxHQUFHQSxFQUFFQSxVQUFTQSxNQUFNQTtnQkFDM0IsRUFBRSxDQUFDLENBQUMsTUFBTSxDQUFDLE1BQU0sSUFBSSxNQUFNLENBQUMsQ0FBQyxDQUFDO29CQUMxQixHQUFHLEdBQUcsQ0FBQyxDQUFDLEtBQUssQ0FBQyxNQUFNLENBQUMsT0FBTyxFQUFFLElBQUksQ0FBQyxDQUFBO2dCQUN2QyxDQUFDO1lBQ0wsQ0FBQyxDQUFDQSxDQUFBQTtZQUNGQSxNQUFNQSxDQUFDQSxHQUFHQSxDQUFBQTtRQUNkQSxDQUFDQTtRQUFDQSxJQUFJQSxDQUFDQSxDQUFDQTtZQUNKQSxHQUFHQSxHQUFHQSxFQUFFQSxDQUFDQTtZQUVUQSxDQUFDQSxDQUFDQSxHQUFHQSxDQUFDQSxJQUFJQSxDQUFDQSxHQUFHQSxFQUFFQSxVQUFTQSxNQUFNQTtnQkFDM0IsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxNQUFNLENBQUMsT0FBTyxFQUFFLFVBQVMsQ0FBQztvQkFDNUIsR0FBRyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUE7Z0JBQ2xCLENBQUMsQ0FBQyxDQUFBO1lBQ04sQ0FBQyxDQUFDQSxDQUFBQTtZQUVGQSxNQUFNQSxDQUFDQSxHQUFHQSxDQUFBQTtRQUNkQSxDQUFDQTtJQUVMQSxDQUFDQTs7SUFLTCxnQkFBQztBQUFELENBbEtRLEFBa0tQLEdBQUEsQ0FBQyIsImZpbGUiOiJtb2R1bGVzL21hY2hDbGllbnRzLmpzIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0ICogYXMgXyBmcm9tIFwibG9kYXNoXCI7XG5pbXBvcnQgKiBhcyBQcm9taXNlIGZyb20gXCJibHVlYmlyZFwiO1xubGV0IHJwaiA9IHJlcXVpcmUoJ3JlcXVlc3QtcHJvbWlzZS1qc29uJyk7XG5cbmZ1bmN0aW9uIG1jb25uZWN0aW9uKHVzZXI6IHN0cmluZywgcGFzc3dvcmQ6IHN0cmluZywgZGI6IHN0cmluZywgc2VyaWFsOiBzdHJpbmcsIGJvb2w/OiBib29sZWFuKSB7XG4gICAgcmV0dXJuIG5ldyBQcm9taXNlKGZ1bmN0aW9uKHJlc29sdmUsIHJlamVjdCkge1xuICAgICAgICBycGouZ2V0KGRiICsgJy9jb25uZWN0aW9uXycgKyBzZXJpYWwpLnRoZW4oZnVuY3Rpb24oZG9jKSB7XG4gICAgICAgICAgICBkb2MuY29ubmVjdGVkID0gYm9vbDtcbiAgICAgICAgICAgIGRvYy51cGRhdGVkQXQgPSBuZXcgRGF0ZSgpLmdldFRpbWUoKVxuICAgICAgICAgICAgcnBqLnB1dChkYiArICcvY29ubmVjdGlvbl8nICsgc2VyaWFsLCBkb2MpLnRoZW4oZnVuY3Rpb24oZCkge1xuICAgICAgICAgICAgICAgIHJlc29sdmUodHJ1ZSlcbiAgICAgICAgICAgIH0pLmNhdGNoKGZ1bmN0aW9uKGVycikge1xuICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKGVycilcbiAgICAgICAgICAgICAgICByZWplY3QoZXJyKVxuICAgICAgICAgICAgfSlcbiAgICAgICAgfSkuY2F0Y2goZnVuY3Rpb24oZXJyKSB7XG4gICAgICAgICAgICBjb25zb2xlLmxvZyhlcnIpXG5cbiAgICAgICAgICAgIGlmIChib29sID09IHRydWUgJiYgZXJyLnN0YXR1c0NvZGUgPT0gNDA0KSB7ICAvLyBpZiBkb2Nub3QgZXhpdCBlIGJvb2wgdHJ1ZSBibGEgYmxhIGJsYVxuXG4gICAgICAgICAgICAgICAgbGV0IGRvYyA9IHtcbiAgICAgICAgICAgICAgICAgICAgX2lkOiAnY29ubmVjdGlvbl8nICsgc2VyaWFsLFxuICAgICAgICAgICAgICAgICAgICBjb25uZWN0ZWQ6IHRydWUsXG4gICAgICAgICAgICAgICAgICAgIHVwZGF0ZWRBdDogbmV3IERhdGUoKS5nZXRUaW1lKClcbiAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICBycGoucG9zdChkYiwgZG9jKS50aGVuKGZ1bmN0aW9uKGRvYykge1xuICAgICAgICAgICAgICAgICAgICByZXNvbHZlKHRydWUpO1xuICAgICAgICAgICAgICAgIH0pLmNhdGNoKGZ1bmN0aW9uKGVycikge1xuICAgICAgICAgICAgICAgICAgICByZWplY3QoeyBlcnJvcjogJ3dyb25nIGNyZWRlbnRpYWxzJyB9KVxuICAgICAgICAgICAgICAgIH0pXG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKGVycilcbiAgICAgICAgICAgICAgICByZWplY3QoZXJyKVxuICAgICAgICAgICAgfVxuICAgICAgICB9KVxuICAgIH0pO1xufVxuXG5cbmZ1bmN0aW9uIHB1c2h0b2RiKHVzZXI6IHN0cmluZywgcGFzc3dvcmQ6IHN0cmluZywgZGI6IHN0cmluZywgc2VyaWFsOiBzdHJpbmcsIGRvYzogeyBfaWQ6IHN0cmluZywgX3Jldj86IHN0cmluZyB9KSB7XG4gICAgcmV0dXJuIG5ldyBQcm9taXNlKGZ1bmN0aW9uKHJlc29sdmUsIHJlamVjdCkge1xuICAgICAgICBycGouZ2V0KGRiICsgJy8nICsgZG9jLl9pZCkudGhlbihmdW5jdGlvbihkKSB7XG4gICAgICAgICAgICBkb2MuX3JldiA9IGQuX3JldlxuICAgICAgICAgICAgcnBqLnB1dChkYiArICcvJyArIGRvYy5faWQsIGRvYykudGhlbihmdW5jdGlvbigpIHtcbiAgICAgICAgICAgICAgICByZXNvbHZlKGRvYylcbiAgICAgICAgICAgIH0pLmNhdGNoKGZ1bmN0aW9uKGVycikge1xuICAgICAgICAgICAgICAgIHJlamVjdChlcnIpXG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfSkuY2F0Y2goZnVuY3Rpb24oZXJyKSB7XG4gICAgICAgICAgICBpZiAoZXJyLnN0YXR1c0NvZGUgPT0gNDA0KSB7XG4gICAgICAgICAgICAgICAgcnBqLnBvc3QoZGIgKyAnLycsIGRvYykudGhlbihmdW5jdGlvbigpIHtcbiAgICAgICAgICAgICAgICAgICAgcmVzb2x2ZShkb2MpXG4gICAgICAgICAgICAgICAgfSkuY2F0Y2goZnVuY3Rpb24oZXJyKSB7XG4gICAgICAgICAgICAgICAgICAgIHJlamVjdChlcnIpXG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKGVycilcbiAgICAgICAgICAgICAgICByZWplY3QoZXJyKVxuICAgICAgICAgICAgfVxuICAgICAgICB9KTtcbiAgICB9KTtcblxufVxuXG5mdW5jdGlvbiBleGlzdHMoYWxsOiBbSUNsaWVudF0sIHNlcmlhbCwgc2lkKTogeyBzZXJpYWw6IGJvb2xlYW4sIHNvY2tldDogYm9vbGVhbiB9IHtcbiAgICBsZXQgc2VyaWFsZXhpc3RzID0gZmFsc2VcbiAgICBsZXQgc29ja2V0ZXhpc3RzID0gZmFsc2VcblxuICAgIF8ubWFwKGFsbCwgZnVuY3Rpb24oY2xpZW50KSB7XG4gICAgICAgIGlmIChjbGllbnQuc2VyaWFsKSB7XG4gICAgICAgICAgICBzZXJpYWxleGlzdHMgPSB0cnVlXG5cbiAgICAgICAgICAgIF8ubWFwKGNsaWVudC5zb2NrZXRzLCBmdW5jdGlvbihzKSB7XG4gICAgICAgICAgICAgICAgaWYgKHMuaWQgPT0gc2lkKSB7XG4gICAgICAgICAgICAgICAgICAgIHNvY2tldGV4aXN0cyA9IHRydWVcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9KVxuICAgICAgICB9XG4gICAgfSlcbiAgICByZXR1cm4geyBzZXJpYWw6IHNlcmlhbGV4aXN0cywgc29ja2V0OiBzb2NrZXRleGlzdHMgfVxufVxuXG5cbmludGVyZmFjZSBJU29ja2V0QXJyYXkge1xuXG4gICAgaWQ6IHN0cmluZztcbiAgICBzb2NrZXQ6IElTb2NrZXRcbn1cblxuaW50ZXJmYWNlIElTb2NrZXQge1xuXG4gICAgICAgIGlkOiBzdHJpbmc7XG4gICAgICAgIGVtaXQ6RnVuY3Rpb247XG4gICAgXG59XG5cbmludGVyZmFjZSBJQ2xpZW50IHtcbiAgICBzZXJpYWw6IHN0cmluZztcbiAgICBzb2NrZXRzOiBbSVNvY2tldEFycmF5XTtcbiAgICB1c2VyOiBzdHJpbmc7XG4gICAgcGFzc3dvcmQ6IHN0cmluZztcbiAgICBkYjogc3RyaW5nO1xufVxuXG5cbmludGVyZmFjZSBJQ291Y2hkYiB7XG4gICAgcHJvdG9jb2w6IHN0cmluZztcbiAgICBwb3J0OiBudW1iZXI7XG4gICAgaG9zdDogc3RyaW5nO1xufVxuXG5cbmV4cG9ydCA9Y2xhc3MgTWFDbGllbnRzIHtcbiAgICBhbGw6IFtJQ2xpZW50XTtcbiAgICBjb3VjaGRiOiBJQ291Y2hkYjtcblxuICAgIGNvbnN0cnVjdG9yKGRiOiBJQ291Y2hkYikge1xuICAgICAgICB0aGlzLmNvdWNoZGIgPSBkYlxuICAgIH1cblxuICAgIGFkZCh1c2VyOiBzdHJpbmcsIHBhc3N3b3JkOiBzdHJpbmcsIGRiOiBzdHJpbmcsIHNlcmlhbDogc3RyaW5nLCBzb2NrZXQ6IElTb2NrZXQpIHtcblxuICAgICAgICBsZXQgZXhpc3QgPSBleGlzdHModGhpcy5hbGwsIHNlcmlhbCwgc29ja2V0LmlkKVxuICAgICAgICBpZiAoIWV4aXN0LnNlcmlhbCkge1xuXG4gICAgICAgICAgICB0aGlzLmFsbC5wdXNoKHtcbiAgICAgICAgICAgICAgICBzZXJpYWw6IHNlcmlhbCxcbiAgICAgICAgICAgICAgICB1c2VyOiB1c2VyLFxuICAgICAgICAgICAgICAgIHBhc3N3b3JkOiBwYXNzd29yZCxcbiAgICAgICAgICAgICAgICBkYjogdGhpcy5jb3VjaGRiLnByb3RvY29sICsgJzovLycgKyB1c2VyICsgJzonICsgcGFzc3dvcmQgKyAnQCcgKyB0aGlzLmNvdWNoZGIuaG9zdCArICcvJyArIGRiLFxuICAgICAgICAgICAgICAgIHNvY2tldHM6IFt7IGlkOiBzb2NrZXQuaWQsIHNvY2tldDogc29ja2V0IH1dXG4gICAgICAgICAgICB9KVxuXG4gICAgICAgICAgICByZXR1cm4gbWNvbm5lY3Rpb24odXNlciwgcGFzc3dvcmQsIHRoaXMuY291Y2hkYi5wcm90b2NvbCArICc6Ly8nICsgdXNlciArICc6JyArIHBhc3N3b3JkICsgJ0AnICsgdGhpcy5jb3VjaGRiLmhvc3QgKyAnLycgKyBkYiwgc2VyaWFsLCB0cnVlKVxuXG4gICAgICAgIH0gZWxzZSBpZiAoIWV4aXN0LnNvY2tldCkge1xuICAgICAgICAgICAgXy5tYXAodGhpcy5hbGwsIGZ1bmN0aW9uKGNsaWVudCkge1xuICAgICAgICAgICAgICAgIGlmIChjbGllbnQuc2VyaWFsKSB7XG4gICAgICAgICAgICAgICAgICAgIGNsaWVudC5zb2NrZXRzLnB1c2goeyBpZDogc29ja2V0LmlkLCBzb2NrZXQ6IHNvY2tldCB9KVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0pXG4gICAgICAgICAgICBjb25zb2xlLmxvZygnbmV3IHNvY2tldCBmb3IgJyArIHNlcmlhbClcbiAgICAgICAgfVxuXG5cbiAgICB9O1xuICAgIHB1c2hkYXRhKHNlcmlhbDpzdHJpbmcsdHlwZTpzdHJpbmcsZGF0YTphbnkpIHtcbiAgICBcbiAgICByZXR1cm4gbmV3IFByb21pc2UoZnVuY3Rpb24ocmVzb2x2ZSwgcmVqZWN0KSB7XG4gICAgICAgIFxuICAgICAgICByZWplY3QoJ3RvZG8nKVxuICAgICAgICBcbiAgICAgICAgICAgICAgICAgICB9KSBcbiAgICAgICAgXG4gICAgICAgIFxufTtcbiAgICByZW1vdmUoc2VyaWFsOiBzdHJpbmcsIHNpZDogc3RyaW5nKSB7XG5cbiAgICAgICAgbGV0IHJlbWFuaW5nOiBbSUNsaWVudF07XG5cbiAgICAgICAgZm9yIChsZXQgc29jID0gMDsgc29jIDwgdGhpcy5hbGwubGVuZ3RoOyBzb2MrKykge1xuXG4gICAgICAgICAgICB2YXIgY2xpZW50ID0gdGhpcy5hbGxbc29jXTtcblxuXG5cbiAgICAgICAgICAgIGlmIChjbGllbnQuc2VyaWFsID09IHNlcmlhbCkge1xuXG4gICAgICAgICAgICAgICAgaWYgKGNsaWVudC5zb2NrZXRzLmxlbmd0aCA9PSAxICYmIGNsaWVudC5zb2NrZXRzWzBdLmlkID09IHNpZCkge1xuICAgICAgICAgICAgICAgICAgICBtY29ubmVjdGlvbihjbGllbnQudXNlciwgY2xpZW50LnBhc3N3b3JkLCBjbGllbnQuZGIsIGNsaWVudC5zZXJpYWwsIGZhbHNlKS50aGVuKGZ1bmN0aW9uKCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coJ3N3aXRjaGVkIG9mZmxpbmUnKVxuICAgICAgICAgICAgICAgICAgICB9KS5jYXRjaChmdW5jdGlvbihlcnIpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKCdzd2l0Y2hlZCBvZmZsaW5lIGVycm9yJylcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKGVycilcbiAgICAgICAgICAgICAgICAgICAgfSlcblxuICAgICAgICAgICAgICAgICAgICBfLm1hcCh0aGlzLmFsbCwgZnVuY3Rpb24oZWwpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChlbC5zZXJpYWwgIT0gY2xpZW50LnNlcmlhbCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlbWFuaW5nLnB1c2goZWwpXG4gICAgICAgICAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICAgICAgfSlcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5hbGwgPSByZW1hbmluZztcblxuXG5cbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZygndG9kbycpXG4gICAgICAgICAgICAgICAgICAgIC8vIHRoaXMuYWxsPV8ucmVqZWN0KHRoaXMuYWxsLCBmdW5jdGlvbihlbCkge1xuICAgICAgICAgICAgICAgICAgICAvLyAgIHJldHVybiBlbC5zZXJpYWwgPT09IGNsaWVudC5zZXJpYWw7XG4gICAgICAgICAgICAgICAgICAgIC8vIH0pXG5cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICB9O1xuXG4gICAgbGlzdChzZXJpYWw/OiBzdHJpbmcpOiBbc3RyaW5nXSB7XG4gICAgICAgIGxldCBzZXJpYWxzOiBbc3RyaW5nXTtcbiAgICAgICAgaWYgKHNlcmlhbCkge1xuXG4gICAgICAgICAgICBfLm1hcCh0aGlzLmFsbCwgZnVuY3Rpb24oY2xpZW50KSB7XG4gICAgICAgICAgICAgICAgaWYgKGNsaWVudC5zZXJpYWwgPT0gc2VyaWFsKSB7XG4gICAgICAgICAgICAgICAgICAgIHNlcmlhbHMucHVzaChjbGllbnQuc2VyaWFsKVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0pXG5cbiAgICAgICAgfSBlbHNlIHtcblxuICAgICAgICAgICAgXy5tYXAodGhpcy5hbGwsIGZ1bmN0aW9uKGNsaWVudCkge1xuICAgICAgICAgICAgICAgIHNlcmlhbHMucHVzaChjbGllbnQuc2VyaWFsKVxuICAgICAgICAgICAgfSlcblxuXG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gc2VyaWFsc1xuXG4gICAgfTtcbiAgICBpb3Moc2VyaWFsPzogc3RyaW5nKTogW0lTb2NrZXRdIHtcbiAgICAgICAgbGV0IHNvY2tldHM6IFtJU29ja2V0XTtcblxuICAgICAgICBpZiAoc2VyaWFsKSB7XG4gICAgICAgICAgICBfLm1hcCh0aGlzLmFsbCwgZnVuY3Rpb24oY2xpZW50KSB7XG4gICAgICAgICAgICAgICAgaWYgKGNsaWVudC5zZXJpYWwgPT0gc2VyaWFsKSB7XG5cbiAgICAgICAgICAgICAgICAgICAgXy5tYXAoY2xpZW50LnNvY2tldHMsIGZ1bmN0aW9uKHMpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHNvY2tldHMucHVzaChzLnNvY2tldClcbiAgICAgICAgICAgICAgICAgICAgfSlcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9KVxuXG4gICAgICAgIH0gZWxzZSB7XG5cblxuICAgICAgICAgICAgXy5tYXAodGhpcy5hbGwsIGZ1bmN0aW9uKGNsaWVudCkge1xuICAgICAgICAgICAgICAgIF8ubWFwKGNsaWVudC5zb2NrZXRzLCBmdW5jdGlvbihzKSB7XG5cbiAgICAgICAgICAgICAgICAgICAgc29ja2V0cy5wdXNoKHMuc29ja2V0KVxuXG5cbiAgICAgICAgICAgICAgICB9KVxuICAgICAgICAgICAgfSlcblxuXG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIHNvY2tldHNcbiAgICB9O1xuICAgIHNvY2tldHMoc2VyaWFsPzogc3RyaW5nKSB7XG4gICAgICAgIGxldCBpZHM7XG4gICAgICAgIGlmIChzZXJpYWwpIHtcbiAgICAgICAgICAgIF8ubWFwKHRoaXMuYWxsLCBmdW5jdGlvbihjbGllbnQpIHtcbiAgICAgICAgICAgICAgICBpZiAoY2xpZW50LnNlcmlhbCA9PSBzZXJpYWwpIHtcbiAgICAgICAgICAgICAgICAgICAgaWRzID0gXy5wbHVjayhjbGllbnQuc29ja2V0cywgXCJpZFwiKVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0pXG4gICAgICAgICAgICByZXR1cm4gaWRzXG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBpZHMgPSBbXTtcblxuICAgICAgICAgICAgXy5tYXAodGhpcy5hbGwsIGZ1bmN0aW9uKGNsaWVudCkge1xuICAgICAgICAgICAgICAgIF8ubWFwKGNsaWVudC5zb2NrZXRzLCBmdW5jdGlvbihzKSB7XG4gICAgICAgICAgICAgICAgICAgIGlkcy5wdXNoKHMuaWQpXG4gICAgICAgICAgICAgICAgfSlcbiAgICAgICAgICAgIH0pXG5cbiAgICAgICAgICAgIHJldHVybiBpZHNcbiAgICAgICAgfVxuXG4gICAgfTtcbiAgICBcbiAgICBcbiAgICBcbiAgICBcbn07XG4iXSwic291cmNlUm9vdCI6Ii9zb3VyY2UvIn0=
