var _ = require("lodash");
var Promise = require("bluebird");
var rpj = require('request-promise-json');
function mconnection(user, password, db, serial, bool) {
    return new Promise(function (resolve, reject) {
        rpj.get(db + '/connection_' + serial).then(function (doc) {
            doc.connected = bool;
            doc.updatedAt = new Date().getTime();
            rpj.put(db + '/connection_' + serial, doc).then(function (d) {
                resolve(true);
            }).catch(function (err) {
                console.log(err);
                reject(err);
            });
        }).catch(function (err) {
            console.log(err);
            if (bool == true && err.statusCode == 404) {
                var doc = {
                    _id: 'connection_' + serial,
                    connected: true,
                    updatedAt: new Date().getTime()
                };
                rpj.post(db, doc).then(function (doc) {
                    resolve(true);
                }).catch(function (err) {
                    reject({ error: 'wrong credentials' });
                });
            }
            else {
                console.log(err);
                reject(err);
            }
        });
    });
}
function pushtodb(user, password, db, serial, doc) {
    return new Promise(function (resolve, reject) {
        rpj.get(db + '/' + doc._id).then(function (d) {
            doc._rev = d._rev;
            rpj.put(db + '/' + doc._id, doc).then(function () {
                resolve(doc);
            }).catch(function (err) {
                reject(err);
            });
        }).catch(function (err) {
            if (err.statusCode == 404) {
                rpj.post(db + '/', doc).then(function () {
                    resolve(doc);
                }).catch(function (err) {
                    reject(err);
                });
            }
            else {
                console.log(err);
                reject(err);
            }
        });
    });
}
function exists(all, serial, sid) {
    var serialexists = false;
    var socketexists = false;
    _.map(all, function (client) {
        if (client.serial) {
            serialexists = true;
            _.map(client.sockets, function (s) {
                if (s.id == sid) {
                    socketexists = true;
                }
            });
        }
    });
    return { serial: serialexists, socket: socketexists };
}
module.exports = (function () {
    function MaClients(db) {
        this.couchdb = db;
        this.all = [];
    }
    MaClients.prototype.add = function (user, password, db, serial, socket) {
        var exist = exists(this.all, serial, socket.id);
        if (!exist.serial) {
            this.all.push({
                serial: serial,
                user: user,
                password: password,
                db: this.couchdb.protocol + '://' + user + ':' + password + '@' + this.couchdb.host + '/' + db,
                sockets: [{ id: socket.id, socket: socket }]
            });
            return mconnection(user, password, this.couchdb.protocol + '://' + user + ':' + password + '@' + this.couchdb.host + '/' + db, serial, true);
        }
        else if (!exist.socket) {
            _.map(this.all, function (client) {
                if (client.serial) {
                    client.sockets.push({ id: socket.id, socket: socket });
                }
            });
            console.log('new socket for ' + serial);
        }
    };
    ;
    MaClients.prototype.pushdata = function (serial, type, data) {
        return new Promise(function (resolve, reject) {
            reject('todo');
        });
    };
    ;
    MaClients.prototype.remove = function (serial, sid) {
        var remaning = [];
        for (var soc = 0; soc < this.all.length; soc++) {
            var client = this.all[soc];
            if (client.serial == serial) {
                if (client.sockets.length == 1 && client.sockets[0].id == sid) {
                    mconnection(client.user, client.password, client.db, client.serial, false).then(function () {
                        console.log('switched offline');
                    }).catch(function (err) {
                        console.log('switched offline error');
                        console.log(err);
                    });
                    _.map(this.all, function (el) {
                        if (el.serial != client.serial) {
                            remaning.push(el);
                        }
                    });
                    this.all = remaning;
                }
                else {
                    console.log('todo');
                }
            }
        }
    };
    ;
    MaClients.prototype.list = function (serial) {
        var serials = [];
        if (serial) {
            _.map(this.all, function (client) {
                if (client.serial == serial) {
                    serials.push(client.serial);
                }
            });
        }
        else {
            _.map(this.all, function (client) {
                serials.push(client.serial);
            });
        }
        return serials;
    };
    ;
    MaClients.prototype.ios = function (serial) {
        var sockets;
        if (serial) {
            _.map(this.all, function (client) {
                if (client.serial == serial) {
                    _.map(client.sockets, function (s) {
                        sockets.push(s.socket);
                    });
                }
            });
        }
        else {
            _.map(this.all, function (client) {
                _.map(client.sockets, function (s) {
                    sockets.push(s.socket);
                });
            });
        }
        return sockets;
    };
    ;
    MaClients.prototype.sockets = function (serial) {
        var ids;
        if (serial) {
            _.map(this.all, function (client) {
                if (client.serial == serial) {
                    ids = _.pluck(client.sockets, "id");
                }
            });
            return ids;
        }
        else {
            ids = [];
            _.map(this.all, function (client) {
                _.map(client.sockets, function (s) {
                    ids.push(s.id);
                });
            });
            return ids;
        }
    };
    ;
    return MaClients;
})();

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIm1vZHVsZXMvbWFjaENsaWVudHMudHMiXSwibmFtZXMiOlsibWNvbm5lY3Rpb24iLCJwdXNodG9kYiIsImV4aXN0cyIsImNvbnN0cnVjdG9yIiwiYWRkIiwicHVzaGRhdGEiLCJyZW1vdmUiLCJsaXN0IiwiaW9zIiwic29ja2V0cyJdLCJtYXBwaW5ncyI6IkFBQUEsSUFBWSxDQUFDLFdBQU0sUUFBUSxDQUFDLENBQUE7QUFDNUIsSUFBWSxPQUFPLFdBQU0sVUFBVSxDQUFDLENBQUE7QUFDcEMsSUFBSSxHQUFHLEdBQUcsT0FBTyxDQUFDLHNCQUFzQixDQUFDLENBQUM7QUFFMUMscUJBQXFCLElBQVksRUFBRSxRQUFnQixFQUFFLEVBQVUsRUFBRSxNQUFjLEVBQUUsSUFBYztJQUMzRkEsTUFBTUEsQ0FBQ0EsSUFBSUEsT0FBT0EsQ0FBQ0EsVUFBU0EsT0FBT0EsRUFBRUEsTUFBTUE7UUFDdkMsR0FBRyxDQUFDLEdBQUcsQ0FBQyxFQUFFLEdBQUcsY0FBYyxHQUFHLE1BQU0sQ0FBQyxDQUFDLElBQUksQ0FBQyxVQUFTLEdBQUc7WUFDbkQsR0FBRyxDQUFDLFNBQVMsR0FBRyxJQUFJLENBQUM7WUFDckIsR0FBRyxDQUFDLFNBQVMsR0FBRyxJQUFJLElBQUksRUFBRSxDQUFDLE9BQU8sRUFBRSxDQUFBO1lBQ3BDLEdBQUcsQ0FBQyxHQUFHLENBQUMsRUFBRSxHQUFHLGNBQWMsR0FBRyxNQUFNLEVBQUUsR0FBRyxDQUFDLENBQUMsSUFBSSxDQUFDLFVBQVMsQ0FBQztnQkFDdEQsT0FBTyxDQUFDLElBQUksQ0FBQyxDQUFBO1lBQ2pCLENBQUMsQ0FBQyxDQUFDLEtBQUssQ0FBQyxVQUFTLEdBQUc7Z0JBQ2pCLE9BQU8sQ0FBQyxHQUFHLENBQUMsR0FBRyxDQUFDLENBQUE7Z0JBQ2hCLE1BQU0sQ0FBQyxHQUFHLENBQUMsQ0FBQTtZQUNmLENBQUMsQ0FBQyxDQUFBO1FBQ04sQ0FBQyxDQUFDLENBQUMsS0FBSyxDQUFDLFVBQVMsR0FBRztZQUNqQixPQUFPLENBQUMs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LENBQUNBLE1BQU1BLENBQUNBLENBQUNBLENBQUNBO1lBQ1RBLENBQUNBLENBQUNBLEdBQUdBLENBQUNBLElBQUlBLENBQUNBLEdBQUdBLEVBQUVBLFVBQVNBLE1BQU1BO2dCQUMzQixFQUFFLENBQUMsQ0FBQyxNQUFNLENBQUMsTUFBTSxJQUFJLE1BQU0sQ0FBQyxDQUFDLENBQUM7b0JBQzFCLEdBQUcsR0FBRyxDQUFDLENBQUMsS0FBSyxDQUFDLE1BQU0sQ0FBQyxPQUFPLEVBQUUsSUFBSSxDQUFDLENBQUE7Z0JBQ3ZDLENBQUM7WUFDTCxDQUFDLENBQUNBLENBQUFBO1lBQ0ZBLE1BQU1BLENBQUNBLEdBQUdBLENBQUFBO1FBQ2RBLENBQUNBO1FBQUNBLElBQUlBLENBQUNBLENBQUNBO1lBQ0pBLEdBQUdBLEdBQUdBLEVBQUVBLENBQUNBO1lBRVRBLENBQUNBLENBQUNBLEdBQUdBLENBQUNBLElBQUlBLENBQUNBLEdBQUdBLEVBQUVBLFVBQVNBLE1BQU1BO2dCQUMzQixDQUFDLENBQUMsR0FBRyxDQUFDLE1BQU0sQ0FBQyxPQUFPLEVBQUUsVUFBUyxDQUFDO29CQUM1QixHQUFHLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQTtnQkFDbEIsQ0FBQyxDQUFDLENBQUE7WUFDTixDQUFDLENBQUNBLENBQUFBO1lBRUZBLE1BQU1BLENBQUNBLEdBQUdBLENBQUFBO1FBQ2RBLENBQUNBO0lBRUxBLENBQUNBOztJQUtMLGdCQUFDO0FBQUQsQ0FuS1EsQUFtS1AsR0FBQSxDQUFDIiwiZmlsZSI6Im1vZHVsZXMvbWFjaENsaWVudHMuanMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgKiBhcyBfIGZyb20gXCJsb2Rhc2hcIjtcbmltcG9ydCAqIGFzIFByb21pc2UgZnJvbSBcImJsdWViaXJkXCI7XG5sZXQgcnBqID0gcmVxdWlyZSgncmVxdWVzdC1wcm9taXNlLWpzb24nKTtcblxuZnVuY3Rpb24gbWNvbm5lY3Rpb24odXNlcjogc3RyaW5nLCBwYXNzd29yZDogc3RyaW5nLCBkYjogc3RyaW5nLCBzZXJpYWw6IHN0cmluZywgYm9vbD86IGJvb2xlYW4pIHtcbiAgICByZXR1cm4gbmV3IFByb21pc2UoZnVuY3Rpb24ocmVzb2x2ZSwgcmVqZWN0KSB7XG4gICAgICAgIHJwai5nZXQoZGIgKyAnL2Nvbm5lY3Rpb25fJyArIHNlcmlhbCkudGhlbihmdW5jdGlvbihkb2MpIHtcbiAgICAgICAgICAgIGRvYy5jb25uZWN0ZWQgPSBib29sO1xuICAgICAgICAgICAgZG9jLnVwZGF0ZWRBdCA9IG5ldyBEYXRlKCkuZ2V0VGltZSgpXG4gICAgICAgICAgICBycGoucHV0KGRiICsgJy9jb25uZWN0aW9uXycgKyBzZXJpYWwsIGRvYykudGhlbihmdW5jdGlvbihkKSB7XG4gICAgICAgICAgICAgICAgcmVzb2x2ZSh0cnVlKVxuICAgICAgICAgICAgfSkuY2F0Y2goZnVuY3Rpb24oZXJyKSB7XG4gICAgICAgICAgICAgICAgY29uc29sZS5sb2coZXJyKVxuICAgICAgICAgICAgICAgIHJlamVjdChlcnIpXG4gICAgICAgICAgICB9KVxuICAgICAgICB9KS5jYXRjaChmdW5jdGlvbihlcnIpIHtcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKGVycilcblxuICAgICAgICAgICAgaWYgKGJvb2wgPT0gdHJ1ZSAmJiBlcnIuc3RhdHVzQ29kZSA9PSA0MDQpIHsgIC8vIGlmIGRvY25vdCBleGl0IGUgYm9vbCB0cnVlIGJsYSBibGEgYmxhXG5cbiAgICAgICAgICAgICAgICBsZXQgZG9jID0ge1xuICAgICAgICAgICAgICAgICAgICBfaWQ6ICdjb25uZWN0aW9uXycgKyBzZXJpYWwsXG4gICAgICAgICAgICAgICAgICAgIGNvbm5lY3RlZDogdHJ1ZSxcbiAgICAgICAgICAgICAgICAgICAgdXBkYXRlZEF0OiBuZXcgRGF0ZSgpLmdldFRpbWUoKVxuICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgIHJwai5wb3N0KGRiLCBkb2MpLnRoZW4oZnVuY3Rpb24oZG9jKSB7XG4gICAgICAgICAgICAgICAgICAgIHJlc29sdmUodHJ1ZSk7XG4gICAgICAgICAgICAgICAgfSkuY2F0Y2goZnVuY3Rpb24oZXJyKSB7XG4gICAgICAgICAgICAgICAgICAgIHJlamVjdCh7IGVycm9yOiAnd3JvbmcgY3JlZGVudGlhbHMnIH0pXG4gICAgICAgICAgICAgICAgfSlcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgY29uc29sZS5sb2coZXJyKVxuICAgICAgICAgICAgICAgIHJlamVjdChlcnIpXG4gICAgICAgICAgICB9XG4gICAgICAgIH0pXG4gICAgfSk7XG59XG5cblxuZnVuY3Rpb24gcHVzaHRvZGIodXNlcjogc3RyaW5nLCBwYXNzd29yZDogc3RyaW5nLCBkYjogc3RyaW5nLCBzZXJpYWw6IHN0cmluZywgZG9jOiB7IF9pZDogc3RyaW5nLCBfcmV2Pzogc3RyaW5nIH0pIHtcbiAgICByZXR1cm4gbmV3IFByb21pc2UoZnVuY3Rpb24ocmVzb2x2ZSwgcmVqZWN0KSB7XG4gICAgICAgIHJwai5nZXQoZGIgKyAnLycgKyBkb2MuX2lkKS50aGVuKGZ1bmN0aW9uKGQpIHtcbiAgICAgICAgICAgIGRvYy5fcmV2ID0gZC5fcmV2XG4gICAgICAgICAgICBycGoucHV0KGRiICsgJy8nICsgZG9jLl9pZCwgZG9jKS50aGVuKGZ1bmN0aW9uKCkge1xuICAgICAgICAgICAgICAgIHJlc29sdmUoZG9jKVxuICAgICAgICAgICAgfSkuY2F0Y2goZnVuY3Rpb24oZXJyKSB7XG4gICAgICAgICAgICAgICAgcmVqZWN0KGVycilcbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9KS5jYXRjaChmdW5jdGlvbihlcnIpIHtcbiAgICAgICAgICAgIGlmIChlcnIuc3RhdHVzQ29kZSA9PSA0MDQpIHtcbiAgICAgICAgICAgICAgICBycGoucG9zdChkYiArICcvJywgZG9jKS50aGVuKGZ1bmN0aW9uKCkge1xuICAgICAgICAgICAgICAgICAgICByZXNvbHZlKGRvYylcbiAgICAgICAgICAgICAgICB9KS5jYXRjaChmdW5jdGlvbihlcnIpIHtcbiAgICAgICAgICAgICAgICAgICAgcmVqZWN0KGVycilcbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgY29uc29sZS5sb2coZXJyKVxuICAgICAgICAgICAgICAgIHJlamVjdChlcnIpXG4gICAgICAgICAgICB9XG4gICAgICAgIH0pO1xuICAgIH0pO1xuXG59XG5cbmZ1bmN0aW9uIGV4aXN0cyhhbGw6IElDbGllbnRbXSwgc2VyaWFsLCBzaWQpOiB7IHNlcmlhbDogYm9vbGVhbiwgc29ja2V0OiBib29sZWFuIH0ge1xuICAgIGxldCBzZXJpYWxleGlzdHMgPSBmYWxzZVxuICAgIGxldCBzb2NrZXRleGlzdHMgPSBmYWxzZVxuXG4gICAgXy5tYXAoYWxsLCBmdW5jdGlvbihjbGllbnQpIHtcbiAgICAgICAgaWYgKGNsaWVudC5zZXJpYWwpIHtcbiAgICAgICAgICAgIHNlcmlhbGV4aXN0cyA9IHRydWVcblxuICAgICAgICAgICAgXy5tYXAoY2xpZW50LnNvY2tldHMsIGZ1bmN0aW9uKHMpIHtcbiAgICAgICAgICAgICAgICBpZiAocy5pZCA9PSBzaWQpIHtcbiAgICAgICAgICAgICAgICAgICAgc29ja2V0ZXhpc3RzID0gdHJ1ZVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0pXG4gICAgICAgIH1cbiAgICB9KVxuICAgIHJldHVybiB7IHNlcmlhbDogc2VyaWFsZXhpc3RzLCBzb2NrZXQ6IHNvY2tldGV4aXN0cyB9XG59XG5cblxuaW50ZXJmYWNlIElTb2NrZXRBcnJheSB7XG5cbiAgICBpZDogc3RyaW5nO1xuICAgIHNvY2tldDogSVNvY2tldFxufVxuXG5pbnRlcmZhY2UgSVNvY2tldCB7XG4gICAgICAgICAgICAgICAgb246RnVuY3Rpb247XG4gICAgICAgIGlkOiBzdHJpbmc7XG4gICAgICAgIGVtaXQ6RnVuY3Rpb247XG4gICAgZGVjb2RlZF90b2tlbjp7XG4gICAgICAgIGRiOnN0cmluZztcbiAgICAgICAgdXNlcjpzdHJpbmc7XG4gICAgICAgIHBhc3N3b3JkOnN0cmluZztcbiAgICAgICAgc2VyaWFsOnN0cmluZztcbiAgICB9XG59XG5cbmludGVyZmFjZSBJQ2xpZW50IHtcbiAgICBzZXJpYWw6IHN0cmluZztcbiAgICBzb2NrZXRzOiBJU29ja2V0QXJyYXlbXTtcbiAgICB1c2VyOiBzdHJpbmc7XG4gICAgcGFzc3dvcmQ6IHN0cmluZztcbiAgICBkYjogc3RyaW5nO1xufVxuXG5cbmludGVyZmFjZSBJQ291Y2hkYiB7XG4gICAgcHJvdG9jb2w6IHN0cmluZztcbiAgICBwb3J0OiBudW1iZXI7XG4gICAgaG9zdDogc3RyaW5nO1xufVxuXG5cbmV4cG9ydCA9Y2xhc3MgTWFDbGllbnRzIHtcbiAgICBhbGw6IElDbGllbnRbXTtcbiAgICBjb3VjaGRiOiBJQ291Y2hkYjtcblxuICAgIGNvbnN0cnVjdG9yKGRiOiBJQ291Y2hkYikge1xuICAgICAgICB0aGlzLmNvdWNoZGIgPSBkYlxuICAgICAgICB0aGlzLmFsbD0gW107XG4gICAgfVxuXG4gICAgYWRkKHVzZXI6IHN0cmluZywgcGFzc3dvcmQ6IHN0cmluZywgZGI6IHN0cmluZywgc2VyaWFsOiBzdHJpbmcsIHNvY2tldDogSVNvY2tldCkge1xuXG4gICAgICAgIGxldCBleGlzdCA9IGV4aXN0cyh0aGlzLmFsbCwgc2VyaWFsLCBzb2NrZXQuaWQpXG4gICAgICAgIGlmICghZXhpc3Quc2VyaWFsKSB7XG5cbiAgICAgICAgICAgIHRoaXMuYWxsLnB1c2goe1xuICAgICAgICAgICAgICAgIHNlcmlhbDogc2VyaWFsLFxuICAgICAgICAgICAgICAgIHVzZXI6IHVzZXIsXG4gICAgICAgICAgICAgICAgcGFzc3dvcmQ6IHBhc3N3b3JkLFxuICAgICAgICAgICAgICAgIGRiOiB0aGlzLmNvdWNoZGIucHJvdG9jb2wgKyAnOi8vJyArIHVzZXIgKyAnOicgKyBwYXNzd29yZCArICdAJyArIHRoaXMuY291Y2hkYi5ob3N0ICsgJy8nICsgZGIsXG4gICAgICAgICAgICAgICAgc29ja2V0czogW3sgaWQ6IHNvY2tldC5pZCwgc29ja2V0OiBzb2NrZXQgfV1cbiAgICAgICAgICAgIH0pXG5cbiAgICAgICAgICAgIHJldHVybiBtY29ubmVjdGlvbih1c2VyLCBwYXNzd29yZCwgdGhpcy5jb3VjaGRiLnByb3RvY29sICsgJzovLycgKyB1c2VyICsgJzonICsgcGFzc3dvcmQgKyAnQCcgKyB0aGlzLmNvdWNoZGIuaG9zdCArICcvJyArIGRiLCBzZXJpYWwsIHRydWUpXG5cbiAgICAgICAgfSBlbHNlIGlmICghZXhpc3Quc29ja2V0KSB7XG4gICAgICAgICAgICBfLm1hcCh0aGlzLmFsbCwgZnVuY3Rpb24oY2xpZW50KSB7XG4gICAgICAgICAgICAgICAgaWYgKGNsaWVudC5zZXJpYWwpIHtcbiAgICAgICAgICAgICAgICAgICAgY2xpZW50LnNvY2tldHMucHVzaCh7IGlkOiBzb2NrZXQuaWQsIHNvY2tldDogc29ja2V0IH0pXG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSlcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKCduZXcgc29ja2V0IGZvciAnICsgc2VyaWFsKVxuICAgICAgICB9XG5cblxuICAgIH07XG4gICAgcHVzaGRhdGEoc2VyaWFsOnN0cmluZyx0eXBlOnN0cmluZyxkYXRhOmFueSkge1xuICAgIFxuICAgIHJldHVybiBuZXcgUHJvbWlzZShmdW5jdGlvbihyZXNvbHZlLCByZWplY3QpIHtcbiAgICAgICAgXG4gICAgICAgIHJlamVjdCgndG9kbycpXG4gICAgICAgIFxuICAgICAgICAgICAgICAgICAgIH0pIFxuICAgICAgICBcbiAgICAgICAgXG59O1xuICAgIHJlbW92ZShzZXJpYWw6IHN0cmluZywgc2lkOiBzdHJpbmcpIHtcblxuICAgICAgICBsZXQgcmVtYW5pbmc6IElDbGllbnRbXT1bXTtcblxuICAgICAgICBmb3IgKGxldCBzb2MgPSAwOyBzb2MgPCB0aGlzLmFsbC5sZW5ndGg7IHNvYysrKSB7XG5cbiAgICAgICAgICAgIHZhciBjbGllbnQgPSB0aGlzLmFsbFtzb2NdO1xuXG5cblxuICAgICAgICAgICAgaWYgKGNsaWVudC5zZXJpYWwgPT0gc2VyaWFsKSB7XG5cbiAgICAgICAgICAgICAgICBpZiAoY2xpZW50LnNvY2tldHMubGVuZ3RoID09IDEgJiYgY2xpZW50LnNvY2tldHNbMF0uaWQgPT0gc2lkKSB7XG4gICAgICAgICAgICAgICAgICAgIG1jb25uZWN0aW9uKGNsaWVudC51c2VyLCBjbGllbnQucGFzc3dvcmQsIGNsaWVudC5kYiwgY2xpZW50LnNlcmlhbCwgZmFsc2UpLnRoZW4oZnVuY3Rpb24oKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZygnc3dpdGNoZWQgb2ZmbGluZScpXG4gICAgICAgICAgICAgICAgICAgIH0pLmNhdGNoKGZ1bmN0aW9uKGVycikge1xuICAgICAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coJ3N3aXRjaGVkIG9mZmxpbmUgZXJyb3InKVxuICAgICAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coZXJyKVxuICAgICAgICAgICAgICAgICAgICB9KVxuXG4gICAgICAgICAgICAgICAgICAgIF8ubWFwKHRoaXMuYWxsLCBmdW5jdGlvbihlbCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGVsLnNlcmlhbCAhPSBjbGllbnQuc2VyaWFsKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVtYW5pbmcucHVzaChlbClcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgICAgICB9KVxuICAgICAgICAgICAgICAgICAgICB0aGlzLmFsbCA9IHJlbWFuaW5nO1xuXG5cblxuICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKCd0b2RvJylcbiAgICAgICAgICAgICAgICAgICAgLy8gdGhpcy5hbGw9Xy5yZWplY3QodGhpcy5hbGwsIGZ1bmN0aW9uKGVsKSB7XG4gICAgICAgICAgICAgICAgICAgIC8vICAgcmV0dXJuIGVsLnNlcmlhbCA9PT0gY2xpZW50LnNlcmlhbDtcbiAgICAgICAgICAgICAgICAgICAgLy8gfSlcblxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgIH07XG5cbiAgICBsaXN0KHNlcmlhbD86IHN0cmluZyk6IHN0cmluZ1tdIHtcbiAgICAgICAgbGV0IHNlcmlhbHM6IHN0cmluZ1tdPVtdO1xuICAgICAgICBpZiAoc2VyaWFsKSB7XG5cbiAgICAgICAgICAgIF8ubWFwKHRoaXMuYWxsLCBmdW5jdGlvbihjbGllbnQpIHtcbiAgICAgICAgICAgICAgICBpZiAoY2xpZW50LnNlcmlhbCA9PSBzZXJpYWwpIHtcbiAgICAgICAgICAgICAgICAgICAgc2VyaWFscy5wdXNoKGNsaWVudC5zZXJpYWwpXG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSlcblxuICAgICAgICB9IGVsc2Uge1xuXG4gICAgICAgICAgICBfLm1hcCh0aGlzLmFsbCwgZnVuY3Rpb24oY2xpZW50KSB7XG4gICAgICAgICAgICAgICAgc2VyaWFscy5wdXNoKGNsaWVudC5zZXJpYWwpXG4gICAgICAgICAgICB9KVxuXG5cbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiBzZXJpYWxzXG5cbiAgICB9O1xuICAgIGlvcyhzZXJpYWw/OiBzdHJpbmcpOiBbSVNvY2tldF0ge1xuICAgICAgICBsZXQgc29ja2V0czogW0lTb2NrZXRdO1xuXG4gICAgICAgIGlmIChzZXJpYWwpIHtcbiAgICAgICAgICAgIF8ubWFwKHRoaXMuYWxsLCBmdW5jdGlvbihjbGllbnQpIHtcbiAgICAgICAgICAgICAgICBpZiAoY2xpZW50LnNlcmlhbCA9PSBzZXJpYWwpIHtcblxuICAgICAgICAgICAgICAgICAgICBfLm1hcChjbGllbnQuc29ja2V0cywgZnVuY3Rpb24ocykge1xuICAgICAgICAgICAgICAgICAgICAgICAgc29ja2V0cy5wdXNoKHMuc29ja2V0KVxuICAgICAgICAgICAgICAgICAgICB9KVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0pXG5cbiAgICAgICAgfSBlbHNlIHtcblxuXG4gICAgICAgICAgICBfLm1hcCh0aGlzLmFsbCwgZnVuY3Rpb24oY2xpZW50KSB7XG4gICAgICAgICAgICAgICAgXy5tYXAoY2xpZW50LnNvY2tldHMsIGZ1bmN0aW9uKHMpIHtcblxuICAgICAgICAgICAgICAgICAgICBzb2NrZXRzLnB1c2gocy5zb2NrZXQpXG5cblxuICAgICAgICAgICAgICAgIH0pXG4gICAgICAgICAgICB9KVxuXG5cbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gc29ja2V0c1xuICAgIH07XG4gICAgc29ja2V0cyhzZXJpYWw/OiBzdHJpbmcpIHtcbiAgICAgICAgbGV0IGlkcztcbiAgICAgICAgaWYgKHNlcmlhbCkge1xuICAgICAgICAgICAgXy5tYXAodGhpcy5hbGwsIGZ1bmN0aW9uKGNsaWVudCkge1xuICAgICAgICAgICAgICAgIGlmIChjbGllbnQuc2VyaWFsID09IHNlcmlhbCkge1xuICAgICAgICAgICAgICAgICAgICBpZHMgPSBfLnBsdWNrKGNsaWVudC5zb2NrZXRzLCBcImlkXCIpXG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSlcbiAgICAgICAgICAgIHJldHVybiBpZHNcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIGlkcyA9IFtdO1xuXG4gICAgICAgICAgICBfLm1hcCh0aGlzLmFsbCwgZnVuY3Rpb24oY2xpZW50KSB7XG4gICAgICAgICAgICAgICAgXy5tYXAoY2xpZW50LnNvY2tldHMsIGZ1bmN0aW9uKHMpIHtcbiAgICAgICAgICAgICAgICAgICAgaWRzLnB1c2gocy5pZClcbiAgICAgICAgICAgICAgICB9KVxuICAgICAgICAgICAgfSlcblxuICAgICAgICAgICAgcmV0dXJuIGlkc1xuICAgICAgICB9XG5cbiAgICB9O1xuICAgIFxuICAgIFxuICAgIFxuICAgIFxufTtcbiJdLCJzb3VyY2VSb290IjoiL3NvdXJjZS8ifQ==
